<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../general.ent">
  %general-entities;
]>

<sect1 id="ch-system-readjusting">
  <?dbhtml filename="readjusting.html"?>

  <title>Ré-ajustez l'ensemble d'outils</title>

  <para>Maintenant que les bibliothèques C finales ont été
	installées, il est temps d'ajuster de nouveau l'ensemble d'outils. L'ensemble
	d'outils sera ajusté de façon à ce qu'il lie tout programme nouvellement
	compilé avec ces nouvelles bibliothèques. C'est le même processus que celui
	utilisé dans la phase d'<quote>ajustement</quote> au début du
	<xref linkend="chapter-temporary-tools"/>, avec les ajustements inversés. Dans
	<xref linkend="chapter-temporary-tools"/>, l'ensemble était passé des 
	répertoires <filename class="directory">/{,usr/}lib</filename> de l'hôte dans
	le nouveau répertoire <filename class="directory">/tools/lib</filename>.
	Maintenant, l'ensemble sera guidé du même répertoire
	<filename class="directory">/tools/lib</filename> vers les répertoires HLFS 
	<filename class="directory">/{,usr/}lib</filename>.</para>

  <para condition="uclibc">Redémarrez à nouveau
	<filename>config.site</filename>&nbsp;:</para>

<screen condition="uclibc"><userinput>cat > /usr/share/config.site &lt;&lt; "EOF"
host=$(uname -m)-pc-linux-uclibc
build=$host
target=$host
ac_cv_host=$host
ac_cv_build=$build
ac_cv_target=$target
EOF
export CONFIG_SITE=/usr/share/config.site</userinput></screen>

  <para>D'abord, sauvegardez l'éditeur de liens
	<filename class="directory">/tools</filename> et remplacez-le par l'éditeur
  de liens ajusté que nous avons fait au chapitre 5. Nous allons créer aussi
	un lien vers son équivalent dans <filename class="directory">/tools/$(gcc
  -dumpmachine)/bin</filename>.</para>

<screen><userinput>mv -v /tools/bin/{ld,ld-old}
mv -v /tools/$(gcc -dumpmachine)/bin/{ld,ld-old}
mv -v /tools/bin/{ld-new,ld}
ln -sv /tools/bin/ld /tools/$(gcc -dumpmachine)/bin/ld</userinput></screen>

  <para>Puis, modifiez le fichier de specs GCC afin qu'il pointe vers le nouvel 
  éditeur de liens dynamique et pour que GCC sache où trouver ses fichiers de 
	démarrage. Une commande <command>perl</command> accomplit cela&nbsp;:</para>

<screen><userinput>gcc -dumpspecs | perl -p -e 's@/tools/lib/@/lib/@g;' \
    -e 's@\*startfile_prefix_spec:\n@$_/usr/lib/ @g;' &gt; \
    `dirname $(gcc --print-libgcc-file-name)`/specs</userinput></screen>

  <para>C'est une bonne idée d'examiner visuellement le fichier de specs
	pour vérifier que le changement voulu a bien été effectué.</para>

  <para>Il est impératif à ce moment d'arrêter et de vous assurer que les
	fonctions basiques (compilation et édition des liens) de l'ensemble des
	outils ajusté fonctionnent comme attendu. Pour cela, réalisez une petite
	vérification&nbsp;:</para>

<screen><userinput>echo 'int main(){return 0;}' &gt; dummy.c
cc dummy.c -Wl,--verbose &amp;&gt; dummy.log
readelf -l a.out | grep ': /lib'</userinput></screen>

  <para>Si tout fonctionne correctement, il ne devrait pas y avoir d'erre
	la sortie de la commande sera (avec des différences spécifiques aux plateforme
	dans le nom de l'éditeur de liens)&nbsp;:</para>

<screen condition="glibc"><computeroutput>[Requesting program interpreter: /lib/ld-linux.so.2]</computeroutput></screen>

<screen condition="uclibc"><computeroutput>[Requesting program interpreter: /lib/ld-uClibc.so.0]</computeroutput></screen>

  <para>Notez que <filename class="directory">/lib</filename> est maintenant le
	préfixe de notre éditeur de liens.</para>

  <para>Maintenant, assurez-vous que nous utilisons les
	bons fichiers de démarrage&nbsp;:</para>

<screen><userinput>grep -o '/usr/lib.*/crt[1in].* .*' dummy.log</userinput></screen>

  <para>Si tout fonctionne correctement, il ne devrait pas y avoir d'erre
	et la sortie de la dernière commande sera&nbsp;:</para>

<screen><computeroutput>/usr/lib/crti.o succeeded
/usr/lib/crtn.o succeeded</computeroutput></screen>

  <para>Puis, vérifiez que le compilateur cherche les bons fichiers
	d'en-tête&nbsp;:</para>

<screen><userinput>grep 'SEARCH.*/usr/lib' dummy.log |sed 's|; |\n|g'</userinput></screen>

  <para>Si tous fonctionne correctement, il ne devrait pas y avoir d'erreurs et
  la sortie de la dernière commande sera&nbsp;:</para>

<screen><computeroutput>SEARCH_DIR("/tools/i686-pc-linux-gnu/lib")
SEARCH_DIR("/usr/lib")
SEARCH_DIR("/lib");</computeroutput></screen>

  <para>Ensuite, assurez-vous qu'on utilise lea bonne libc&nbsp;:</para>

<screen condition="glibc"><userinput>grep "/lib/libc.so.6 " dummy.log</userinput></screen>

<screen condition="uclibc"><userinput>grep "/lib/libc.so.0 " dummy.log</userinput></screen>

  <para>Si tout fonctionne correctement, il ne devrait pas y avoir d'erre
	et la sortie de la dernière commande sera&nbsp;:</para>

<screen condition="glibc"><computeroutput>attempt to open /lib/libc.so.6 succeeded</computeroutput></screen>

<screen condition="uclibc"><computeroutput>attempt to open /lib/libc.so.0 succeeded</computeroutput></screen>

  <para>Pour finir, assurez-vous que GCC utilise le bon éditeur de liens 
	dynamiques&nbsp;:</para>

<screen><userinput>grep found dummy.log</userinput></screen>

  <para>Si tout fonctionne correctement, il ne devrait pas y avoir d'erre
	la sortie de la commande sera (avec des différences spécifiques aux plateforme
	dans le nom de l'éditeur de liens)&nbsp;:</para>

<screen condition="glibc"><computeroutput>found ld-linux.so.2 at /lib/ld-linux.so.2</computeroutput></screen>

<screen condition="uclibc"><computeroutput>found ld-uClibc.so.0 at /lib/ld-uClibc.so.0</computeroutput></screen>

  <para>Si la sortie n'apparaît pas comme montré ci-dessus ou
	qu'elle n'apparaît pas du tout, alors quelque chose ne va vraiment pas.
	Investiguez et retracez les étapes pour savoir d'où vient le problème et comme
	corriger. La raison la plus probable est que quelque chose s'est mal passé lor
	de la modification du fichier specs ci-dessus. Tout problème devra être résolu
	avant de continuer le processus.</para>

  <para>Une fois que tout fonctionne correctement, nettoyez les fichiers
	tests&nbsp;:</para>

<screen><userinput>rm -v dummy.c a.out dummy.log</userinput></screen>

</sect1>
