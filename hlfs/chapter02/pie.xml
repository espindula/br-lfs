<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../general.ent">
  %general-entities;
]>

<sect1 id="ch-technotes-pie">
  <?dbhtml filename="pie.html"?>

  <title>Position des exécutables indépendants</title>

  <para><foreignphrase>Position-Independent-Executable</foreignphrase> est une
  fonction de Binutils, Libc, et GCC qui crée un exécutable qui ressemble à
  quelque chose entre une bibliothèque partagée et un exécutable normal. Les 
  programmes compilés avec ces capacités apparaissent comme <quote>objet
  partagé</quote> avec la commande <command>file</command>(1). Cela permet à
  l'exécutable de se comporter comme une bibliothèque partagée, du coup les
  adresses de base peuvent être réaffectables. Le programme PIE doit être lié
  à <filename>Scrt1.o</filename>.
  <filename>Scrt1.o</filename> est disponible à partir des versions récentes
	de Libc. De plus, ces programmes doivent être liés avec
  <parameter>-pie</parameter> à la commande
  <command>ld</command>(1) à partir de la version 2.15 de Binutils ou 
	supérieure. GCC supporte cela à la base avec le drapeau
  <parameter>-fPIE</parameter> dans sa version 3.4 ou supérieure.</para>

  <para>Quand tout le code objet est indépendant de sa position, le noyau
  peut ne plus autoriser le déplacement de texte
  (<foreignphrase>text relocation</foreignphrase>). Cela augmente
  considérablement la sécurité du système avec une faible baisse de 
	performance. Les noyaux PaX et Grsec proposent cette option 
  bien que très peu de systèmes sont capables d'en tirer parti. 
	L'ensemble du système de base peut être compilé en position indépendante
	sauf le chargeur de démarrage Grub et bes outils de Glibc du fait du code
  d'assemblage non-pic. Ces programmes fonctionneront encore s'ils sont
	liés de manière dynamique. Il existe d'autres exceptions&nbsp;: le système
	de gestion de fenêtres X11, Mplayer ainsi que quelques autres programmes
	graphiques qui n'ont pas été programmés avec l'idée de la PIE en tête, cela
  devrait changer avec le temps. Gzip utilise du code d'assembleur mais
  il peut être remplacé à la compilation par du code C.</para>

  <para>PaX peut aussi rendre aléatoire les adresses retournées par les programmes PIE avec
  <foreignphrase>Address Space Layout Randomization</foreignphrase> (ASLR
  ou rendu aléatoire du plan d'espace adresse). Cela peut éviter
  l'exploitation de bogues de sécurité par des pirates.</para>

  <para>Vous pouvez chercher les déplacements de texte dans les programmes avec
      la commande suivante&nbsp;:</para>

  <screen><userinput>readelf -d /path/to/object | grep TEXTREL</userinput></screen>

  <para>Il est possible que TEXTREL soit présent à la fois dans des exécutables
      et des bibliothèques. Des investigations avancées sont nécessaires pour
      trouver le code en particulier qui n'est pas en position indépendante, c'est
      le plus souvent du code assembleur. Si un programme renvoie des messages d'erreur
      contenant 'ASM' et 'BREG' à la compilation, cela indique de l'assembleur
      non pic.</para>

  <para>Le correctif uname coreutils de LFS utilise aussi du code d'assemblage
	qui n'est pas en position indépendante.</para>

  <para>La page de man de <command>ld</command> contient une description de
  <parameter>-pie</parameter>. Voir <command>man 1 ld</command>.</para>

  <para>Utilisez les options <option>NOELFRELOCS</option> dans PaX du noyau
	pour désactiver le déplacement de texte.</para>

  <para>Le drapeau <parameter>fPIE</parameter> ne peut être fourni que
	pour les exécutables, pas les bibliothèques. Le drapeau
	<parameter>fPIE</parameter> possède certains avantages sur
  <parameter>fPIC</parameter> dans la mesure où le compilateur peut supposer que
	le code restera interne au programme. En matière d'optimisation, ceci se
  traduit par un plus grand effet&nbsp;; les fonctions non statiques peuvent
	être placées inline au <parameter>-O3</parameter>, etc. Les specs
  hardened utilisés dans le livre ajoute des filtres à au spec
	<emphasis>link_command</emphasis> de GCC pour distinguer les exécutables des
  bibliothèques, donc le paramètre <parameter>-pie</parameter> de 
	<command>ld</command> n'est passé que lorsque les exécutables sont liés. Les
  mêmes filtres ne peuvent être utilisés pour <command>cc1</command>, donc la
	spec <command>cc1</command> fournit partout <parameter>-fPIC</parameter> 
	au lieu de <parameter>-fPIE</parameter> à moins que les drapeaux
	<parameter>-static</parameter> ou 
        <parameter>-no-pie</parameter> ne soient utilisés. L'utilisation de
  <command>gcc -fPIC</command> avec <command>ld -pie</command> fonctionne très
  bien, toutes les possibilités PaX/Grsec du noyau pourront en tirer parti.
	<parameter>fPIE</parameter> est connu pour entraîner un déplacement de 
	texte dans certains programmes, donc il doit être utilisé prudemment. 
	Dans ce livre, nous corrigeons certains programmes et nous utilisons les
	commandes <command>sed</command>(1) sur les autres, pour ajouter 
	<command>gcc -pie -fpie</command> sur les exécutables des programmes.
  <parameter>fPIE</parameter> doit être ajouté à petite dose et pas à la
	variable d'environnement. Les specs endurcies préserve le comportement
	<command>gcc -pie</command> originel, ce qui signifie que si vous utilisez
  <command>gcc -pie</command>, ni <parameter>-fpic</parameter> ni
	<parameter>-fpie</parameter> ne seront ajoutés automatiquement, donc 
	<parameter>-pie -fpie</parameter> doivent être utilisés conjointement (comme 
	pour la page de man de <command>gcc</command>). <command>gcc -pie</command> 
  change les fichiers de démarrage qui seront utilisés 
	(<filename>Scrt.o</filename>), donc il doit être utilisé avec 
	<command>ld -pie</command>. Presque tous les paquets
  utilisent GCC pour l'édition de liens, donc il n'est pratiquement jamais 
  nécessaire d'initialiser la variable d'environnement.</para>
	
  <para>Au-delà des paquets de ce livre, les specs endurcis fonctionneront
	parfaitement bien avec <parameter>-fPIC</parameter>. Si vous souhaitez 
  utiliser <parameter>-fPIE</parameter> pour avoir une meilleure optimisation,
	soyez sûr d'utiliser <command>readelf -d</command> pour tester TEXTREL. Si
  <parameter>-fPIE</parameter> est fourni à un objet dans une bibliothèque, 
	cela créera une section TEXTREL dans cette bibliothèque, et cela ne 
  fonctionnera pas correctement. Des bibliothèques, privées ou non, doivent être
	compilées avec <parameter>-fPIC</parameter>.</para>

  <para>Sur les systèmes x86, <parameter>-fPIC</parameter> et 
	<parameter>-fpic</parameter> sont exactement les mêmes. Idem avec
	<parameter>-fPIE</parameter> et <parameter>-fpie</parameter>.</para>

  <para>Voir aussi&nbsp;:
    <itemizedlist>
      <listitem>
        <para><ulink url="http://pax.grsecurity.net/docs/index.html"/></para>
      </listitem>
      <listitem>
        <para><ulink
        url="http://netbsd.gw.com/cgi-bin/man-cgi?link+5+NetBSD-current"/></para>
      </listitem>
      <listitem>
        <para><ulink
        url="http://gcc.gnu.org/ml/gcc-patches/2003-06/msg00140.html"/></para>
      </listitem>
      <listitem>
        <para><ulink
        url="http://sources.redhat.com/ml/binutils/2003-05/msg00832.html"/></para>
      </listitem>
    </itemizedlist>
  </para>

</sect1>
