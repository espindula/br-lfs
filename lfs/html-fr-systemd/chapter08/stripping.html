<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      8.78.&nbsp;Nettoyage
    </title>
    <link rel="stylesheet" type="text/css" href="../stylesheets/lfs.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.78.1" />
    <link rel="stylesheet" href="../stylesheets/lfs-print.css" type=
    "text/css" media="print" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body class="lfs" id="lfs-r10.1-205-g49170-systemd+">
    <div class="navheader">
      <h4>
        Linux From Scratch - Version r10.1-205-g49170-systemd+
      </h4>
      <h3>
        Chapitre&nbsp;8.&nbsp;Installer les logiciels du système de base
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="aboutdebug.html" title=
          "À propos des symboles de débogage">Précédent</a>
          <p>
            À propos des symboles de débogage
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="revisedchroot.html" title=
          "Nettoyer">Suivant</a>
          <p>
            Nettoyer
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter08.html" title=
          "Chapitre&nbsp;8.&nbsp;Installer les logiciels du système de base">Niveau
          supérieur</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - Version r10.1-205-g49170-systemd+">Sommaire</a>
        </li>
      </ul>
    </div>
    <div class="sect1" lang="fr" xml:lang="fr">
      <h1 class="sect1">
        <a id="ch-system-stripping" name="ch-system-stripping"></a>8.78.
        Nettoyage
      </h1>
      <p>
        Cette section est facultative. Si l'utilisateur du système ne
        programme pas et ne prévoie pas de déboguer les logiciels du système,
        vous pouvez réduire la taille du système d'environ 2&nbsp;Go en
        supprimant les symboles de débogage des binaires et des
        bibliothèques. Cela ne pose aucun problème en dehors du fait de ne
        plus pouvoir déboguer les logiciels complètement.
      </p>
      <p>
        La plupart des gens utilisent les commandes mentionnées ci-dessous
        sans difficulté. Cependant, il est facile de faire une coquille et de
        rendre le nouveau système inutilisable, donc avant de lancer les
        commandes <span class="command"><strong>strip</strong></span>, il
        vaut mieux faire une sauvegarde du système LFS dans son état actuel.
      </p>
      <p>
        Les symboles de débogage pour les bibliothèques choisies sont placés
        dans des fichiers séparés. Ces informations de débogage sont requises
        si vous lancez des tests de régression qui utilisent <a class="ulink"
        href=
        "http://fr.linuxfromscratch.org/blfs/../view/blfs-svn//general/valgrind.html">
        valgrind</a> ou <a class="ulink" href=
        "http://fr.linuxfromscratch.org/blfs/../view/blfs-svn//general/gdb.html">
        gdb</a> plus tard dans BLFS.
      </p>
      <p>
        Remarquez que <span class="command"><strong>strip</strong></span>
        remplacera le binaire ou la bibliothèque qu'il traite. Cela peut
        faire crasher les processus qui utilisent du code ou des données de
        ce fichier. Si le processus lançant <span class=
        "command"><strong>strip</strong></span> lui-même est affecté, le
        binaire ou la bibliothèque en cours de nettoyage peut être détruit.
        Cela peut rendre le système complètement inutilisable. Pour éviter
        cela, nous copierons certains bibliothèques et binaires dans
        <code class="filename">/tmp</code>, les nettoierons là, et les
        installerons de nouveau avec la commande <span class=
        "command"><strong>install</strong></span>. Lisez les entrées liées
        dans le <a class="xref" href="pkgmgt.html#pkgmgmt-upgrade-issues"
        title="8.2.1.&nbsp;Problèmes de mise à jour">Section&nbsp;8.2.1,
        «&nbsp;Problèmes de mise à jour&nbsp;»</a> pour les raisons
        d'utiliser la commande <span class=
        "command"><strong>install</strong></span> ici.
      </p>
      <div class="admon note">
        <img alt="[Note]" src="../images/note.png" />
        <h3>
          Note
        </h3>
        <p>
          Le nom du chargeur ELF est ld-linux-x86-64.so.2 sur les systèmes 64
          bits et ld-linux.so.2 sur les systèmes 32 bits. La construction
          ci-dessous choisit le bon nom pour l'architecture actuelle.
        </p>
      </div>
      <pre class="userinput">

<kbd class="command">save_usrlib="$(cd /usr/lib; ls ld-linux*)
             libc.so.6
             libthread_db.so.1
             libquadmath.so.0.0.0 
             libstdc++.so.6.0.29
             libitm.so.1.0.0 
             libatomic.so.1.2.0" 

cd /usr/lib

for LIB in $save_usrlib; do
    objcopy --only-keep-debug $LIB $LIB.dbg
    cp $LIB /tmp/$LIB
    strip --strip-unneeded /tmp/$LIB
    objcopy --add-gnu-debuglink=$LIB.dbg /tmp/$LIB
    install -vm755 /tmp/$LIB /usr/lib
    rm /tmp/$LIB
done

online_usrbin="bash find strip"
online_usrlib="libbfd-2.37.so
               libhistory.so.8.1
               libncursesw.so.6.2
               libm.so.6
               libreadline.so.8.1
               libz.so.1.2.11
               $(cd /usr/lib; find libnss*.so* -type f)"

for BIN in $online_usrbin; do
    cp /usr/bin/$BIN /tmp/$BIN
    strip --strip-unneeded /tmp/$BIN
    install -vm755 /tmp/$BIN /usr/bin
    rm /tmp/$BIN
done

for LIB in $online_usrlib; do
    cp /usr/lib/$LIB /tmp/$LIB
    strip --strip-unneeded /tmp/$LIB
    install -vm755 /tmp/$LIB /usr/lib
    rm /tmp/$LIB
done

for i in $(find /usr/lib -type f -name \*.so* ! -name \*dbg) \
         $(find /usr/lib -type f -name \*.a)                 \
         $(find /usr/{bin,sbin,libexec} -type f); do
    case "$online_usrbin $online_usrlib $save_usrlib" in
        *$(basename $i)* ) 
            ;;
        * ) strip --strip-unneeded $i 
            ;;
    esac
done

unset BIN LIB save_usrlib online_usrbin online_usrlib
</kbd></pre>
      <p>
        La commande rapportera un grand nombre de fichiers comme ayant une
        extension non reconnue. Vous pouvez ignorer ces avertissements sans
        problème. Cela signifie que ces fichiers sont des scripts et non des
        binaires.
      </p>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="aboutdebug.html" title=
          "À propos des symboles de débogage">Précédent</a>
          <p>
            À propos des symboles de débogage
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="revisedchroot.html" title=
          "Nettoyer">Suivant</a>
          <p>
            Nettoyer
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="chapter08.html" title=
          "Chapitre&nbsp;8.&nbsp;Installer les logiciels du système de base">Niveau
          supérieur</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Linux From Scratch - Version r10.1-205-g49170-systemd+">Sommaire</a>
        </li>
      </ul>
    </div>
  </body>
</html>
