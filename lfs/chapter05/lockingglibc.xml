<sect1 id="ch05-locking-glibc">
<title>"Verrouiller" Glibc</title>
<?dbhtml filename="lockingglibc.html" dir="chapter05"?>

<para>Maintenant que les bibliothèques C temporaires ont été installées, nous
voulons que les outils compilés avec le reste de ce chapitre soient liés avec
ces bibliothèques. Pour accomplir ceci, nous avons besoin d'ajuster l'éditeur
de liens et le fichier specs du compilateur.</para>

<para>Tout d'abord, installez les scripts améliorés de l'éditeur de liens en
lançant ce qui suit à l'intérieur du répertoire <filename
class="directory">binutils-build</filename>:</para>

<para><screen><userinput>make -C ld install</userinput></screen></para>

<para>Ces scripts ont été améliorés un peu avant, à la fin de la première passe
de Binutils et ne contiennent aucune mention de <filename>/lib</filename>,
<filename>/usr/lib</filename> ou <filename>/usr/local/lib</filename>.
A partir de ça, tout va être lier <emphasis>seulement</emphasis> avec les
bibliothèques dans <filename>/tools/lib</filename>.</para>

<para>L'éditeur de liens a été ajusté un peu auparavant, à la fin de la première
passe de Binutils. A partir de maintenant, tout sera lié
<emphasis>uniquement</emphasis> avec les bibliothèques contenues dans
<filename>/tools/lib</filename>.</para>

<para>Maintenant que l'éditeur de liens ajusté est installé, vous pouvez
supprimer les répertoires des sources et de construction de Binutils.</para>

<para>L'autre chose à faire est de modifier le fichier specs de GCC de
façon à ce qu'ils pointent vers le nouvel éditeur de liens dynamiques. Une
simple commande sed accomplira ceci:</para>
   
<para><screen><userinput>SPECFILE=/tools/lib/gcc-lib/*/*/specs
sed -e 's@/lib/ld.so.1@/tools/lib/ld.so.1@g' \
&nbsp;&nbsp;&nbsp;&nbsp;-e 's@/lib/ld-linux.so.2@/tools/lib/ld-linux.so.2@g' \
&nbsp;&nbsp;&nbsp;&nbsp;$SPECFILE > tempspecfile
mv tempspecfile $SPECFILE
unset SPECFILE</userinput></screen></para>

<para>Nous recommendons de copier/coller les commandes ci-dessus plutôt que
vous tentiez de taper tout ce qui s'y trouve. Ou vous pouvez éditer le fichier
specs à la main si vous le voulez: remplacez "/lib/ld-linux.so.2" par
"/tools/lib/ld-linux.so.2" et "/lib/ld.so.1" avec "/tools/lib/ld.so.1".</para>

<para>Dernièrement, il existe une possibilité que certains fichiers include de
l'hôte système se trouvent dans le répertoire include privé de GCC. Ceci peut
se produire parce que la procédure fixincludes de GCC est lancée en tant que partie
la construction GCC. Nous expliquerons un peu mieux ceci dans ce chapitre. Pour
l'instant, lancez les commandes suivantes pour éliminer cette possibilité.</para>

<para><screen><userinput>rm -f /tools/lib/gcc-lib/*/*/include/{pthread.h,bits/sigthread.h}</userinput></screen></para>

<caution><para>Il est impératif à ce moment de s'arrêter pour s'assurer que les
fonctions de base (compilation et édition de liens) du nouvel ensemble des outils
fonctionneront comme on s'y attend. Pour cela, nous allons effectuer une vérification
simple:</para>

<para><screen><userinput>echo 'main(){}' > dummy.c
gcc dummy.c
readelf -l a.out | grep ': /tools'</userinput></screen></para>

<para>Si tout fonctionne correctement, la sortie de la dernière commande devrait
être:</para>

<para><screen>[Requesting program interpreter: /tools/lib/ld-linux.so.2]
</screen></para>

<para>Si vous n'obtenez pas une sortie comme celle montrée ci-dessus, alors
quelque chose va très mal. Vous devrez enquêter là-dessus et reprendre chaque
étape pour trouver où est situé le problème et le corriger. Il ne sert à rien de
continuer jusqu'à ce que ce soit corrigé. Il est probable que quelque chose
s'est mal passé avec le fichier specs ci-dessus. Notez particulièrement que
<filename>/tools/lib</filename> apparaît comme le préfixe de notre éditeur de
liens dynamiques. Bien sûr, si vous travaillez sur une plateforme où le nom de
l'éditeur de liens est quelque chose d'autre que
<filename>ld-linux.so.2</filename>, alors la sortie sera un peu différente.
</para>

<para>Once you are satisfied that all is well, clean up the test files:</para>

<para><screen><userinput>rm dummy.c a.out</userinput></screen></para>
</caution>

<para>Ceci complète l'installation de l'ensemble d'outils qui pourra maintenant
être utilisé pour construire le reste des outils temporaires.</para>

</sect1>

