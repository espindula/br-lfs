<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN" "http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../general.ent">
  %general-entities;
]>
<sect1 id="ch-tools-adjusting">
<title>Ajuster l'atelier des outils</title>
<?dbhtml filename="adjusting.html"?>

<para>Maintenant que les bibliothèques C temporaires ont été installées, nous
voulons que tous les outils compilés dans le reste de ce chapitre soient liés
avec ces bibliothèques. Pour accomplir cela, nous avons besoin d'ajuster
l'éditeur de liens et le fichier specs du compilateur. Certaines personnes
diront que cela ressemble à de la <emphasis><quote>magie
noire</quote></emphasis>, mais c'est vraiment très simple.</para>

<para>Tout d'abord, installez l'éditeur de liens ajusté (à la fin de la
première passe de Binutils) en lançant la commande suivante à partir du
répertoire <filename class="directory">binutils-build</filename>&nbsp;:</para>

<screen><userinput>make -C ld install</userinput></screen>

<para>À partir de ce moment, tout sera lié
<emphasis>uniquement</emphasis> avec les bibliothèques comprises dans
<filename>/tools/lib</filename>.</para>

<note><para>Si vous avez manqué l'avertissement précédent de différencier les
répertoires source et de convertion de Binutils à partir de la première passe
ou que vous l'avez supprimé accidentellement ou encore si vous n'y avez plus
accès, ne vous inquiétez pas, tout n'est pas perdu. Ignorez simplement la
commande ci-dessus. Le résultat en est une petite chance de programmes de tests
toujours liés avec les bibliothèques de l'hôte. Ce n'est pas idéal mais ce
n'est pas un problème majeur. La situation est corrigée à l'installation de la
deuxième passe de Binutils un peu plus tard.</para></note>

<para>Maintenant que l'éditeur de liens ajusté est installé, vous devez
<emphasis>supprimer</emphasis> les répertoires source et de construction
de Binutils.</para>

<para>La prochaine chose à faire est de modifier le fichier specs de GCC pour
qu'il pointe vers le nouvel éditeur de liens. Une simple commande sed devrait y
parvenir&nbsp;:</para>

<!-- Ampersands are needed to allow cut and paste -->

<screen><userinput>SPECFILE=/tools/lib/gcc-lib/*/*/specs &amp;&amp;
sed -e 's@ /lib/ld-linux.so.2@ /tools/lib/ld-linux.so.2@g' \
    $SPECFILE &gt; tempspecfile &amp;&amp;
mv -f tempspecfile $SPECFILE &amp;&amp;
unset SPECFILE</userinput></screen>

<para>Nous recommandons que vous copiez/collez les commandes ci-dessus
plutôt que d'essayer de les taper entièrement. Ou vous pouvez éditer le fichier
specs manuellement si vous le voulez&nbsp;: remplacement seulement les
occurences de <quote>/lib/ld-linux.so.2</quote> avec
<quote>/tools/lib/ld-linux.so.2</quote>. Assurez-vous d'inspecter visuellement
le fichier specs pour vérifier que la modification attendue a été réellement
réalisée.</para>

<important><para>Si vous travaillez sur une platforme où le nom de l'éditeur de
liens est quelque chose d'autre que <filename>ld-linux.so.2</filename>, vous
<emphasis>devez</emphasis> remplacer <filename>ld-linux.so.2</filename> avec le
nom de l'éditeur de liens de votre plateforme dans les commandes ci-dessus.
Référez-vous à <xref linkend="ch-tools-toolchaintechnotes"/> si
nécessaire.</para></important>

<para>Enfin, il existe un risque que certains fichiers include du système hôte
aient trouvé leur chemin vers le répertoire include privé de GCC. Ceci peut 
arriver à cause du processus <quote>fixincludes</quote> de GCC fonctionnant en
tant que partie de la construction GCC. Nous allons expliquer un peu plus ceci
dans ce chapitre. Pour l'instant, lancez les commandes suivantes pour éliminer
cette possibilité&nbsp;:</para>

<screen><userinput>rm -f /tools/lib/gcc-lib/*/*/include/{pthread.h,bits/sigthread.h}</userinput></screen>


<caution><para>Il est impératif à ce moment de s'arrêter et de s'assurer que les
fonctions basiques (compilation et édition des liens) du nouvel atelier
d'outils fonctionnent comme on s'y attend. Pour cela, nous allons
lancer une vérification de santé&nbsp;:</para>

<screen><userinput>echo 'main(){}' &gt; dummy.c
cc dummy.c
readelf -l a.out | grep ': /tools'</userinput></screen>

<para>Si tout fonctionne correctement, il ne devrait pas y avoir d'erreurs et
la sortie de la dernière commande sera (dépendant des différences spécifiques
aux plateformes sur le nom de l'éditeur de liens)&nbsp;:</para>

<blockquote><screen>[Requesting program interpreter: /tools/lib/ld-linux.so.2]</screen></blockquote>

<para>Notez spécialement que <filename class="directory">/tools/lib</filename>
apparaît comme préfixe de notre chargeur dynamique.</para>

<para>Si vous n'avez pas obtenu la sortie montrée ci-dessus ou si vous n'avez
reçu aucune sortie, alors quelque chose ne se passe pas bien. Vous allez avoir
besoin d'investiguer et de retracer vos étapes pour trouver où se cache le
problème et comment le corriger. Il n'y a aucune raison pour continuer tant que
ceci n'est pas fait. Tout d'abord, relancez la vérification en utilisant
<command>gcc</command> au lieu de <command>cc</command>. Si cela fonctionne,
cela signifie que le lien symbolique <filename
class="symlink">/tools/bin/cc</filename> est manquant. Revisitez <xref
linkend="ch-tools-gcc-pass1"/> et corrigez le lien symbolique. Ensuite,
assurez-vous que votre PATH est correct. Vous pouvez vérifier ceci en lançant
<userinput>echo $PATH</userinput> et en vérifiant que <filename
class="directory">/tools/bin</filename> est en tête de la liste. Si le PATH est
mauvais, cela pourrait signifier que vous n'êtes pas connecté en tant
qu'utilisateur <emphasis>lfs</emphasis> ou que quelque chose s'est mal passé
dans <xref linkend="ch-tools-settingenviron"/>. Enfin, quelque chose de mal a
pu se passer avec la correction du fichier specs ci-dessus. Dans ce cas,
refaites la modification de ce fichier en vous assurant de copier/coller les
lignes comme cela était recommandé.</para>

<para>Une fois satisfait, nettoyez les fichiers de test&nbsp;:</para>

<screen><userinput>rm dummy.c a.out</userinput></screen>
</caution>


</sect1>
