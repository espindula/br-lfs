<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../general.ent">
  %general-entities;
]>

<sect1 id="ch-tools-stripping">
  <?dbhtml filename="stripping.html"?>

  <title>Nettoyage et sauvegarde du système temporaire</title>
  
  <para>Les fichiers .la de libtool ne sont utiles que pour lier des bibliothèques
statiques. Ils ne sont pas requis, et potentiellement dangereux, quand on
utilise des bibliothèques dynamiques, surtout pour les systèmes de
construction qui n'utilisent pas les autotools. Toujours dans le chroot,
supprimez ces fichiers maintenant&nbsp;:</para>

<screen><userinput>find /usr/{lib,libexec} -name \*.la -delete</userinput></screen>

    <para>Supprimez la documentation des outils temporaires, pour éviter qu'elle ne se
retrouve sur le système final, et sauvez environ 35&nbsp;:Mo&nbsp;:</para>

<screen><userinput>rm -rf /usr/share/{info,man,doc}/*</userinput></screen>

  <note><para>
    Toutes les étapes restantes dans cette section sont optionnelles. Cependant,
dès que vous commencez à installer des paquets dans <xref
linkend="chapter-building-system"/>, les outils temporaires seront
écrasés. Donc il peut être une bonne idée d'effectuer une sauvegarde des
outils temporaires comme décrit plus bas. Les autres étapes ne sont requise
que si vous avez vraiment très peu d'espace disque.
  </para></note>

  <para>
    Les étapes suivantes sont effectuées depuis l'extérieur de l'environnement
chroot. Cela signifie que vous devez quitter l'environnement chroot avant de
continuer. La raison pour cela est que&nbsp;:
    <itemizedlist>
      <listitem>
        <para>
          cela s'assure que les objets ne sont pas utilisés pendant leur manipulation,
        </para>
      </listitem>
      <listitem>
        <para>
          cela permet d'accéder aux emplacements du système de fichiersr en dehors de
l'environnement chroot pour stocker/lire l'archive de sauvegarde qui ne doit
pas être placée dans la hiérarchie <filename
class="directory">$LFS</filename> pour des raisons de sécurité.
        </para>
      </listitem>
    </itemizedlist>
  </para>

  <para>
     Now, if you are stripping installed files or making a backup, leave the
chroot environment:
  </para>

<screen role="nodump"><userinput>exit</userinput></screen>

  <important>
    <para>All of the following instructions are executed by <systemitem
class="username">root</systemitem>. Take extra care about the commands
you're going to run as mistakes here can modify your host system. Be aware
that the environment variables <envar>LFS</envar> and <envar>LFS_TGT</envar>
are set for user <systemitem class="username">lfs</systemitem> by default
but may <emphasis>not</emphasis> be set for <systemitem
class="username">root</systemitem>. Whenever commands are to be executed by
<systemitem class="username">root</systemitem>, make sure you have set
<envar>LFS</envar> and <envar>LFS_TGT</envar> accordingly.  This has been
discussed in <xref linkend='ch-partitioning-aboutlfs'/>.
    </para>
  </important>


  <sect2>
    <title>Stripping</title>

    <para>Si la partition LFS est plutôt petite, il est bon de savoir que des éléments
inutiles peuvent être enlevés. Les exécutables et les bibliothèques
construites jusqu'ici contiennent un peu plus de 90 Mo de symbole de
débogages inutiles.</para>

    <para>Débarrassez les binaires de leurs symboles de débogage&nbsp;:</para>

    <screen role="nodump"><userinput>cd $LFS/tools/$LFS_TGT
bin/strip --strip-unneeded $LFS/usr/lib/*
bin/strip --strip-unneeded $LFS/usr/{,s}bin/*
bin/strip --strip-unneeded $LFS/tools/bin/*</userinput></screen>

    <para>Ces commandes passeront un certain nombre de fichiers en rapportant qu'elles
n'ont pas pu reconnaître leur format de fichier. La plupart sont des scripts
au lieu de binaires.
    </para>

    <para>Maintenant, vous devriez avoir au moins 5 Go d'espace libre sur la partition
chroot qui peut être utilisé pour construire et installer Glibc et GCC dans
la prochaine phase. Si vous pouvez construire et installer Glibc, vous
pouvez construire et installer le reste aussi. Vous pouvez vérifier l'espace
libre avec la commande <command>df -h $LFS</command>.</para>

  </sect2>

  <sect2>
    <title>Backup</title>

    <para>
      Maintenant que les outils essentiels ont été créés, il est temps de
réfléchir à faire une sauvegarde. Lorsque tous les tests passent
correctement dasn les paquets construits précédemment, vos outils
temporaires sont dans un bon état et peuvent être sauvegardés pour être
utilisés plus tard. Si vous avez une erreur fatale dans le chapitres
suivants, cela permet de tout supprimer et de recommencer (en étant plus
prudent). Malheureusement, tous les outils temporaires seront
supprimés. Pour éviter de passer du temps à refaire quelque chose qui a déjà
été construit, préparez une sauvegarde.
    </para>

    <para>
      Assurez-vous d'avoir au moins 600 Mo d'espace libre (les archives de sources
seront incluses dans l'archive de sauvegarde) dans le répertoire personnel
de l'utilisateur <systemitem class="username">root</systemitem>.
    </para>

    <para>Before we make a backup, unmount the virtual file systems:</para>

<screen role="nodump"><userinput>umount $LFS/dev{/pts,}
umount $LFS/{sys,proc,run}</userinput></screen>

    <para>
      Créez l'archive de sauvegarde en lançant la commande suivante&nbsp;:
    </para>

<screen role="nodump" revision="sysv"><userinput>cd $LFS 
tar -cJpf $HOME/lfs-temp-tools-&version;.tar.xz .</userinput></screen>

<screen role="nodump" revision="systemd"><userinput>cd $LFS 
tar -cJpf $HOME/lfs-temp-tools-&versiond;.tar.xz .</userinput></screen>

    <para>
      Remplacez <envar>$HOME</envar> par un répertoire de votre choix si vous ne
voulez pas avoir la sauvegarde dans le répertoire personnel de <systemitem
class="username">root</systemitem>.
    </para>
  </sect2>

  <sect2>
    <title>Restore</title>

    <para>
      Au cas où vous fassiez une erreur et deviez recommencer de zéro, vous pouvez
utiliser cette archive pour restaurer les outils temporaires et gagner du
temps lors de la correction. Comme les sources se trouvent dans <filename
class="directory">$LFS</filename>, elles sont incluses dans l'archive de
sauvegarde aussi, donc elles n'ont pas besoin d'être re-téléchargées. Après
avoir vérifié que <envar>$LFS</envar> est correctement initialisée,
restaurez la sauvegarde en exécutant les commandes suivantes:&nbsp;:
    </para>



    <!-- Make the following look different so users don't blindly run the
     restore when they don't need to. -->
<warning><para>The following commands are extremly dangerous.  If you run <command>rm -rf
./*</command> as the root user and you do not change to the $LFS directory
or the <envar>LFS</envar> environment variable is not set for the root user,
it will destroy your entire host system.  YOU ARE WARNED.</para></warning>

<screen role="nodump" revision="sysv"><computeroutput>cd $LFS 
rm -rf ./* 
tar -xpf $HOME/lfs-temp-tools-&version;.tar.xz</computeroutput></screen>

<screen role="nodump" revision="systemd"><computeroutput>cd $LFS 
rm -rf ./* 
tar -xpf $HOME/lfs-temp-tools-&versiond;.tar.xz</computeroutput></screen>

    <para>
      De nouveau, vérifiez que l'environnement en correctement paramétré et
continuez à construire le reste du système.
    </para>

    <important>
      <para>
        If you left the chroot environment to create a backup or restart building
using a restore, remember to check that the virtual filesystems are still
mounted (<command>findmnt | grep $LFS</command>).  If they are not mounted,
remount them now as described in <xref linkend='ch-tools-kernfs'/> and
re-enter the chroot environment (see <xref linkend='ch-tools-chroot'/>)
before continuing.
      </para>
    </important>
    
  </sect2>

</sect1>
