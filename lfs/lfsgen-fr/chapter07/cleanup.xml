<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../general.ent">
  %general-entities;
]>

<sect1 id="ch-tools-cleanup">
  <?dbhtml filename="cleanup.html"?>

  <title>Nettoyage et Sauvegarde du système temporaire</title>
  
  <sect2>
    <title>Nettoyage</title>

    <para>Tout d'abord, supprimez la documentation actuellement installée pour éviter
qu'elle ne se retrouve sur le système final, et pour récupérer environ
35&nbsp;Mo&nbsp;:</para>

<screen><userinput>rm -rf /usr/share/{info,man,doc}/*</userinput></screen>

    <para>Ensuite, les fichiers .la de libtool ne sont utiles que pour se lier à des
bibliothèques statiques. Ils ne sont pas utiles voir potentiellement
dangereux quand on utilise des bibliothèques partagées, surtout pour les
systèmes de construction qui ne sont pas basés sur les autotools. Toujours
dans le chroot, supprimez ces fichiers maintenant&nbsp;:</para>

<screen><userinput>find /usr/{lib,libexec} -name \*.la -delete</userinput></screen>

    <para>
      La taille du système est maintenant d'environ 3&nbsp;Go, mais le répertoire
/tools n'est plus requis. Il utilise environ 1&nbsp;Go d'espace
disque. Supprimez-le maintenant&nbsp;:
    </para>

<screen><userinput>rm -rf /tools</userinput></screen>
  </sect2>

  <sect2>
    <title>Sauvegarde</title>

    <note><para>
      Toutes les étapes restantes dans cette section sont facultatives. Cependant,
dès que vous commencez à installer des paquets dans le <xref
linkend="chapter-building-system"/>, les fichiers temporaires seront
remplacés. Donc c'est peut-être une bonne idée d'effectuer une sauvegarde du
système actuel, comme on le décrit plus bas. 
    </para></note>
  
    <para>
      Les étapes suivantes sont à effectuer en dehors de l'environnement
chroot. Cela signifie que vous devez quitter l'environnement chroot avant de
continuer. La raison est est qu'il faut pouvoir accéder à des emplacement du
système de fichiers en dehors de l'environnement chroot pour stocker et lire
l'archive de sauvegarde, qui ne devrait pas se trouver dans la hiérarchie
<filename class="directory">$LFS</filename> pour plus de sûreté.
    </para>

    <important>
      <para>Toutes les instructions suivantes sont exécutées en <systemitem
class="username">root</systemitem>. Faites particulièrement attention aux
commandes que vous allez exécuter car toute erreur ici peut modifier votre
système hôte. Soyez conscient que la variable d'environnement
<envar>LFS</envar> a une valeur pour l'utilisateur <systemitem
class="username">lfs</systemitem> par défaut, mais peut ne
<emphasis>pas</emphasis> exister pour <systemitem
class="username">root</systemitem>. Quand les commandes doivent être
exécutées par <systemitem class="username">root</systemitem>, assurez-vous
d'avoir la variable <envar>LFS</envar>. On en a déjà parlé dans le <xref
linkend='ch-partitioning-aboutlfs'/>.
      </para>
    </important>

    <para>
       Maintenant, si vous effectuez une sauvegarde, quittez l'environnement
chroot&nbsp;:
    </para>

<screen role="nodump"><userinput>exit</userinput></screen>

    <para>
      À ce point, les programmes et bibliothèques essentiels ont été créés et
votre système actuel est en bon état. Votre système peut maintenant être
sauvegardé pour être réutilisé plus tard. Si vous rencontrez une erreur
fatale dans les chapitres suivants, il arrive souvent que tout supprimer et
recommencer (avec plus de prudence) soit la meilleure
option. Malheureusement, tous les fichiers temporaires seront aussi
supprimés. Pour éviter de passer du temps en plus pour refaire quelque chose
que vous avez déjà réussi, préparez une sauvegarde.
    </para>

    <para>
      Assurez-vous d'avoir au moins 1&nbsp;Go d'espace disque libre (les archives
des sources seront incluses dans l'archive de sauvegarde) dans le répertoire
personnel de l'utilisateur <systemitem class="username">root</systemitem>.
    </para>

    <para>Avant de faire la sauvegarde, démontez les systèmes de fichiers
virtuels&nbsp;:</para>

<screen role="nodump"><userinput>umount $LFS/dev{/pts,}
umount $LFS/{sys,proc,run}</userinput></screen>

    <para>
      Créez l'archive de sauvegarde en lançant la commande suivante&nbsp;:
    </para>

    <note>
       <para>
          Comme l'archive de sauvegarde est compressée, elle prend un temps
relativement long (plus de 10 minutes) même sur un système raisonnablement
rapide.
       </para>
       
       <para>
          Assurez-vous aussi que la variable d'environnement <envar>LFS</envar> existe
pour l'utilisateur root.
       </para>
    </note>

<screen role="nodump" revision="sysv"><userinput>cd $LFS 
tar -cJpf $HOME/lfs-temp-tools-&version;.tar.xz .</userinput></screen>

<screen role="nodump" revision="systemd"><userinput>cd $LFS 
tar -cJpf $HOME/lfs-temp-tools-&versiond;.tar.xz .</userinput></screen>

    <para>
      Remplacez <envar>$HOME</envar> par un répertoire de votre choix si vous ne
voulez pas stoker la sauvegarde dans le répertoire personnel de <systemitem
class="username">root</systemitem>.
    </para>
  </sect2>

  <sect2>
    <title>Restauration du système</title>

    <para>
      Dans le cas où vous avez fait des erreurs et que vous devez recommencer du
début, vous pouvez utiliser cette sauvegarde pour réinitialiser le système
et gagner du temps. Comme les sources se trouvent dans <filename
class="directory">$LFS</filename>, elles sont incluses dans l'archive de
sauvegarde, donc vous n'aurez pas besoin de les télécharger de
nouveau. Après avoir vérifié que <envar>$LFS</envar> est définie
correctement, restaurez la sauvegarde en exécutant les commandes
suivantes&nbsp;:
    </para>



    <!-- Make the following look different so users don't blindly run the
     restore when they don't need to. -->
<warning><para>Les commandes suivantes sont extrêmement dangereuses. Si vous lancez
<command>rm -rf ./*</command> en tant que root et que vous ne vous êtes pas
déplacés dans le répertoire $LFS ou que la variable d'environnement
<envar>LFS</envar> n'est pas définie pour l'utilisateur root, elle détruira
votre système hôte complet. ON VOUS AURA PRÉVENU.</para></warning>

<screen role="nodump" revision="sysv"><computeroutput>cd $LFS 
rm -rf ./* 
tar -xpf $HOME/lfs-temp-tools-&version;.tar.xz</computeroutput></screen>

<screen role="nodump" revision="systemd"><computeroutput>cd $LFS 
rm -rf ./* 
tar -xpf $HOME/lfs-temp-tools-&versiond;.tar.xz</computeroutput></screen>

    <para>
       De nouveau, vérifiez que l'environnement a été correctement paramétré et
continuez à construire le reste du système.
    </para>

    <important>
      <para>
         Si vous quittez l'environnement chroot pour créer une sauvegarde ou pour
recommencer à construire à partir d'une sauvegarde, rappelez-vous de
vérifier que les systèmes de fichiers virtuels sont toujours montés
(<command>findmnt | grep $LFS</command>). S'ils ne sont pas montés,
remontez-les maintenant comme décrit dans le <xref
linkend='ch-tools-kernfs'/> et entrez de nouveau dans l'environnement chroot
(voir le <xref linkend='ch-tools-chroot'/>) avant de continuer.
       </para>
    </important>
    
  </sect2>

</sect1>
