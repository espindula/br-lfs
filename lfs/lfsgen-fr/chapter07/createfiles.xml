<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../general.ent">
  %general-entities;
]>

<sect1 id="ch-tools-createfiles">
  <?dbhtml filename="createfiles.html"?>

  <title>Créer les fichiers et les liens symboliques essentiels</title>

  <indexterm zone="ch-tools-createfiles">
    <primary sortas="e-/etc/passwd">/etc/passwd</primary>
  </indexterm>

  <indexterm zone="ch-tools-createfiles">
    <primary sortas="e-/etc/group">/etc/group</primary>
  </indexterm>

  <indexterm zone="ch-tools-createfiles">
    <primary sortas="e-/run/utmp">/run/utmp</primary>
  </indexterm>

  <indexterm zone="ch-tools-createfiles">
    <primary sortas="e-/var/log/btmp">/var/log/btmp</primary>
  </indexterm>

  <indexterm zone="ch-tools-createfiles">
    <primary sortas="e-/var/log/lastlog">/var/log/lastlog</primary>
  </indexterm>

  <indexterm zone="ch-tools-createfiles">
    <primary sortas="e-/var/log/wtmp">/var/log/wtmp</primary>
  </indexterm>

  <para>Historiquement, Linux gère la liste des systèmes de fichiers montés dans le
fichier <filename>/etc/mtab</filename>. Les noyaux modernes gèrent cette
liste en interne via le système de fichiers <filename
class="directory">/proc</filename>.  Pour contenter les outils qui
s'attendent à la présence de <filename>/etc/mtab</filename>, créez le lien
symbolique suivant&nbsp;:</para>

<screen><userinput>ln -sv /proc/self/mounts /etc/mtab</userinput></screen>

  <para>Créez un fichier <filename>/etc/hosts</filename> de base qui sera utilisé
dans certaines suites de tests, et par l'un des fichiers de configuration de
Perl&nbsp;:</para>

<screen><userinput>cat &gt; /etc/hosts &lt;&lt; EOF
"127.0.0.1 localhost $(hostname)" 
::1        localhost
EOF</userinput></screen>

  <para>Afin que l'utilisateur <systemitem class="username">root</systemitem> puisse
s'identifier et que le nom <quote>root</quote> soit reconnu, il doit y avoir
des entrées cohérentes dans les fichiers <filename>/etc/passwd</filename> et
<filename>/etc/group</filename>.</para>

  <para>Créez le fichier <filename>/etc/passwd</filename> en lançant la commande
suivante&nbsp;:</para>

<screen revision="sysv"><userinput>cat &gt; /etc/passwd &lt;&lt; "EOF"
<literal>root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/dev/null:/bin/false
daemon:x:6:6:Daemon User:/dev/null:/bin/false
messagebus:x:18:18:D-Bus Message Daemon User:/run/dbus:/bin/false
uuidd:x:80:80:UUID Generation Daemon User:/dev/null:/bin/false
nobody:x:99:99:Unprivileged User:/dev/null:/bin/false</literal>
EOF</userinput></screen>

<screen revision="systemd"><userinput>cat &gt; /etc/passwd &lt;&lt; "EOF"
<literal>root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/dev/null:/bin/false
daemon:x:6:6:Daemon User:/dev/null:/bin/false
messagebus:x:18:18:D-Bus Message Daemon User:/run/dbus:/bin/false
systemd-bus-proxy:x:72:72:systemd Bus Proxy:/:/bin/false
systemd-journal-gateway:x:73:73:systemd Journal Gateway:/:/bin/false
systemd-journal-remote:x:74:74:systemd Journal Remote:/:/bin/false
systemd-journal-upload:x:75:75:systemd Journal Upload:/:/bin/false
systemd-network:x:76:76:systemd Network Management:/:/bin/false
systemd-resolve:x:77:77:systemd Resolver:/:/bin/false
systemd-timesync:x:78:78:systemd Time Synchronization:/:/bin/false
systemd-coredump:x:79:79:systemd Core Dumper:/:/bin/false
uuidd:x:80:80:UUID Generation Daemon User:/dev/null:/bin/false
systemd-oomd:x:81:81:systemd Out Of Memory Daemon:/:/bin/false
nobody:x:99:99:Unprivileged User:/dev/null:/bin/false</literal>
EOF</userinput></screen>

  <para>Le mot de passe réel pour <systemitem class="username">root</systemitem>
sera paramétré plus tard.</para>

  <para>Créez le fichier <filename>/etc/group</filename> en exécutant la commande
suivante&nbsp;:</para>

<screen revision="sysv"><userinput>cat &gt; /etc/group &lt;&lt; "EOF"
<literal>root:x:0:
bin:x:1:daemon
sys:x:2:
kmem:x:3:
tape:x:4:
tty:x:5:
daemon:x:6:
floppy:x:7:
disk:x:8:
lp:x:9:
dialout:x:10:
audio:x:11:
video:x:12:
utmp:x:13:
usb:x:14:
cdrom:x:15:
adm:x:16:
messagebus:x:18:
input:x:24:
mail:x:34:
kvm:x:61:
uuidd:x:80:
wheel:x:97:
nogroup:x:99:
users:x:999:</literal>
EOF</userinput></screen>

<screen revision="systemd"><userinput>cat &gt; /etc/group &lt;&lt; "EOF"
<literal>root:x:0:
bin:x:1:daemon
sys:x:2:
kmem:x:3:
tape:x:4:
tty:x:5:
daemon:x:6:
floppy:x:7:
disk:x:8:
lp:x:9:
dialout:x:10:
audio:x:11:
video:x:12:
utmp:x:13:
usb:x:14:
cdrom:x:15:
adm:x:16:
messagebus:x:18:
systemd-journal:x:23:
input:x:24:
mail:x:34:
kvm:x:61:
systemd-bus-proxy:x:72:
systemd-journal-gateway:x:73:
systemd-journal-remote:x:74:
systemd-journal-upload:x:75:
systemd-network:x:76:
systemd-resolve:x:77:
systemd-timesync:x:78:
systemd-coredump:x:79:
uuidd:x:80:
systemd-oomd:x:81:81:
wheel:x:97:
nogroup:x:99:
users:x:999:</literal>
EOF</userinput></screen>

  <para>Les groupes créés ne font partie d'aucun standard&mdash;ce sont des groupes
décidés en partie en fonction des besoins de la configuration de Udev dans
le chapitre 9, et en partie par la coutume utilisée par un certain nombre de
distributions Linux existantes. En outre, certaines suites de tests
s'appuient sur des groupes et des utilisateurs spécifiques. La base Linux
standard (Linux Standard Base ou LSB, disponible sur <ulink
url="http://refspecs.linuxfoundation.org/lsb.shtml"/>) recommande seulement
cela, ainsi que la présence d'un groupe <systemitem
class="groupname">root</systemitem> (GID 0) et d'un groupe <systemitem
class="groupname">bin</systemitem> (GID 1).  Tous les autres noms de groupe
et GID peuvent être librement choisis par l'administrateur du système
puisque les programmes bien écrits ne dépendent pas des numéros GID, mais
utilisent plutôt le nom du groupe.</para>

  <para>Certains tests dans <xref linkend="chapter-building-system"/> ont besoin
d'un utilisateur non privilégié. Nous ajoutons cet utilisateur ici et
supprimons ce compte à la fin de ce chapitre.</para>

<screen><userinput>echo "tester:x:$(ls -n $(tty) | cut -d" " -f3):101::/home/tester:/bin/bash" &gt;&gt; /etc/passwd
echo "tester:x:101:" &gt;&gt; /etc/group
install -o tester -d /home/tester</userinput></screen>

  <para>Pour supprimer l'invite <quote>I have no name!</quote>, démarrez un nouveau
shell. Comme nous avons créé les fichiers <filename>/etc/passwd</filename>
et <filename>/etc/group</filename>, la résolution du nom d'utilisateur et de
groupe fonctionnera à présent&nbsp;:</para>

<screen role="nodump"><userinput>exec /bin/bash --login +h</userinput></screen>

  <para>Remarquez l'utilisation du paramètre <parameter>+h</parameter>. Il dit à
<command>bash</command> de ne pas utiliser son hachage de chemin
interne. Sans ce paramètre, <command>bash</command> se rappellerait des
chemins vers les binaires qu'il a exécutés. Pour s'assurer que les binaires
nouvellement compilés seront utilisés dès qu'ils seront installés, le
paramètre <parameter>+h</parameter> sera utilisée durant tout le chapitre.</para>

  <para>Les programmes <command>login</command>, <command>agetty</command>, et
<command>init</command> (et d'autres) utilisent un nombre de journaux
applicatifs pour enregistrer des informations comme qui s'est connecté sur
le système et quand. Mais ces programmes n'écriront pas vers ces journaux
s'ils n'existent pas. Initialisez les journaux et donnez-leur les bons
droits&nbsp;:</para>

<screen><userinput>touch /var/log/{btmp,lastlog,faillog,wtmp}
chgrp -v utmp /var/log/lastlog
chmod -v 664  /var/log/lastlog
chmod -v 600  /var/log/btmp</userinput></screen>

  <para>Le fichier <filename>/var/log/wtmp</filename> enregistre toutes les
connexions et les déconnexions. Le fichier
<filename>/var/log/lastlog</filename> enregistre le moment de dernière
connexion de chaque utilisateur. Le fichier
<filename>/var/log/faillog</filename> enregistre les tentatives de connexion
échouées. Le fichier <filename>/var/log/btmp</filename> enregistre les
mauvaises tentatives de connexion.</para>

  <note><para>Le fichier <filename>/run/utmp</filename> enregistre les utilisateurs qui
sont actuellement connectés. Ce fichier est créé de manière dynamique dans
les scripts de démarrage.</para></note>

</sect1>
