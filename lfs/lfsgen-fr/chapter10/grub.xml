<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../general.ent">
  %general-entities;
]>

<sect1 id="ch-bootable-grub" role="wrap">
  <?dbhtml filename="grub.html"?>

  <sect1info condition="script">
<productname>grub</productname>
<productnumber>&grub-version;</productnumber> <address>&grub-url;</address></sect1info>

  <title>Utiliser GRUB pour paramétrer le processus de démarrage</title>

  <note>
    <para>
      Si votre système prend en charge l'UEFI et que vous souhaitez démarrer LFS
en UEFI, vous devriez sauter cette page, et configurer GRUB avec la prise en
charge de l'UEFI avec les instructions de <ulink
url="&blfs-book;postlfs/grub-setup.html">la page BLFS</ulink>.
    </para>
  </note>

  <sect2>
    <title>Introduction</title>

    <warning><para>Une mauvaise configuration de GRUB peut rendre votre système inutilisable si
vous n'avez pas d'autre périphérique d'amorçage comme un cédérom. Cette
section n'est pas obligatoire pour démarrer votre système LFS. Il se peut
que vous vouliez simplement modifier votre chargeur de démarrage actuel,
comme Grub-Legacy, GRUB2 ou LILO.</para></warning>

    <para> Assurez-vous d'avoir un disque de démarrage de façon à pouvoir
<quote>dépanner</quote> l'ordinateur si celui-ci devenait inutilisable (non
amorçable). Si vous n'avez pas déjà de périphérique de démarrage, vous
pouvez en créer un. Afin que la procédure ci-dessous fonctionne, vous devez
faire un tour du côté de BLFS et installer <userinput>xorriso</userinput>
qui est dans le paquet <ulink
url="&blfs-book;multimedia/libisoburn.html">libisoburn</ulink>.</para>

<screen role="nodump"><userinput>cd /tmp 
grub-mkrescue --output=grub-img.iso 
xorriso -as cdrecord -v dev=/dev/cdrw blank=as_needed grub-img.iso</userinput></screen>

  </sect2>

  <sect2>
    <title>Conventions de nommage de GRUB</title>

    <para>GRUB utilise sa propre nomenclature de disques et partitions, de la forme
<emphasis>(hdn,m)</emphasis>, où <emphasis>n</emphasis> est le numéro du
disque dur et <emphasis>m</emphasis> le numéro de la partition. Le numéro du
disque dur commence à zéro, mais le numéro de la partition commence à un
pour les partitions normales et à cinq pour les partitions
étendues. Remarquez que ceci diffère des versions précédentes où les deux
numéros commençaient à zéro. Par exemple, les partitions <filename
class="partition">sda1</filename> correspond à <emphasis>(hd0,1)</emphasis>
pour GRUB et <filename class="partition">sdb3</filename> correspond à
<emphasis>(hd1,3)</emphasis>. Contrairement à Linux, GRUB ne considère pas
les lecteurs de cédérom comme des disques durs. Par exemple, si un CD se
trouve sur <filename class="partition">hdb</filename> et un second disque
dur sur <filename class="partition">hdc</filename>, ce dernier disque sera
malgré tout <emphasis>(hd1)</emphasis>."</para>

  </sect2>

  <sect2>
    <title>Réglage de la configuration</title>

    <para>GRUB fonctionne en écrivant les données sur le premier secteur physique du
disque dur. Ce secteur ne fait partie d'aucun système de fichiers. Les
programmes accèdent alors aux modules de GRUB dans la partition de
démarrage.  L'emplacement par défaut est /boot/grub/.</para>

    <para>L'emplacement de la partition de démarrage est un choix de l'utilisateur qui
conditionne la configuration. Une bonne pratique consiste à avoir une petite
partition distincte (la taille suggérée est de 200&nbsp;Mo)  pour les
informations d'amorçage. De cette façon, chaque construction, que ce soit
LFS ou d'autres distributions commerciales, peut accéder aux mêmes fichiers
de démarrage et n'importe quel système amorcé peut y accéder.  Si vous
choisissez cette option, vous aurez besoin de monter la partition
séparément, de déplacer tous les fichiers du répertoire <filename
class="directory">/boot</filename> actuel (par exemple, le noyau linux que
vous venez de construire à l'étape précédente)  vers la nouvelle
partition. Vous aurez ensuite besoin de démonter la partition puis de la
remonter en tant que <filename class="directory">/boot</filename>.  Si vous
le faites, assurez-vous de mettre à jour <filename>/etc/fstab</filename>.</para>

    <para>L'utilisation de la partition lfs actuelle fonctionnera également, mais la
configuration de plusieurs systèmes sera plus difficile.</para>

    <para>En utilisant les informations ci-dessus, déterminez le nom adapté à la
partition racine (ou partition de démarrage, s'il en existe une
distincte). Pour l'exemple suivant, supposons que la partition racine (ou la
partition de démarrage) est <filename class="partition">sda2</filename>.</para>

    <para>Installez les fichiers de GRUB dans <filename
class="directory">/boot/grub</filename> et paramétrez le secteur
d'amorçage&nbsp;:</para>

    <warning>
      <para>La commande suivante va écraser le chargeur de démarrage actuel. Ne lancez
pas la commande si ce n'est pas ce que vous désirez, par exemple si vous
utilisez un gestionnaire de démarrage extérieur pour gérer le Master Boot
Record (MBR).</para>
    </warning>

<screen role="nodump"><userinput>grub-install /dev/sda</userinput></screen>

    <note>
      <para>Si le système a été démarré en UEFI, <command>grub-install</command>
essayera d'installer des fichiers pour la cible
<emphasis>x86_64-efi</emphasis>, mais ces fichiers n'ont pas été installés
au <xref linkend="chapter-building-system"/>. Si c'est le cas, ajoutez
<option>--target i386-pc</option> à la commande ci-dessus.</para>
    </note>


  <!-- This does not seem to be true any more
    <note>
<para><application>grub-install</application> is a script and calls another
    program, grub-probe, that may fail with a message "cannot stat `/dev/root'".
    If so, create a temporary symbolic link from your root partition to /dev/root:</para>

<screen role="nodump"><userinput>ln -sv /dev/sda2 /dev/root</userinput></screen>

    <para>The symbolic link will only be present until the system is rebooted.
    The link is only needed for the installation procedure.
    </para></note>
-->
</sect2>

  <sect2 id="grub-cfg">
    <title>Créer le fichier de configuration de GRUB</title>

    <para>Générez <filename>/boot/grub/grub.cfg</filename>&nbsp;:</para>

    <screen revision="sysv"><userinput>cat &gt; /boot/grub/grub.cfg &lt;&lt; "EOF"
<literal># Début de /boot/grub/grub.cfg
set default=0
set timeout=5

insmod ext2
set root=(hd0,2)

menuentry "GNU/Linux, Linux &linux-version;-lfs-&version;" {
        linux   /boot/vmlinuz-&linux-version;-lfs-&version; root=/dev/sda2 ro
}</literal>
EOF</userinput></screen>

    <screen revision="systemd"><userinput>cat &gt; /boot/grub/grub.cfg &lt;&lt; "EOF"
<literal># Début de /boot/grub/grub.cfg
set default=0
set timeout=5

insmod ext2
set root=(hd0,2)

menuentry "GNU/Linux, Linux &linux-version;-lfs-&versiond;" {
        linux   /boot/vmlinuz-&linux-version;-lfs-&versiond; root=/dev/sda2 ro
}</literal>
EOF</userinput></screen>


    <note><para>Du point de vue de <application>GRUB</application>, les fichiers du noyau
sont relatifs à la partition utilisée. Si vous avez utilisé une partition
/boot distincte, supprimez /boot de la ligne <emphasis>linux</emphasis>
ci-dessus. Vous devrez aussi modifier la ligne <emphasis>set root</emphasis>
pour pointer vers la partition d'amorçage.
    </para></note>

    <para>GRUB est un programme extrêmement puissant et il offre un très grand nombre
d'options pour démarrer depuis une large gamme de périphériques, de systèmes
d'exploitation et de types de partition. Il a aussi beaucoup d'options de
personnalisation telles que les écrans d'accueil graphiques, les annonces
sonores, l'entrée à la souris, etc. Les détails de ces options vont au-delà
des objectifs de cette introduction.</para>

    <caution><para>Il existe une commande, <application>grub-mkconfig</application> qui peut
écrire automatiquement un fichier de configuration. Elle utilise un ensemble
de scripts situés dans /etc/grub.d/ et elle détruira les personnalisations
que vous aurez faites. Ces scripts sont d'abord conçus pour des
distributions qui ne se basent pas sur les sources et ils ne sont pas
recommandés pour LFS. Si vous installez une distribution Linux commerciale,
il est fort probable que ce programme soit lancé. Assurez-vous de
sauvegarder votre fichier grub.cfg.</para></caution>

   </sect2>

</sect1>
