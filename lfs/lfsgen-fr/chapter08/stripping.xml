<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../general.ent">
  %general-entities;
]>

<sect1 id="ch-system-stripping">
  <?dbhtml filename="stripping.html"?>

  <title>Nettoyage</title>

  <para>Cette section est facultative. Si l'utilisateur du système ne programme pas
et ne prévoie pas de déboguer les logiciels du système, vous pouvez réduire
la taille du système d'environ 2&nbsp;Go en supprimant les symboles de
débogage des binaires et des bibliothèques. Cela ne pose aucun problème en
dehors du fait de ne plus pouvoir déboguer les logiciels complètement.</para>

  <para>La plupart des gens utilisent les commandes mentionnées ci-dessous sans
difficulté. Cependant, il est facile de faire une coquille et de rendre le
nouveau système inutilisable, donc avant de lancer les commandes
<command>strip</command>, il vaut mieux faire une sauvegarde du système LFS
dans son état actuel.</para>

  <para>Les symboles de débogage pour les bibliothèques choisies sont placés dans
des fichiers séparés. Ces informations de débogage sont requises si vous
lancez des tests de régression qui utilisent <ulink
url='&blfs-book;/general/valgrind.html'>valgrind</ulink> ou <ulink
url='&blfs-book;/general/gdb.html'>gdb</ulink> plus tard dans BLFS.
  </para>

  <para>Remarquez que <command>strip</command> remplacera le binaire ou la
bibliothèque qu'il traite. Cela peut faire crasher les processus qui
utilisent du code ou des données de ce fichier. Si le processus lançant
<command>strip</command> lui-même est affecté, le binaire ou la bibliothèque
en cours de nettoyage peut être détruit. Cela peut rendre le système
complètement inutilisable. Pour éviter cela, nous copierons certains
bibliothèques et binaires dans <filename class="directory">/tmp</filename>,
les nettoierons là, et les installerons de nouveau avec la commande
<command>install</command>. Lisez les entrées liées dans le <xref
linkend="pkgmgmt-upgrade-issues"/> pour les raisons d'utiliser la commande
<command>install</command> ici.</para>

  <note><para>Le nom du chargeur ELF est ld-linux-x86-64.so.2 sur les systèmes 64 bits et
ld-linux.so.2 sur les systèmes 32 bits. La construction ci-dessous choisit
le bon nom pour l'architecture actuelle.</para></note>




      <screen><!-- also of interest are libgfortan, libgo, libgomp, and libobjc from GCC -->
<!--<screen>
<userinput>save_lib="ld-2.25.so libc-2.25.so libpthread-2.25.so libthread_db-1.0.so"-->
<userinput>save_usrlib="$(cd /usr/lib; ls ld-linux*)
             libc.so.6
             libthread_db.so.1
             libquadmath.so.&libquadmath-version; 
             libstdc++.so.&libstdcpp-version;
             libitm.so.&libitm-version; 
             libatomic.so.&libatomic-version;" 

cd /usr/lib

for LIB in $save_usrlib; do
    objcopy --only-keep-debug $LIB $LIB.dbg
    cp $LIB /tmp/$LIB
    strip --strip-unneeded /tmp/$LIB
    objcopy --add-gnu-debuglink=$LIB.dbg /tmp/$LIB
    install -vm755 /tmp/$LIB /usr/lib
    rm /tmp/$LIB
done

online_usrbin="bash find strip"
online_usrlib="libbfd-&binutils-version;.so
               libhistory.so.&readline-version;
               libncursesw.so.&ncurses-version;
               libm.so.6
               libreadline.so.&readline-version;
               libz.so.&zlib-version;
               $(cd /usr/lib; find libnss*.so* -type f)"

for BIN in $online_usrbin; do
    cp /usr/bin/$BIN /tmp/$BIN
    strip --strip-unneeded /tmp/$BIN
    install -vm755 /tmp/$BIN /usr/bin
    rm /tmp/$BIN
done

for LIB in $online_usrlib; do
    cp /usr/lib/$LIB /tmp/$LIB
    strip --strip-unneeded /tmp/$LIB
    install -vm755 /tmp/$LIB /usr/lib
    rm /tmp/$LIB
done

for i in $(find /usr/lib -type f -name \*.so* ! -name \*dbg) \
         $(find /usr/lib -type f -name \*.a)                 \
         $(find /usr/{bin,sbin,libexec} -type f); do
    case "$online_usrbin $online_usrlib $save_usrlib" in
        *$(basename $i)* ) 
            ;;
        * ) strip --strip-unneeded $i 
            ;;
    esac
done

unset BIN LIB save_usrlib online_usrbin online_usrlib
</userinput></screen>

  <para>La commande rapportera un grand nombre de fichiers comme ayant une extension
non reconnue. Vous pouvez ignorer ces avertissements sans problème. Cela
signifie que ces fichiers sont des scripts et non des binaires.</para>

</sect1>
