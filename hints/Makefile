#!/usr/bin/make -f

# Use make L=... to build only a subset of the languages.

LANGUAGES := fr
LANG_fr := fr_FR.UTF-8
L = all

ORIGIN:=origin
ORIGINAL_FILES=$(shell ls $(ORIGIN)/*.txt)

# include.mk contains most of the logic of the Makefile.
# We generate lists of XML files to translated, PO files that contain translations,
# images and stylesheet files, and the list of files to copy from the english repo.
#
# It also contains targets to build different html versions, to refresh the PO
# files and to generate the translated XML files. We need to use this target
# because the language in the name of the target and the file name are both
# wildcards, which cannot be used.
include include.mk
include.mk: include.in $(ORIGDIR) Makefile
	echo '# This file is generated by Makefile, please do not modify it directly.' > $@.tmp
	echo 'PO :=' >> $@.tmp
	echo 'GEN :=' >> $@.tmp
	for lang in $(LANGUAGES); do \
		sed -e "s|MLANG|$$lang|g" include.in >> $@.tmp;\
	done
	mv $@.tmp $@

$(ORIGIN)/index.html:
	mkdir -p $(ORIGIN)
	wget http://linuxfromscratch.org/hints/downloads/files/ -O $@

$(ORIGIN)/file-list: $(ORIGIN)/index.html
	grep 'href=.*txt' $< | sed -e 's|.*href="\([^"]*txt\)".*|\1|g' \
		-e 's|\(.*\)|http://linuxfromscratch.org/hints/downloads/files/\1|g' > $@

sync-$(ORIGIN): $(ORIGIN)/file-list
	cd $(ORIGIN); wget -N --input-file=file-list

update: $(PO)
gen: $(GEN)

pootle:
	pootle sync_stores --project=hints
	$(MAKE) sync-origin
	$(MAKE) update
	pootle update_stores --project=hints
