<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../../general.ent">
  %general-entities;
]>

<sect1 id="ch-scripts-symlinks">
  <?dbhtml filename="symlinks.html"?>

  <title>Création de liens symboliques personnalisés vers les périphériques</title>


  <sect2>

    <title>Liens symboliques pour le CD-ROM</title>

    <para>Certains logiciels que vous pourriez vouloir installer plus
    tard (comme divers lecteurs multimédias) s'attendent à ce que les
    liens symboliques <filename class="symlink">/dev/cdrom</filename> et
    <filename class="symlink">/dev/dvd</filename> existent et pointent
    vers le lecteur CD-ROM ou DVD-ROM. De plus, il peut être pratique de
    mettre des références à ces liens symboliques dans
    <filename>/etc/fstab</filename>. Pour chacun de vos périphériques CD-ROM, trouvez le répertoire correspondant sous 
    <filename class="directory">/sys</filename> (cela peut être par exemple
    <filename class="directory">/sys/block/hdd</filename>) et lancez une commande ressemblant à ce qui suit&nbsp;:</para>

<screen role="nodump"><userinput>udevadm test /sys/block/hdd</userinput></screen>

    <para>Regardez les lignes contenant la sortie des divers programmes *_id.</para>
   
    <para>Il y a deux approches pour créer des liens symboliques. La première consiste à utiliser le nom de modèle et le numéro de série, la 
    seconde est basée sur l'emplacement du périphérique sur le bus. Si vous allez utiliser la première approche, créez un fichier qui 
    ressemble à ce qui suit&nbsp;:</para>

<screen role="nodump"><userinput>cat &gt;/etc/udev/rules.d/82-cdrom.rules &lt;&lt; EOF
<literal>
# Liens symboliques pour le lecteur CD-ROM personnalisés
SUBSYSTEM=="block", ENV{ID_MODEL}=="SAMSUNG_CD-ROM_SC-148F", \
    ENV{ID_REVISION}=="PS05", SYMLINK+="cdrom"
SUBSYSTEM=="block", ENV{ID_MODEL}=="PHILIPS_CDD5301", \
    ENV{ID_SERIAL}=="5VO1306DM00190", SYMLINK+="cdrom1 dvd"
</literal>
EOF</userinput></screen>

    <note>
      <para>Bien que les exemples  de ce livre fonctionnent correctement, gardez à l'esprit qu'Udev ne reconnaît pas les antislash pour 
      poursuivre une ligne. Si vous modifiez des règles Udev avec un éditeur, prenez garde à laisser chaque règle sur une ligne 
      physique.</para>
    </note>

    <para>De cette façon, les liens symboliques resteront bons même si vous déplacez les périphériques dans des positions différentes sur le 
    bus IDE mais le lien symbolique <filename>/dev/cdrom</filename> ne sera pas créé si vous remplacez le vieux
    SAMSUNG CD-ROM par un nouveau lecteur.</para>
<!-- The symlinks in the first approach survive even the transition
     to libata for IDE drives, but that is not for the book. -->

    <para>La clé SUBSYSTEM==&quot;block&quot; est nécessaire afin d'éviter une correspondance entre les périphériques génériques SCSI. Sans 
    cela, avec des lecteurs de CD-ROM SCSI, les liens symboliques pointeront tantôt vers les bons périphériques 
    <filename>/dev/srX</filename>, tantôt vers <filename>/dev/sgX</filename>, ce qui est faux.</para>

    <para>La seconde approche donne&nbsp;:</para>

<screen role="nodump"><userinput>cat &gt;/etc/udev/rules.d/82-cdrom.rules &lt;&lt; EOF
<literal>
# Liens symboliques pour le lecteur CD-ROM personnalisés
SUBSYSTEM=="block", ENV{ID_TYPE}=="cd", \
    ENV{ID_PATH}=="pci-0000:00:07.1-ide-0:1", SYMLINK+="cdrom"
SUBSYSTEM=="block", ENV{ID_TYPE}=="cd", \
    ENV{ID_PATH}=="pci-0000:00:07.1-ide-1:1", SYMLINK+="cdrom1 dvd"
</literal>
EOF</userinput></screen>

    <para>De cette façon, les liens symboliques demeureront corrects même si vous remplacez des lecteurs par des modèles différents mais 
    que vous placez sur les anciennes positions sur le bus IDE. La clé ENV{ID_TYPE}==&quot;cd&quot; s'assure que le lien symbolique 
    disparaisse si vous mettez quelque chose d'autre qu'un lecteur de CD-ROM dans une telle position sur le bus.</para>

    <para>Bien entendu, il est possible de mélanger les deux approches.</para>

  </sect2>

  <sect2>

    <title>Gestion des périphériques dupliqués</title>

    <para>Comme expliqué dans le <xref linkend="ch-scripts-udev"/>, l'ordre dans lequel les périphériques ayant la même fonction apparaissent
    dans <filename class="directory">/dev</filename> est essentiellement
    aléatoire. Par exemple si vous avez une webcam en USB et un tunner
    TV, parfois <filename>/dev/video0</filename> renvoie à la webcam, et
    <filename>/dev/video1</filename> renvoie au tuner, et parfois après
    un redémarrage l'ordre s'inverse. Pour toutes les classes
    de matériel sauf les cartes son et les cartes réseau, ceci peut se
    corriger en créant des règles udev pour des liens symboliques
    constants personnalisés. Le cas des cartes réseau est traité séparément dans la
    <xref linkend="chapter-network"/> et vous pouvez 
    trouver la configuration des cartes son dans <ulink url="&cblfs-root;">CBLFS</ulink>.</para>

    <para>Pour chacun des périphériques susceptibles d'avoir ce problème
    (même si le problème n'apparaît pas dans votre distribution Linux
    actuelle), trouvez le répertoire correspondant sous
    <filename class="directory">/sys/class</filename> ou
    <filename class="directory">/sys/block</filename>. Pour les
    périphériques vidéo, cela peut être
    <filename class="directory">/sys/class/video4linux/video<replaceable>X</replaceable></filename>.
    Calculez les attributs qui identifient de façon unique un
    périphérique (normalement basé sur l'ID du fabricant et du produit
    et/ou les numéros de série)&nbsp;:</para>

<screen role="nodump"><userinput>udevadm info -a -p /sys/class/video4linux/video0</userinput></screen>

      <para>Puis, écrivez des règles qui créent les liens symboliques,
      comme&nbsp;:</para>

<screen role="nodump"><userinput>cat &gt;/etc/udev/rules.d/83-duplicate_devs.rules &lt;&lt; EOF
<literal>
# Liens symboliques constants pour webcam  et tuner
KERNEL=="video*", SYSFS{idProduct}=="1910", SYSFS{idVendor}=="0d81", \
    SYMLINK+="webcam"
KERNEL=="video*", SYSFS{device}=="0x036f", SYSFS{vendor}=="0x109e", \
    SYMLINK+="tvtuner"
</literal>
EOF</userinput></screen>

    <para>Il en résulte que les périphériques
    <filename>/dev/video0</filename> et <filename>/dev/video1</filename>
    renvoient encore de manière aléatoire au tuner et à la webcam (et
    donc ne devrait jamais être utilisé directement), mais il y a des
    liens smboliques <filename>/dev/tvtuner</filename> et
    <filename>/dev/webcam</filename> qui pointent toujours vers le bon
    périphérique.</para>

    <para>Vous pouvez trouver plus d'informations sur l'écriture de
    règles Udev dans
    <filename>/usr/share/doc/udev/writing_udev_rules/index.html</filename>.</para>

 </sect2>

</sect1>

