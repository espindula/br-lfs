<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../../general.ent">
  %general-entities;

  <!ENTITY qemu-kvm-download-http " ">
  <!ENTITY qemu-kvm-download-ftp  "&sourceforge-repo2;/projects/kvm/files/qemu-kvm/&qemu-kvm-version;/qemu-kvm-&qemu-kvm-version;.tar.gz">
  <!ENTITY qemu-kvm-md5sum        "00a825db46a70ba8ef9fc95da9cc7c1e">
  <!ENTITY qemu-kvm-size          "5.9 Mio">
  <!ENTITY qemu-kvm-buildsize     "112 Mio">
  <!ENTITY qemu-kvm-time          "1.3 SBU">
]>

<sect1 id="qemu-kvm" xreflabel="qemu-kvm-&qemu-kvm-version;">
  <?dbhtml filename="qemu-kvm.html"?>

  <sect1info>
    <othername>$LastChangedBy&nbsp;: ken $</othername>
    <date>$Date&nbsp;: 2012-03-09 17:13:13 +0100 (ven. 09 mars 2012) $</date>
  </sect1info>

  <title>qemu-kvm-&qemu-kvm-version;</title>

  <indexterm zone="qemu-kvm">
    <primary sortas="a-qemu-kvm">qemu-kvm</primary>
  </indexterm>

  <sect2 role="package">
    <title>Introduction à qemu-kvm</title>

     <para><application>qemu-kvm</application> est une solution de virtualisation complète
    pour Linux avec un processeur x86 supportant les extensions de virtualisation (Intel VT ou
    AMD-V).</para>

    <bridgehead renderas="sect3">Information sur le paquet </bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>Téléchargement (HTTP)&nbsp;: <ulink url="&qemu-kvm-download-http;"/></para>
      </listitem>
      <listitem>
        <para>Téléchargement (FTP)&nbsp;: <ulink url="&qemu-kvm-download-ftp;"/></para>
      </listitem>
      <listitem>
        <para>Somme de contrôle MD5 du téléchargement&nbsp;: &qemu-kvm-md5sum;</para>
      </listitem>
      <listitem>
        <para>Taille du téléchargement&nbsp;: &qemu-kvm-size;</para>
      </listitem>
      <listitem>
        <para>Estimation de l'espace disque requis&nbsp;: &qemu-kvm-buildsize;</para>
      </listitem>
      <listitem>
        <para>Estimation du temps de construction&nbsp;: &qemu-kvm-time;</para>
      </listitem>
    </itemizedlist>

    <bridgehead renderas="sect3">Dépendances de qemu-kvm</bridgehead>

    <bridgehead renderas="sect4">Requises</bridgehead>
    <para role="required">
      <xref linkend="pkgconfig"/>,
      <xref linkend="python2"/>,
      <xref linkend="sdl"/>, et
      <xref linkend="x-window-system"/>
    </para>

    <bridgehead renderas="sect4">Facultative</bridgehead>
    <para role="optional">
      <xref linkend="alsa"/>,
      <xref linkend="attr"/>,
      <xref linkend="check"/>,
      <xref linkend="curl"/>,
      <xref linkend="esound"/>,
      <xref linkend="mesalib"/>, et
      <xref linkend="cyrus-sasl"/>.
      Notez que la liste des dépendances facultatives n'est pas complète. Voir la sortie de
      <command>./configure --help</command> pour une liste plus complète.
    </para>

    <para condition="html" role="usernotes">Notes utilisateur&nbsp;:
    <ulink url="&blfs-wiki;/qemu-kvm"/></para>

  </sect2>

  <sect2 id='qemu-kvm-prereq'>
    <title>Prérequis de KVM</title>

    <para>Avant de construite <application>qemu-kvm</application>, vérifier si votre precesseur 
    supporte la technologie de virtualisation&nbsp;:</para>

    <screen><userinput>egrep '^flags.*(vmx|svm)' /proc/cpuinfo</userinput></screen>

    <para>Si vous avez une sortie, vous avez la technologie VT (vmx pour les prcesseurs Intel
    et svm pour les processeurs AMD). Vous devez également allez voir dans votre BIOS et vérifier
    qu'elle est activée. Après l'activation, rédémarrer sur votre LFS.</para>

  </sect2>

  <sect2 role="kernel" id='qemu-kvm-kernel'>
    <title>Configuration du noyau</title>

    <para>Activez les options suivantes dans la configuration du noyau
    et recompilez le noyau si nécessaire&nbsp;:</para>

<screen><literal>Virtualization: Y
  Kernel-based Virtual Machine (KVM) support: M or Y
  KVM for Intel processors support:           M or Y
  KVM for AMD processors support:             M or Y</literal></screen>

    <indexterm zone="qemu-kvm qemu-kvm-kernel">
      <primary sortas="d-qemu-kvm">kvm-qemu</primary>
    </indexterm>

    <para>Les options Intel ou AMD ne sont pas les deux nécessaire, but celle correspondante à votre processeur
    est obligatoire.</para>

    <para>Pour le réseau, vérifiez que les initialisations de CONFIG_BRIDGE, CONFIG_STP,
    CONFIG_TUN sont activées et que <xref linkend='bridgeutils'/> est installé.</para>

  </sect2>

  <sect2 role="installation">
    <title>Installation de qemu-kvm</title>
 
    <para>Si <application>xorg</application> n'est pas installé dans
    <filename class='directory'>/usr</filename>, alors le linker a besoin de savoir
    ou il est. Par exemple&nbsp;:</para>

<screen><userinput>export LIBRARY_PATH=/opt/xorg/lib</userinput></screen>

    <para>Installez <application>qemu-kvm</application> en lançant les commandes suivantes&nbsp;:
    </para>

<screen><userinput>./configure --prefix=/usr &amp;&amp;
make</userinput></screen>

    <para>Les tests ne sont pas automatiques. Pour lancer chacun des tests, allez dans le répertoire
    <filename class='directory'>tests/</filename>, et examinez
    le <filename>Makefile</filename>. Chaque test doit être lancé individuellement avec
    <command>make run-&lt;nom_du_test&gt;</command>.</para>

    <para>Maintenant, en tant qu'utilisateur <systemitem class="username">root</systemitem>&nbsp;:</para>

<screen role="root"><userinput>make install</userinput></screen>

    <note><para>Le programme principal <command>qemu-system-x86_64</command> ne fait pas de distinction
    entre i386 et x86_64 alors même sur un systèeme i386 vous devez utiliser
    <emphasis>qemu-system-x86_64</emphasis></para>
    
    <para>Par confort vous pouvez vouloir créer un lien symbolique pour lancer
    <command>qemu-system-x86_64</command>&nbsp;:</para>

    <screen><userinput>ln -sv qemu-system-x86_64 /usr/bin/qemu</userinput></screen>
    </note>

  </sect2>

  <sect2 role="configuration">
    <title>Configuration qemu-kvm</title>

    <para>Pour générer une image, lancez&nbsp;:</para>

    <screen><userinput>qemu-img create -f qcow2 vdisk.img 10G</userinput></screen>

    <para>Ajuster la taille du disque virtuel et le nom du fichier image comme souhaités. La taille
    réelle du fichier sera plus petite que spécifiée, mais s'agrandira quand il sera utilisé.</para>

    <note><para>Les instructions suivantes supposent que vous avez créé le lien symbolique facultatif,
    <userinput>qemu</userinput>. En supplément, vous devez exécuter
    <userinput>qemu</userinput> en tant qu'utilisateur <systemitem
    class="username">root</systemitem> depuis un terminal d'une fenètre X.</para></note>

    <para>Pour installer un système d'exploitation, téléchargez un iso de votre choix ou utilisez un CD d'installation.
    Pour les besoins de cet exemple, nous utiliserons une distribution
    Fedora 16 qui est téléchargée par l'iso
    <filename>Fedora-16-x86_64-Live-LXDE.iso</filename> dans le répertoire courant.
    Exécutez les commandes suivantes&nbsp;:</para>

<screen><userinput>qemu -hda vdisk.img                        \
     -cdrom Fedora-16-x86_64-Live-LXDE.iso \ 
     -boot d                               \
     -m 384</userinput></screen>

    <para>Suivre la procedure d'installation normal pour la distribution choisie.
    L'option -boot spécifie l'ordre de démarrage des disques comme un chaîne de lettres de
    lecteur. Les lettres valides de lecteurs sont&nbsp;: a, b (lecteur de disquettes 1 et 2), c (premier disque dur
    ), d (premier lecteur CD-ROM).  l'option -m est la quantité de mémoire à utiliser pour la 
    machine virtuelle. Si vous avez suffisament de mémoire (2G ou plus), 1G est une valeur correcte.
    Pour les ordinateurs avec 512Mio de RAM il est prudent d'utiliser -m 192, ou même -m 128 (la valeur par défaut).</para>

    <para>Pour exécuter le nouveau système d'exploitation, lancer&nbsp;:</para>

<screen><userinput>qemu vdisk.img -m 384</userinput></screen>

    <para>Pour ajouter le réseau à la machine virtuelle ajoutez "-net nic -net user" à la commande précédente.
    qemu fournit une serveur DHCP pour les machines virtuelles et en fonction de votre système client,
    initialisé le réseau au travers de l'hôte.</para>

    <para>un problème avec la solution réseau précédente est qu'elle ne fournit pas la possibilité de se connecter
    sur le réseau local. Pour faire cela, il y a quelques étapes supplémentaire qui doivent être faites,
    tout en tant qu'utilisateur <systemitem
    class="username">root</systemitem>&nbsp;:</para>

    <itemizedlist spacing="compact">
      <listitem>
        <para>Initialiser le mode pont avec <xref linkend='bridgeutils'/>.</para>
      </listitem>

      <listitem>
        <para>Autorisé le système hôte à transférer les paquets IP.</para>

<screen><userinput>sysctl -w net.ipv4.ip_forward=1</userinput></screen>
        
        <para>Pour rendre cela permanent, ajoutez la commande dans le fichier 
        <filename>/etc/syssysctl.conf</filename>&nbsp;:</para>

<screen><userinput>cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF
net.ipv4.ip_forward=1 
EOF</userinput></screen>

      </listitem>

      <listitem>
        <para>Créez des scripts pour qemu pour lier les cartes réseau cliente,
	normalement visible en tant que tap0, dans le pont hôte.</para>

<screen><userinput>cat &gt;&gt; /etc/qemu-ifup &lt;&lt; EOF
#!/bin/bash

switch=br0

if [ -n "$1" ]; then
  # ajoute une nouvelle interface tap0 au pont
  /sbin/ip link set $1 up
  sleep 0.5s
  /usr/sbin/brctl addif $switch $1
else
  echo "Erreur&nbsp;: pas d'interface spécifiée"
  exit 1
fi

exit 0 
EOF</userinput></screen>

<screen><userinput>cat &gt;&gt; /etc/qemu-ifdown &lt;&lt; EOF
#!/bin/bash

switch=br0

if [ -n "$1" ]; then
  # Enlève une interface tap0 au pont
  /usr/sbin/brctl delif $switch $1
else
  echo "Errer&nbsp;: pas d'interface spécifiée"
  exit 1
fi

exit 0 
EOF</userinput></screen>

      </listitem>

      <listitem>
        <para>Démarrer qemu avec les options "-net nic -net tap".  </para>
      </listitem>

      <listitem>
        <para>Si une connexion, en ssh par exemple, depuis le réseau local vers la VM cliente est souhaitée,
	le client devra être surement configuré avec une adresse IP statique.</para>
      </listitem>

    </itemizedlist>

  </sect2>

  <sect2 role="content">
    <title>Contenu</title>

    <segmentedlist>
      <segtitle>Programme installé</segtitle>
      <segtitle>Bibliothèques installées</segtitle>
      <segtitle>Répertoires installés</segtitle>

      <seglistitem>
        <seg>qemu-ga, qemu-img, qemu-io, qemu-nbd, qemu-system-x86_64</seg>
        <seg>Aucun</seg>
        <seg>/etc/qemu, /usr/share/qemu, /usr/share/doc/qemu</seg>
      </seglistitem>
    </segmentedlist>

    <variablelist>
      <bridgehead renderas="sect3">Short Description</bridgehead>
      <?dbfo list-presentation="list"?>
      <?dbhtml list-presentation="table"?>

      <varlistentry id="qemu-ga">
        <term><command>qemu-ga</command></term>
        <listitem>
          <para>implemente le support pour les commandes QMP (Protocole de surveillance QEMU) et
          les évenements qui terminent et débutent respectivement au sein de l'invité à l'aide
	  d'un agent intégré dans le cadre de QEMU.</para>
          <indexterm zone="qemu-kvm qemu-ga">
            <primary sortas="b-qemu-ga">qemu-ga</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="qemu-img">
        <term><command>qemu-img</command></term>
        <listitem>
          <para>fournit les commandes pour gérer les images disques QEMU.</para>
          <indexterm zone="qemu-kvm qemu-img">
            <primary sortas="b-qemu-img">qemu-img</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="qemu-io">
        <term><command>qemu-io</command></term>
        <listitem>
          <para>est un programme de diagnostique et de manipulation pour les médias (virtuels) en mémoire.
	  Il est encore à un stade de développement précoce.</para>
          <indexterm zone="qemu-kvm qemu-io">
            <primary sortas="b-qemu-io">qemu-io</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="qemu-nbd">
        <term><command>qemu-nbd</command></term>
        <listitem>
          <para>exporte les images disque Qemu  en utilisant le protocole disque QEMU "Network Block
          Device" (NBD).</para>
          <indexterm zone="qemu-kvm qemu-nbd">
            <primary sortas="b-qemu-nbd">qemu-nbd</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="qemu-system">
        <term><command>qemu-system-x86_64</command></term>
        <listitem>
          <para>est l'émulateur QEMU de sytème PC.</para>
          <indexterm zone="qemu-kvm qemu-system">
            <primary sortas="b-qemu-system">qemu-system-x86_64</primary>
          </indexterm>
        </listitem>
      </varlistentry>

    </variablelist>

  </sect2>

</sect1>
