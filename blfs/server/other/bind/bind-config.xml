<sect2>
<title>Configurer BIND</title>
<para>Nous configurerons BIND de lancer dans une prison chroot en tant
qu'utilisateur non privilégié (named). Cette configuration est plus sécurisé
qu'une compromission dûe à DNS peut affecter seulement quelques fichiers dans
le répertoire $HOME de l'utilisateur named.</para> 

<para>Tout d'abord, nous mettons en place quelques fichiers et répertoires
nécessaires à BIND:</para>
<para><screen><userinput>
groupadd -g 200 named &amp;&amp;
useradd -m -g named -u 200 -s /bin/false named &amp;&amp;
cd /home/named &amp;&amp;
mkdir -p dev etc/namedb/slave var/run &amp;&amp;
mknod /home/named/dev/null c 1 3 &amp;&amp;
mknod /home/named/dev/random c 1 8 &amp;&amp;
chmod 666 /home/named/dev/{null,random} &amp;&amp;
mkdir /home/named/etc/namedb/pz &amp;&amp;
cp /etc/localtime /home/named/etc
</userinput></screen></para>

<sect3><title>Fichiers de configuration</title>
<para><userinput>named.conf, root.hints, 127.0.0, rndc.conf
</userinput></para>

<para>Créez le fichier named.conf avec les commandes suivantes:</para>
<para><screen><userinput>
cat &gt; /home/named/etc/named.conf &lt;&lt; "EOF"
 options {
     directory "/etc/namedb";
    pid-file "/var/run/named.pid";
    statistics-file "/var/run/named.stats";
       
 };
 controls {
     inet 127.0.0.1 allow { localhost; } keys { rndc_key; };
 };
 key "rndc_key" {
     algorithm hmac-md5;
     secret "c3Ryb25nIGVub3VnaCBmb3IgYSBtYW4gYnV0IG1hZGUgZm9yIGEgd29tYW4K";
 };
 zone "." {
     type hint;
     file "root.hints";
 };
 zone "0.0.127.in-addr.arpa" {
     type master;
     file "pz/127.0.0";
 };
EOF
</userinput></screen></para>
<para>Créez un fichier zone avec le contenu suivant: </para>
<para><screen><userinput>
cat &gt; /home/named/etc/namedb/pz/127.0.0 &lt;&lt "EOF"
$TTL 3D
@      IN      SOA     ns.local.domain. hostmaster.local.domain. (
                        1       ; Serial
                        8H      ; Refresh
                        2H      ; Retry
                        4W      ; Expire
                        1D)     ; Minimum TTL
                NS      ns.local.domain.
1               PTR     localhost.
EOF
</userinput></screen></para>

<para>Créez le fichier root.hints avec les commandes suivantes:</para>
<note><para>Faites attention et assurez-vous qu'il n'existe aucun espace final
dans ce fichier.</para></note>
<para><screen><userinput>
cat &gt; /home/named/etc/namedb/root.hints &lt;&lt; "EOF"
.                       6D  IN      NS      A.ROOT-SERVERS.NET.
.                       6D  IN      NS      B.ROOT-SERVERS.NET.
.                       6D  IN      NS      C.ROOT-SERVERS.NET.
.                       6D  IN      NS      D.ROOT-SERVERS.NET.
.                       6D  IN      NS      E.ROOT-SERVERS.NET.
.                       6D  IN      NS      F.ROOT-SERVERS.NET.
.                       6D  IN      NS      G.ROOT-SERVERS.NET.
.                       6D  IN      NS      H.ROOT-SERVERS.NET.
.                       6D  IN      NS      I.ROOT-SERVERS.NET.
.                       6D  IN      NS      J.ROOT-SERVERS.NET.
.                       6D  IN      NS      K.ROOT-SERVERS.NET.
.                       6D  IN      NS      L.ROOT-SERVERS.NET.
.                       6D  IN      NS      M.ROOT-SERVERS.NET.
A.ROOT-SERVERS.NET.     6D  IN      A       198.41.0.4
B.ROOT-SERVERS.NET.     6D  IN      A       128.9.0.107
C.ROOT-SERVERS.NET.     6D  IN      A       192.33.4.12
D.ROOT-SERVERS.NET.     6D  IN      A       128.8.10.90
E.ROOT-SERVERS.NET.     6D  IN      A       192.203.230.10
F.ROOT-SERVERS.NET.     6D  IN      A       192.5.5.241
G.ROOT-SERVERS.NET.     6D  IN      A       192.112.36.4
H.ROOT-SERVERS.NET.     6D  IN      A       128.63.2.53
I.ROOT-SERVERS.NET.     6D  IN      A       192.36.148.17
J.ROOT-SERVERS.NET.     6D  IN      A       192.58.128.30
K.ROOT-SERVERS.NET.     6D  IN      A       193.0.14.129
L.ROOT-SERVERS.NET.     6D  IN      A       198.32.64.12
M.ROOT-SERVERS.NET.     6D  IN      A       202.12.27.33
EOF
</userinput></screen></para>

<para>Créez rndc.conf avec les commandes suivantes:</para>
<para><screen><userinput>
cat &gt; /etc/rndc.conf &lt;&lt; "EOF"
key rndc_key {
algorithm "hmac-md5";
    secret
    "c3Ryb25nIGVub3VnaCBmb3IgYSBtYW4gYnV0IG1hZGUgZm9yIGEgd29tYW4K";
    };
options {
    default-server localhost;
    default-key    rndc_key;
};
EOF
</userinput></screen></para>

<para>Créez ou modifiez resolv.conf pour utiliser un nouveau serveur de noms
avec les commandes suivantes:</para>
<note><para>Remplacez yourdomain.com avec votre propre nom de domaine valide.
</para></note>

<para><screen><userinput>
cp /etc/resolv.conf /etc/resolv.conf.bak
cat &gt; /etc/resolv.conf &lt;&lt; "EOF"
search yourdomain.com
nameserver 127.0.0.1
EOF
</userinput></screen></para>

<para>Indiquez les permissions sur la prison chroot avec la commande suivante:
</para>
<para><screen><userinput>
chown -R named.named /home/named
</userinput></screen></para>

<para>Créez le script de démarrage BIND:</para>
<para><screen><userinput>
cat &gt; /etc/rc.d/init.d/bind &lt;&lt; "EOF"
#!/bin/bash
# Début $rc_base/init.d/bind
# Basé sur le script sysklogd de LFS-3.1 et précédents.
# Réécrit par Gerard Beekmans  - gerard@linuxfromscratch.org
source /etc/sysconfig/rc
source $rc_functions
case "$1" in
	start)
		echo "Starting named..."
		loadproc /usr/sbin/named -u named -t /home/named -c \
		        /etc/named.conf
		;;
	stop)
		echo "Stopping named..."
		killproc /usr/sbin/named
		;;
	restart)
		$0 stop
		sleep 1
		$0 start
		;;
   reload)
                echo "Reloading named..."
                /usr/sbin/rndc -c /etc/rndc.conf reload
                ;;
			       		
	status)
		statusproc /usr/sbin/named
		;;
	*)
		echo "Usage: $0 {start|stop|restart|status}"
		exit 1
		;;
esac
# Fin $rc_base/init.d/bind
EOF
</userinput></screen></para>

<para>Ajoutez les liens symboliques des niveaux d'exécution:</para>
<para><screen><userinput>
chmod 754 /etc/rc.d/init.d/bind &amp;&amp;
ln -s  /etc/rc.d/init.d/bind /etc/rc.d/rc0.d/K90bind &amp;&amp;
ln -s  /etc/rc.d/init.d/bind /etc/rc.d/rc1.d/K90bind &amp;&amp;
ln -s  /etc/rc.d/init.d/bind /etc/rc.d/rc2.d/K90bind &amp;&amp;
ln -s  /etc/rc.d/init.d/bind /etc/rc.d/rc3.d/S90bind &amp;&amp;
ln -s  /etc/rc.d/init.d/bind /etc/rc.d/rc4.d/S90bind &amp;&amp;
ln -s  /etc/rc.d/init.d/bind /etc/rc.d/rc5.d/S90bind &amp;&amp;
ln -s  /etc/rc.d/init.d/bind /etc/rc.d/rc6.d/K90bind
</userinput></screen></para>

<para>Alors, lancez BIND avec le nouveau script de démarrage: </para>
<para><screen><userinput>
/etc/rc.d/init.d/bind start
</userinput></screen></para></sect3>

<sect3><title>Tester BIND</title>
<para>Testez la nouvelle installation de BIND 9. Tout d'abord, recherchez
l'adresse locale de l'hote avec dig:</para>
<para><screen><userinput>
dig -x 127.0.0.1
</userinput></screen></para>
<para>Maintenant, essayez la recherche de noms externes, en prenant note de la
différence de vitesse dans des recherches répétées grace au cache. Lancez la
commande dig deux fois sur la meme adresse:</para>
<para><screen><userinput>
dig beyond.linuxfromscratch.org &amp;&amp;
dig beyond.linuxfromscratch.org
</userinput></screen>
Vous pouvez voir des résultats pratiquement instantanés avec des recherches
cachées de named. Consultez bind-&bind-version;/doc/arm/Bv9ARM.html, le manuel
de référence de l'administrateur de BIND pour plus d'options de configurations.
</para></sect3>
</sect2>

