<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
    <title>
      Lancer un serveur Git
    </title>
    <link rel="stylesheet" type="text/css" href="../stylesheets/lfs.css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.1" />
    <link rel="stylesheet" href="../stylesheets/lfs-print.css" type=
    "text/css" media="print" />
  </head>
  <body class="blfs" id="blfs-r10.1-914+">
    <div class="navheader">
      <h4>
        Au-delà de Linux<sup>®</sup> From Scratch (édition <span class=
        "phrase">systemd)</span> - Version r10.1-914+
      </h4>
      <h3>
        Chapitre&nbsp;13.&nbsp;Programmation
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="git.html" title="Git-2.33.0">Précédent</a>
          <p>
            Git-2.33.0
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="guile.html" title="Guile-3.0.7">Suivant</a>
          <p>
            Guile-3.0.7
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="prog.html" title=
          "Chapitre&nbsp;13.&nbsp;Programmation">Niveau supérieur</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Au-delà de Linux® From Scratch (édition systemd) - Version r10.1-914+">
          Sommaire</a>
        </li>
      </ul>
    </div>
    <div class="sect1" lang="fr" xml:lang="fr">
      <h1 class="sect1">
        <a id="gitserver" name="gitserver"></a>Lancer un serveur Git
      </h1>
      <div class="package" lang="fr" xml:lang="fr">
        <h2 class="sect2">
          Introduction
        </h2>
        <p>
          Cette section décrit comment mettre en place, administrer et
          sécuriser un serveur <span class="application">git</span>.
          <span class="application">Git</span> a de nombreuses options
          disponibles. Pour la documentation détaillée voir <a class="ulink"
          href=
          "https://git-scm.com/book/en/v2">https://git-scm.com/book/en/v2</a>.
        </p>
        <h3>
          Dépendances de Server
        </h3>
        <h4>
          Requises
        </h4>
        <p class="required">
          <a class="xref" href="git.html" title="Git-2.33.0">git-2.33.0</a>
          et <a class="xref" href="../postlfs/openssh.html" title=
          "OpenSSH-8.7p1">OpenSSH-8.7p1</a>
        </p>
      </div>
      <div class="configuration" lang="fr" xml:lang="fr">
        <h2 class="sect2">
          Paramétrer un serveur Git
        </h2>
        <p>
          Les instructions suivantes installeront un serveur <span class=
          "application">git</span>. Il sera paramétré pour utiliser
          <span class="application">OpenSSH</span> comme méthode d'accès à
          distance sécurisée.
        </p>
        <p>
          La configuration du serveur comporte les étapes suivantes&nbsp;:
        </p>
        <div class="sect3">
          <h3 class="sect3">
            1. Mise en place des utilisateurs, des groupes et des permissions
          </h3>
          <p>
            Vous devrez être utilisateur <code class="systemitem">root</code>
            pour la première partie de la configuration. Créez l'utilisateur
            et le groupe <code class="systemitem">git</code> et indiquez un
            hash de mot de passe inutilisable avec les commandes
            suivantes&nbsp;:
          </p>
          <pre class="root"><kbd class=
          "command">groupadd -g 58 git &amp;&amp;
useradd -c "git Owner" -d /home/git -m -g git -s /usr/bin/git-shell -u 58 git &amp;&amp;
sed -i '/^git:/s/^git:[^:]:/git:NP:/' /etc/shadow</kbd></pre>
          <p>
            Enregistrer un hash de mot de passe inutilisable (en remplaçant
            le <code class="literal">!</code> par <code class=
            "literal">NP</code>) déverrouille le compte mais empêche de
            l'utiliser avec un mot de passe. Cela est requis par <span class=
            "application">sshd</span> pour fonctionner correctement. Ensuite,
            créez certains fichiers et répertoires dans le répertoire
            personnel de l'utilisateur git qui permettent de donner accès aux
            dépôts git avec des clés ssh.
          </p>
          <pre class="root"><kbd class=
          "command">install -o git -g git -dm0700 /home/git/.ssh &amp;&amp;
install -o git -g git -m0600 /dev/null /home/git/.ssh/authorized_keys</kbd></pre>
          <p>
            Pour les développeurs qui doivent accéder au dépôt, ajoutez sa
            clé publique ssh à <code class=
            "filename">/home/git/.ssh/authorized_keys</code>. Commencez par
            ajouter certaines options pour éviter que les utilisateurs ne
            puissent utiliser la connexion à git pour rediriger des ports
            vers d'autres machines que le serveur git peut atteindre.
          </p>
          <pre class="userinput"><kbd class=
          "command">echo -n "no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty " &gt;&gt; /home/git/.ssh/authorized_keys &amp;&amp;
cat &lt;user-ssh-key&gt; &gt;&gt; /home/git/.ssh/authorized_keys</kbd></pre>
          <p>
            C'est aussi utile d'indiquer le nom par défaut de la branche
            initiale d'un nouveau dépôt en modifiant la configuration git. En
            tant qu'utilisateur <code class="systemitem">root</code>,
            lancez&nbsp;:
          </p>
          <pre class="userinput"><kbd class=
          "command">git config --system init.defaultBranch trunk</kbd></pre>
          <p>
            Enfin, ajoutez l'entrée <code class=
            "filename">/usr/bin/git-shell</code> au fichier de configuration
            <code class="filename">/etc/shells</code>. Ce shell a été indiqué
            dans le profil utilisateur de <code class="systemitem">git</code>
            et s'assure que seules les actions liées à git peuvent être
            exécutées&nbsp;:
          </p>
          <pre class="root"><kbd class=
          "command">echo "/usr/bin/git-shell" &gt;&gt; /etc/shells</kbd></pre>
        </div>
        <div class="sect3">
          <h3 class="sect3">
            2. Créer un dépôt git
          </h3>
          <p>
            Le dépôt peut être n'importe où sur le système de fichiers. Il
            est important que l'utilisateur git puisse lire et écrire à cet
            emplacement. Nous utilisons <code class=
            "filename">/srv/git</code> comme répertoire de base. Créez un
            nouveau dépôt <span class="application">git</span> avec les
            commandes suivante (en tant qu'utilisateur <code class=
            "systemitem">root</code>)&nbsp;:
          </p>
          <div class="admon note">
            <img alt="[Note]" src="../images/note.png" />
            <h3>
              Note
            </h3>
            <p>
              Dans les instructions ci-dessous, nous utilisons <span class=
              "emphasis"><em>project1</em></span> comme nom de dépôt. Vous
              devriez nommer votre dépôt en fonction des détails de votre
              projet.
            </p>
          </div>
          <pre class="root"><kbd class=
          "command">install -o git -g git -m755 -d /srv/git/project1.git &amp;&amp;
cd /srv/git/project1.git                             &amp;&amp;
git init --bare                                      &amp;&amp;
chown -R git:git .</kbd></pre>
        </div>
        <div class="sect3">
          <h3 class="sect3">
            3. Remplissez le dépôt à partir du système client
          </h3>
          <div class="admon note">
            <img alt="[Note]" src="../images/note.png" />
            <h3>
              Note
            </h3>
            <p>
              Toutes les instructions de cette section et de la suivante
              devraient être lancées sur un système utilisateur, pas sur le
              système serveur.
            </p>
          </div>
          <p>
            Maintenant que le dépôt est créé, il peut être utilisé par les
            développeurs pour y mettre des fichiers. Une fois les clés ssh
            des utilisateurs importées dans le fichier <code class=
            "filename">authorized_keys</code> de git, on peut interagir avec
            le dépôt.
          </p>
          <p>
            Une configuration minimale devrait être disponible sur le système
            du développeur pour spécifier son nom d'utilisateur et l'adresse
            de courriel. Créez ce fichier de configuration minimal côté
            client&nbsp;:
          </p>
          <pre class="userinput"><kbd class=
          "command">cat &gt; ~/.gitconfig &lt;&lt;EOF
[user]
        name = &lt;users-name&gt;
        email = &lt;users-email-address&gt;
EOF</kbd></pre>
          <p>
            Sur la machine du développeur, configurez certains fichiers à
            pousser vers le dépôt comme contenu initial&nbsp;:
          </p>
          <div class="admon note">
            <img alt="[Note]" src="../images/note.png" />
            <h3>
              Note
            </h3>
            <p>
              Le terme <span class="emphasis"><em>gitserver</em></span>
              utilisé ci-dessous devrait être le nom d'hôte (ou l'adresse IP)
              du serveur git.
            </p>
          </div>
          <pre class="userinput"><kbd class="command">mkdir myproject
cd myproject
git init --initial-branch=trunk
git remote add origin git@gitserver:/srv/git/project1.git
cat &gt;README &lt;&lt;EOF
This is the README file
EOF
git add README
git commit -m 'Initial creation of README'
git push --set-upstream origin trunk</kbd></pre>
          <p>
            Le contenu initial est maintenant poussé sur le serveur et est
            disponible pour les autres utilisateurs. Sur la machine actuelle,
            l'argument <code class="literal">--set-upstream origin
            trunk</code> n'est maintenant plus requis car le dépôt local est
            maintenant connecté au dépôt distant. Les poussages suivants
            peuvent se faire avec
          </p>
          <pre class="userinput"><kbd class="command">git push</kbd></pre>
          <p>
            Les autres développeurs peuvent maintenant cloner le dépôt et
            faire des modifications sur le contenu (tant que leurs clés ssh
            ont été installées)&nbsp;:
          </p>
          <pre class="userinput"><kbd class=
          "command">git clone git@gitserver:/srv/git/project1.git
cd project1
vi README
git commit -am 'Fix for README file'
git push</kbd></pre>
          <div class="admon note">
            <img alt="[Note]" src="../images/note.png" />
            <h3>
              Note
            </h3>
            <p>
              C'est une configuration du serveur très basique basée sur
              l'accès <span class="application">OpenSSH</span>. Tous les
              développeurs utilisent l'utilisateur <code class=
              "systemitem">git</code> pour effectuer les actions sur le dépôt
              et les changements commités par les utilisateurs se distinguent
              par le nom d'utilisateur local (voir <code class=
              "filename">~/.gitconfig</code>) enregistré dans les
              changements.
            </p>
          </div>
          <p>
            L'accès est restreint aux clés publique ajoutées dans le fichier
            <code class="filename">authorized_keys</code> de git et il n'y a
            pas de possibilité pour l'export / clonage public du dépôt. Pour
            cela, continuez à l'étape 4 pour configurer le serveur git pour
            l'accès public en lecture seule.
          </p>
          <p>
            Dans l'URL utilisée pour cloner le projet, le chemin absolu (ici
            <code class="filename">/srv/git/project1.git</code>) a été
            spécifié car le dépôt n'est pas dans le répertoire personnel de
            git mais dans <code class="filename">/srv/git</code>. Pour ne pas
            avoir à exposer la structure de l'installation du serveur, vous
            pouvez ajouter un lien symbolique dans le répertoire personnel de
            git pour chaque projet, comme ceci&nbsp;:
          </p>
          <pre class="userinput"><kbd class=
          "command">ln -svf /srv/git/project1.git /home/git/</kbd></pre>
          <p>
            Maintenant, le dépôt peut être cloné avec
          </p>
          <pre class="userinput"><kbd class=
          "command">git clone git@gitserver:project1.git</kbd></pre>
        </div>
        <div class="sect3">
          <h3 class="sect3">
            <a id="gitserver-init" name="gitserver-init"></a>4. Configurer le
            serveur
          </h3>
          <p>
            La configuration décrite plus haut rend le dépôt disponible pour
            les utilisateurs authentifiés (en fournissant la clé ssh
            publique). Il y a aussi un moyen simple de publier le dépôt pour
            des utilisateurs non authentifiés — évidemment sans l'accès en
            écriture.
          </p>
          <p>
            La combinaison de l'accès via ssh (pour les utilisateurs
            authentifiés) et l'export des dépôt pour les utilisateurs non
            authentifiés via le démon est en général suffisant pour un site
            de développement.
          </p>
          <div class="admon note">
            <img alt="[Note]" src="../images/note.png" />
            <h3>
              Note
            </h3>
            <p>
              Le démon sera atteignable sur le port <code class=
              "literal">9418</code> par défaut. Assurez-vous que votre
              pare-feu permet l'accès à ce port.
            </p>
          </div>
          <p>
            Pour démarrer le serveur au démarrage, installez l'unité
            <code class="filename">git-daemon.service</code> du paquet
            <a class="xref" href="../introduction/systemd-units.html" title=
            "Unités Systemd de BLFS">blfs-systemd-units-20210819</a>&nbsp;:
          </p>
          <pre class="root"><kbd class=
          "command">make install-git-daemon</kbd></pre>
          <p>
            Pour permettre à <span class="application">git</span> d'exporter
            un dépôt, un fichier nommé <code class=
            "filename">git-daemon-export-ok</code> est requis dans chaque
            répertoire de dépôt sur le serveur. Le fichier n'a pas besoin de
            contenu, son existence suffit à activer et son absence à
            désactiver l'export du dépôt.
          </p>
          <pre class="root"><kbd class=
          "command">touch /srv/git/project1.git/git-daemon-export-ok</kbd></pre>
          <p>
            En plus de l'unité <code class=
            "filename">git-daemon.service</code>, un fichier de configuration
            nommé <code class="filename">/etc/default/git-daemon</code> a été
            installé. Voyez ce fichier de configuration et faite-le
            correspondre à vos besoins.
          </p>
          <p>
            Il n'y a que trois options à indiquer dans le fichier de
            configuration&nbsp;:
          </p>
          <div class="itemizedlist">
            <ul>
              <li class="listitem">
                <p>
                  GIT_BASE_DIR=&lt;dirname&gt;
                </p>
                <p>
                  Spécifiez l'emplacement des dépôts git. Les chemins
                  relatifs utilisés pour accéder au démon seront traduits par
                  rapport à ce répertoire.
                </p>
              </li>
              <li class="listitem">
                <p>
                  DFT_REPO_DIR=&lt;dirname&gt;
                </p>
                <p>
                  Ce répertoire est ajouté à la liste blanche des répertoires
                  autorisés. Cette variable peut contenir plusieurs noms de
                  répertoires mais elle est habituellement égale à
                  <code class="literal">GIT_BASE_DIR</code>.
                </p>
              </li>
              <li class="listitem">
                <p>
                  GIT_DAEMON_OPTS=&lt;options&gt;
                </p>
                <p>
                  Au cas où vous ayez besoin d'options spéciales pour la
                  commande <span class="command"><strong>git
                  daemon</strong></span>, vous pouvez les spécifier dans ce
                  paramètre. Un exemple peut être pour ajuster le numéro de
                  port sur lequel le démon écoute. Dans ce cas, ajoutez
                  <code class="literal">--port=&lt;port number&gt;</code> à
                  cette variable. Pour plus d'information sur les options à
                  indiquer, voyez la sortie de <span class=
                  "command"><strong>git daemon --help</strong></span>.
                </p>
              </li>
            </ul>
          </div>
          <p>
            Après avoir démarré le démon, les utilisateurs non authentifiés
            peuvent cloner les dépôts exportés en utilisant
          </p>
          <pre class="userinput"><kbd class=
          "command">git clone git://gitserver/project1.git</kbd></pre>
          <p>
            Comme le répertoire de bsae est <code class=
            "filename">/srv/git</code> par défaut (ou une valeur
            personnalisée dans la configuration), <span class=
            "application">git</span> interprète les chemins (/project1.git)
            relativement au répertoire de base, si bien que c'est le dépôt
            dans <code class="filename">/srv/git/project1.git</code> qui est
            servi.
          </p>
        </div>
      </div>
      <p class="updated">
        Last updated on
      </p>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="git.html" title="Git-2.33.0">Précédent</a>
          <p>
            Git-2.33.0
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="guile.html" title="Guile-3.0.7">Suivant</a>
          <p>
            Guile-3.0.7
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="prog.html" title=
          "Chapitre&nbsp;13.&nbsp;Programmation">Niveau supérieur</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Au-delà de Linux® From Scratch (édition systemd) - Version r10.1-914+">
          Sommaire</a>
        </li>
      </ul>
    </div>
  </body>
</html>
