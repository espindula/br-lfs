<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../../general.ent">
  %general-entities;

  <!ENTITY fop-download-http "https://archive.apache.org/dist/xmlgraphics/fop/source/fop-&fop-version;-src.tar.gz">
  <!ENTITY fop-download-ftp  "">
  <!ENTITY fop-md5sum        "610bfd7797755d744b2c4f61422478cf">
  <!ENTITY fop-size          "22&nbsp;Mo">
  <!ENTITY fop-buildsize     "517&nbsp;Mo (dont les fichiers téléchargés dans le répertoire personnel de
l'utilisateur qui construit)">
  <!ENTITY fop-time          "0,6&nbsp;SBU">

  <!ENTITY pdfbox-version    "2.0.27">
  <!ENTITY pdfbox-download   "https://archive.apache.org/dist/pdfbox/&pdfbox-version;/pdfbox-&pdfbox-version;.jar">
  <!ENTITY pdfbox-md5sum     "ddd46402b1692eed9e5c73b4a94c45d8">
  <!ENTITY pdfbox-size       "2.7&nbsp;Mo">

  <!ENTITY fontbox-download  "https://archive.apache.org/dist/pdfbox/&pdfbox-version;/fontbox-&pdfbox-version;.jar">
  <!ENTITY fontbox-md5sum    "587744efe2a82d3584c2f3969fa4dca0">
  <!ENTITY fontbox-size      "1.5 Mo">

  <!ENTITY maven-major        "3">
  <!ENTITY maven-version      "3.8.6">
  <!ENTITY maven-download     "https://archive.apache.org/dist/maven/maven-&maven-major;/&maven-version;/binaries/apache-maven-&maven-version;-bin.tar.gz">
  <!ENTITY maven-md5sum       "0e07de4a7b5c84ebed737a2002f52019">
  <!ENTITY maven-size         "8,3&nbsp;Mo (en plus, environ 90&nbsp;Mo sont téléchargés das le répertoire
personnel de l'utilisateur qui construit)">

  <!ENTITY offo-download     "&sourceforge-dl;/offo/2.2/offo-hyphenation.zip">
  <!ENTITY offo-md5sum       "bf9c09bf05108ef9661b8f08d91c2336">
  <!ENTITY offo-size         "862 Ko">
]>

<sect1 id="fop" xreflabel="fop-&fop-version;">
  <?dbhtml filename="fop.html"?>


  <title>fop-&fop-version;</title>

  <indexterm zone="fop">
    <primary sortas="a-fop">fop</primary>
  </indexterm>

  <sect2 role="package">
    <title>Introduction à fop</title>

    <para>
      Le paquet <application>FOP</application> (Formatting Objects Processor)
contient un formateur d'impression guidé par les objets de formatage XSL
(XSL-FO). C'est une application <application>Java</application> qui lit une
arborescence d'objets de formatage et qui produit les pages qui en résultent
vers une sortie spécifique. Les formats de sortie actuellement supportés
comprennent le PDF, PCL, PostScript, SVG, XML (représentation en
arborescence de zone), print, AWT, MIF et le texte ASCII. La cible de sortie
principale est le PDF.
    </para>

    &lfs113_checked;

    <bridgehead renderas="sect3">Informations sur le paquet</bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>
          Téléchargement (HTTP)&nbsp;: <ulink url="&fop-download-http;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Téléchargement (FTP)&nbsp;: <ulink url="&fop-download-ftp;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Somme de contrôle MD5&nbsp;: &fop-md5sum;
        </para>
      </listitem>
      <listitem>
        <para>
          Taille du téléchargement&nbsp;: &fop-size;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation de l'espace disque requis&nbsp;: &fop-buildsize;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation du temps de construction&nbsp;: &fop-time;
        </para>
      </listitem>
    </itemizedlist>

    <bridgehead renderas="sect3">Téléchargements supplémentaires</bridgehead>
    <itemizedlist spacing="compact">
      <title>Téléchargements supplémentaires requis&nbsp;:</title>
      <listitem>
        <para>
          PDFBox&nbsp;: <simplelist> <member><ulink url="&pdfbox-download;"/></member>
<member>&pdfbox-md5sum;</member> <member>&pdfbox-size;</member>
</simplelist>
        </para>
      </listitem>
      <listitem>
        <para>
          Polices PDFBox&nbsp;: <simplelist> <member><ulink
url="&fontbox-download;"/></member> <member>&fontbox-md5sum;</member>
<member>&fontbox-size;</member> </simplelist>
        </para>
      </listitem>
      <listitem>
        <para>
          Système de construction Maven&nbsp;: <simplelist> <member><ulink
url="&maven-download;"/></member> <member>&maven-md5sum;</member>
<member>&maven-size;</member> </simplelist>
        </para>
      </listitem>
    </itemizedlist>

    <!-- Using the archive above allows finding all versions
    <note>
<para>
      The pdfbox and fontbox packages may not be available at the above
      location.  If not, they can be found at the BLFS files mirror sites.
    </para></note>
-->
<itemizedlist spacing="compact">
      <title>Paquets recommandés</title>
      <listitem>
        <para>
          Les patrons de césure OFFO (Objets pour formater des objets)&nbsp;:
<simplelist> <member><ulink url="&offo-download;"/></member>
<member>&offo-md5sum;</member> <member>&offo-size;</member> </simplelist>
        </para>
      </listitem>
    </itemizedlist>

    <bridgehead renderas="sect3">Dépendances de fop</bridgehead>

    <bridgehead renderas="sect4">Requises</bridgehead>
    <para role="required">
      <xref linkend="apache-ant"/>
    </para>

    <bridgehead renderas="sect4">Facultatives</bridgehead>
    <para role="optional">

      <!-- Included into ant      <xref linkend="junit"/>
 (to run tests),-->
<!--      <xref linkend="maven"/>
 (an alternate build system), not functional
      with fop-2.3          -->
<!-- [pierre 2017-04-29] Note to devs: there are a lot of bundled dependencies.
     Some were listed here, but not all. I am not sure it is possible to
     use system ones. So, I have removed them, and kept only those which
     are not bundled. -->
<xref linkend="x-window-system"/> (pour lancer les tests), <ulink
url="https://jai-tools.blogspot.com/">JAI Image I/O Tools</ulink> et <ulink
url="https://jeuclid.sourceforge.net/">JEuclid</ulink>

    </para>

    <para condition="html" role="usernotes">Notes utilisateur&nbsp;: <ulink url="&blfs-wiki;/fop"/></para>

  </sect2>

  <sect2 role="installation">
    <title>Installation de fop</title>

    <para>
      Assurez-vous que <envar>$JAVA_HOME</envar> est correctement paramétré avant
de commencer la construction. Pour construire les classes d'extension
<application>JIMI SDK</application> et <application>XMLUnit</application>,
assurez-vous que les fichiers <filename class='extension'>.jar</filename>
correspondants peuvent être trouvés par la variable d'environnement
<envar>CLASSPATH</envar>.
    </para>

    <sect3>
      <title>Installation des patrons de césure OFFO</title>

      <para>
        Copiez les patrons de césure XML dans l'arborescence des sources de fop en
exécutant les commandes suivantes&nbsp;:
      </para>

<screen><userinput>unzip ../offo-hyphenation.zip &amp;&amp;
cp offo-hyphenation/hyph/* fop/hyph &amp;&amp;
rm -rf offo-hyphenation</userinput></screen>

    </sect3>

    <sect3>
      <title>Installer un binaire Maven temporaire</title>

      <para>
        À partir de fop-2.5, le système de construction Maven est requis. Nous
utilisons le binaire fournit par apache, que nous installons à un
emplacement temporaire&nbsp;:
      </para>

<screen><userinput>tar -xf ../apache-maven-&maven-version;-bin.tar.gz -C /tmp</userinput></screen>

    </sect3>

    <sect3>
      <title>Installer les composants fop</title>

      <para>
        La commande <command>javadoc</command> venant avec OpenJDK 10 et suivants
est devenue plus stricte qu'avant à propos de la conformité des commentaires
javadoc dans le code source vers l'HTML. La documentation de FOP ne respecte
pas ces standards, aussi les tests de conformité ont été désactivés. Cela
peut être fait avec la commande suivante&nbsp;:
      </para>

<!-- Seems to have been fixed in 2.6
      <para>

        The stack size set in <filename>build.xml</filename> for building the
        hyphenation patterns is not large enough. Change it by running:
      </para>

<screen><userinput>sed -e '/hyph\.stack/s/512k/1M/' \
    -i fop/build.xml</userinput></screen>
fixed with maven-3.8.4
      <para>
        Fix building with JDK-16 due to an outdated Apache Maven plugin:
      </para>

<screen><userinput remap="pre">sed -i 's/&lt;war.plugin.version&gt;2.2/&lt;war.plugin.version&gt;3.3.1/' pom.xml</userinput></screen>
-->
<screen><userinput>sed -i '\@&lt;/javad@i\
&lt;arg value="-Xdoclint:none"/&gt;\
&lt;arg value="--allow-script-in-comments"/&gt;\
&lt;arg value="--ignore-source-errors"/&gt;' \
    fop/build.xml</userinput></screen>

      <para>
        Le fichier <filename>build.xml</filename> appelle une ancienne version des
composants <application>PDFBox</application> qui ne sont plus
disponibles. Copiez les composants PDFBox récents dans l'arborescence des
sources&nbsp;:
      </para>

<screen><userinput>cp ../{pdf,font}box-&pdfbox-version;.jar fop/lib</userinput></screen>

      <para>
        Compilez <application>fop</application> en exécutant les commandes
suivantes&nbsp;:
      </para>

<screen><userinput>cd fop &amp;&amp;

LC_ALL=en_US.UTF-8                     \
PATH=$PATH:/tmp/apache-maven-&maven-version;/bin \
ant all javadocs &amp;&amp;

mv build/javadocs .</userinput></screen>

      <para>
        Ce paquet possède une suite de tests, mais l'infrastructure java installée
dans ce livre ne permet pas de la lancer.
      </para>

      <para>
        Maintenant, installez <application>Fop</application> en tant qu'utilisateur
<systemitem class="username">root</systemitem>&nbsp;:
      </para>

<screen role="root"><userinput>install -v -d -m755 -o root -g root          /opt/fop-&fop-version; &amp;&amp;
cp -vR build conf examples fop* javadocs lib /opt/fop-&fop-version; &amp;&amp;
chmod a+x /opt/fop-&fop-version;/fop                                &amp;&amp;
ln -v -sfn fop-&fop-version; /opt/fop</userinput></screen>

      <para>
        Il reste à nettoyer ce que nous avons fait&nbsp;:
      </para>

<screen><userinput>rm -rf /tmp/apache-maven-&maven-version;</userinput></screen>

    </sect3>

  </sect2>

  <sect2 role="commands">
    <title>Explication des commandes</title>

    <para>
      <command>sed -i ... build.xml</command>&nbsp;: cela ajoute trois paramètres
à la commande <command>javadoc</command>, empêchant certaines erreurs de se
produire en construisant la documentation.
    </para>

    <para>
      <command>export LC_ALL=en_US.UTF-8</command>&nbsp;: le compilateur échoue si
vous utilisez une locale ASCII.
    </para>

    <para>
      <command>ant <option>target</option></command>&nbsp;: Ceci lit le fichier
<filename>build.xml</filename> et construit la cible&nbsp;:
<option>compile</option> compile les sources java, <option>jar-main</option>
génère les archives jar, <option>jar-hyphenation</option> génère les patrons
de césure pour FOP, <option>junit</option> lance les tests
<application>junit</application> et <option>javadocs</option> construit la
documentation. La cible <option>all</option> lance toutes les cibles
précédentes.
    </para>

    <para>
      <command>ln -v -sf fop-&fop-version; /opt/fop</command>&nbsp;: Ceci est
facultatif et crée un lien symbolique pratique pour que
<envar>$FOP_HOME</envar> n'ait pas besoin d'être changé à chaque changement
de version du paquet.
    </para>

  </sect2>

  <sect2 role="configuration">
    <title>Configuration de fop</title>

    <sect3 id="fop-config">
      <title>Fichiers de configuration</title>

      <para>
        <filename>~/.foprc</filename>
      </para>

      <indexterm zone="fop fop-config">
        <primary sortas="e-AA.foprc">~/.foprc</primary>
      </indexterm>

    </sect3>

    <sect3>
      <title>Informations sur la configuration</title>

      <para>
        Utiliser <application>fop</application> pour traiter de gros FO (dont les FO
dérivés des sources XML de LFS) peut conduire à des erreurs de mémoire. À
moins d'ajouter un paramètre à la commande <command>java</command> utilisée
dans le script <command>fop</command> vous pouvez obtenir des messages
similaires à ceci&nbsp;:
      </para>

      <para>
        <computeroutput> Exception in thread "main" java.lang.OutOfMemoryError: Java
heap space </computeroutput>
      </para>

      <para>
        Pour éviter de telles erreurs, vous devez passer un argument supplémentaire
à la commande <command>java</command> utilisée dans le script
<command>fop</command>. Ceci peut se faire en créant un fichier
<filename>~/.foprc</filename> (qui est sourcé par le script
<command>fop</command>) et en ajoutant le paramètre à la variable
d'environnement <envar>FOP_OPTS</envar>.
      </para>

      <para>
        Le script <command>fop</command> cherche une variable d'environnement
<envar>FOP_HOME</envar> pour localiser les bibliothèques de classe
<application>fop</application>. Vous pouvez créer cette variable en
utilisant le fichier <filename>~/.foprc</filename> aussi. Créez un fichier
<filename>~/.foprc</filename> avec les commandes suivantes&nbsp;:
      </para>

<screen><userinput>cat &gt; ~/.foprc &lt;&lt; "EOF"
<literal>FOP_OPTS="-Xmx<replaceable>&lt;RAM_Installed&gt;</replaceable>m"
FOP_HOME="/opt/fop"</literal>
EOF</userinput></screen>

      <para>
        <!--  the URL is broken
        For more information about
        memory issues running <application>
fop</application>, see
        <ulink url="http://xml.apache.org/fop/running.html#memory"/>.
        -->
Remplacez <replaceable>&lt;RAM_Installed&gt;</replaceable> avec un nombre
représentant la quantité de RAM installée dans votre ordinateur (en
mégaoctets). Par exemple, <userinput>FOP_OPTS="-Xmx768m"</userinput>.
        
      </para>

      <para>
        Pour inclure le script <command>fop</command> dans votre path, mettez à jour
le profil système avec la commande suivante en tant qu'utilisateur
<systemitem class="username">root</systemitem>&nbsp;:
      </para>

<screen role="root"><userinput>cat &gt; /etc/profile.d/fop.sh &lt;&lt; "EOF"
<literal># Begin /etc/profile.d/fop.sh

pathappend /opt/fop

# End /etc/profile.d/fop.sh</literal>
EOF</userinput></screen>

      <note>
        <para>
          L'exécution de <command>fop</command> peut être assez verbeuse. Par défaut
le niveau de journalisation est INFO et peut être changé en FINEST, FINER,
FINE, CONFIG, INFO, WARNING, SEVERE, ALL ou OFF. Pour ce faire, éditez
<filename>$JAVA_HOME/jre/lib/logging.properties</filename> et changez les
entrées pour <option>.leval</option> et
<option>java.util.logging.ConsoleHandler.level</option> à la valeur désirée.
        </para>
      </note>

    </sect3>

  </sect2>

  <sect2 role="content">
    <title>Contenu</title>

    <segmentedlist>
      <segtitle>Programmes installés</segtitle>
      <segtitle>Bibliothèques installées</segtitle>
      <segtitle>Répertoire installé</segtitle>

      <seglistitem>
        <seg>fop</seg>
        <seg>fop.jar et de nombreuses bibliothèques support de classes situées dans
<filename class='directory'>/opt/fop/{build,lib}</filename>&nbsp;; Les
composants JAI contiennent libmlib_jai.so, jai_codec.jar, jai_core.jar et
mlibwrapper_jai.jar</seg>
        <seg>/opt/fop-&fop-version;</seg>
      </seglistitem>
    </segmentedlist>

    <variablelist>
      <bridgehead renderas="sect3">Descriptions courtes</bridgehead>
      <?dbfo list-presentation="list"?> <?dbhtml list-presentation="table"?>

      <varlistentry id="fop-prog">
        <term><command>fop</command></term>
        <listitem>
          <para>
            est un script enveloppe pour la commande <command>java</command> qui
initialise l'environnement <application>fop</application> et passe les
paramètres requis
          </para>
          <indexterm zone="fop fop-prog">
            <primary sortas="b-fop">fop</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="fop.jar">
        <term><filename class="libraryfile">fop.jar</filename></term>
        <listitem>
          <para>
            contient toutes les classes <application>Java</application> de
<application>fop</application>
          </para>
          <indexterm zone="fop fop.jar">
            <primary sortas="c-fop.jar">fop.jar</primary>
          </indexterm>
        </listitem>
      </varlistentry>

    </variablelist>

  </sect2>

</sect1>
