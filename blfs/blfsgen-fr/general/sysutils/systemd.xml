<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../../general.ent">
  %general-entities;

  <!--  <!ENTITY systemd-download-http "http://anduin.linuxfromscratch.org/LFS/systemd-&systemd-version;-&systemd-stable;.tar.xz"> For whenever we move to a stable snapshot for backports -->
  <!ENTITY systemd-download-http "https://github.com/systemd/systemd/archive/v&systemd-version;/systemd-&systemd-version;.tar.gz">
  <!ENTITY systemd-download-ftp  "">
  <!ENTITY systemd-md5sum        "8e8adf909c255914dfc10709bd372e69">
  <!ENTITY systemd-size          "10&nbsp;Mo">
  <!ENTITY systemd-buildsize     "287&nbsp;Mo (avec les tests)">
  <!ENTITY systemd-time          "2.5&nbsp;SBU (avec les tests)">

]>

<sect1 id="systemd" xreflabel="Systemd-&systemd-version;" revision="systemd">
  <?dbhtml filename="systemd.html"?>

  <sect1info>
<date>$Date$</date></sect1info>

  <title>Systemd-&systemd-version;</title>
  

  <indexterm zone="systemd">
    <!-- Whenever we switch back to stable backports, make sure to add the systemd-stable reference back. -->
<primary sortas="a-systemd">systemd</primary>
  </indexterm>

  <sect2 role="package">
    <title>Introduction à systemd</title>

    <para>
      Alors que <application>systemd</application> a été installé avec LFS, il y a
plein de fonctionnalités fournies par le paquet qui n'ont pas été inculeses
dans l'installation initiale car <application>Linux-PAM</application>
n'était pas installé. Le paquet <application>systemd</application> doit être
reconstruit pour fournir un service <command>systemd-logind</command>
fonctionnel, qui fourint plein de fonctionnalités supplémentaires pour les
paquets qui en dépendent.
    </para>
    
    &lfs110a_checked;

    <bridgehead renderas="sect3">Informations sur le paquet</bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>
          Téléchargement (HTTP)&nbsp;: <ulink url="&systemd-download-http;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Téléchargement (FTP)&nbsp;: <ulink url="&systemd-download-ftp;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Somme de contrôle MD5 du téléchargement&nbsp;: &systemd-md5sum;
        </para>
      </listitem>
      <listitem>
        <para>
          Taille du téléchargement&nbsp;: &systemd-size;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation de l'espace disque requis&nbsp;: &systemd-buildsize;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation du temps de construction&nbsp;: &systemd-time;
        </para>
      </listitem>
    </itemizedlist>

    <bridgehead renderas="sect3">Téléchargements supplémentaires</bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>
         Correctif requis&nbsp;: <ulink
url="&patch-root;/systemd-&systemd-version;-upstream_fixes-1.patch"/>
        </para>
      </listitem>
    </itemizedlist>

    <bridgehead renderas="sect3">Dépendances de systemd</bridgehead>

    <bridgehead renderas="sect4">Requises</bridgehead>
    <para role="required">
      <xref linkend="Jinja2"/> et <xref linkend="linux-pam"/>
    </para>

    <bridgehead renderas="sect4">Dépendances de Recommended Runtime</bridgehead>
    <para role="recommended">
      <xref role="runtime" linkend="polkit"/> 
    </para>

    <bridgehead renderas="sect4">Facultatives</bridgehead>
    <para role="optional">
      <!-- homed may support it, see the C.E.-->
<!--<ulink url="http://fukuchi.org/works/qrencode/">
qrencode</ulink>,-->
<xref linkend="btrfs-progs"/>, <xref linkend="curl"/>, <xref
linkend="cryptsetup"/>, <xref linkend="git"/>, <xref linkend="gnutls"/>,
<xref linkend="iptables"/>, <xref linkend="libgcrypt"/>, <xref
linkend="libidn2"/>, <xref linkend="libpwquality"/>, <xref
linkend="libseccomp"/>, <xref linkend="libxkbcommon"/>, <xref
linkend="make-ca"/>, <xref linkend="p11-kit"/>, <xref linkend="pcre2"/>,
<xref linkend="qemu"/>, <xref linkend="qrencode"/>, <xref linkend="rsync"/>,
<xref linkend="valgrind"/>, <xref linkend="zsh"/> (pour les complétions
zsh), <ulink
url="https://sourceforge.net/projects/gnu-efi/">gnu-efi</ulink>, <ulink
url="https://www.kernel.org/pub/linux/utils/kernel/kexec/">kexec-tools</ulink>,
<ulink url="https://sourceware.org/elfutils/">libdw</ulink>, <ulink
url="https://developers.yubico.com/libfido2/">libfido2</ulink>, <ulink
url="https://www.gnu.org/software/libmicrohttpd/">libmicrohttpd</ulink>,
<ulink url="http://lz4.github.io/lz4/">lz4</ulink>, <ulink
url="https://sourceforge.net/projects/linuxquota/">quota-tools</ulink>,
<ulink url="https://pypi.python.org/pypi/Sphinx">Sphinx</ulink> et <ulink
url="https://tpm2-tss.readthedocs.io/en/latest/">tpm2-tss</ulink>
    </para>

    <bridgehead renderas="sect4">Facultatives (pour reconstruire les pages de manuel)</bridgehead>
    <para role="optional">
      <xref linkend="DocBook"/>, <xref linkend="docbook-xsl"/>, <xref
linkend="libxslt"/> et <xref linkend="lxml"/> (pour contstruire l'index des
pages de manuel de systemd)
    </para>

    <para condition="html" role="usernotes">Notes utilisateur&nbsp;: <ulink url="&blfs-wiki;/systemd"/>
    </para>
  </sect2>

  <sect2 role="installation">
    <title>Installation de systemd</title>

    <para>
      Appliquez un correctif qui résout un problème de sécurité&nbsp;:
    </para>

<screen><userinput remap="pre">patch -Np1 -i ../systemd-&systemd-version;-upstream_fixes-1.patch</userinput></screen>

    <para>
      Supprimez deux groupes inutiles, <systemitem
class="groupname">render</systemitem> et <systemitem
class="groupname">sgx</systemitem>, des règles udev par défaut&nbsp;:
    </para>

<screen><userinput remap="pre">sed -i -e 's/GROUP="render"/GROUP="video"/' \
       -e 's/GROUP="sgx", //' rules.d/50-udev-default.rules.in</userinput></screen>

    <para>
      Reconstruisez <application>systemd</application> en lançant les commandes
suivantes&nbsp;:
    </para>

<!-- Regarding homed and userdb, see the note below in Command Explanations-->
<screen><userinput>mkdir build &amp;&amp;
cd    build &amp;&amp;

meson --prefix=/usr                 \
      --buildtype=release           \
      -Dblkid=true                  \
      -Ddefault-dnssec=no           \
      -Dfirstboot=false             \
      -Dinstall-tests=false         \
      -Dldconfig=false              \
      -Dman=auto                    \
      -Dsysusers=false              \
      -Drpmmacrosdir=no             \
      -Db_lto=false                 \
      -Dhomed=false                 \
      -Duserdb=false                \
      -Dmode=release                \
      -Dpamconfdir=/etc/pam.d       \
      -Ddocdir=/usr/share/doc/systemd-&systemd-version; \
      ..                            &amp;&amp;

ninja</userinput></screen>


    <note>
      <para>
        Pour de meilleurs résultats, assurez-vous que vous lancez la suite de tests
depuis un système démarré par la même version de
<application>systemd</application> que celle que vous reconstruisez.
      </para>
    </note>

    <para>
      <!-- One test named test-repart needs sfdisk, which is in /usr/sbin. -->
Pour tester les résultats lancez&nbsp;: <command>PATH+=:/usr/sbin ninja
test</command>.
      
    </para>



   <!--
    <warning>

      <para>
        Installing the package will overwrite all files installed by
        <application>systemd</application> in LFS. It is critical that
        nothing uses either <application>systemd</application> or
        <application>Udev</application> libraries during the installation.
        The best way to ensure that these libraries are not being used is to
        run the installation in rescue mode. To switch to rescue mode,
        run the following command as the
        <systemitem class="username">root</systemitem> user (from a TTY):
      </para>

<screen role="root"><userinput>systemctl isolate rescue.target</userinput></screen>
    </warning>
    Nobody has reported problems with this in years. Let's comment it. -->
<para>
     Maintenant, en tant qu'utilisateur <systemitem
class="username">root</systemitem>&nbsp;:
   </para>

<!-- No longer needed as of systemd-244.
    <para>

      Remove a configuration file that causes some problems with PID files:
    </para>

<screen role="root"><userinput>rm -fv /etc/sysctl.d/50-pid-max.conf</userinput></screen>
  -->
<screen role="root"><userinput>ninja install</userinput></screen>
  
  </sect2>

  <sect2 role="commands">
    <title>Explication des commandes</title>



    <!-- Not needed with the patch
    <para>

      <parameter>-Dc_args=-Wno-format-overflow</parameter>: Prevents an error
      when building with <application>GCC 10</application>. The default is
      <option>-Werror=format-overflow</option>, 
      which generates false positives. This switch may be used with previous
      versions of GCC too.
    </para>
-->
<xi:include xmlns:xi="http://www.w3.org/2001/XInclude"
      href="../../xincludes/meson-buildtype-release.xml"/>

    <para>
      <parameter>-Dpamconfdir=/etc/pam.d</parameter>&nbsp;: force les fichiers PAM
à être installés dans /etc/pam.d plutôt qu edans /usr/lib/pam.d.
    </para>

    <para>
      <parameter>-Duserdb=false</parameter>&nbsp;: supprime un démon qui n'offre
rien d'utile dans une configuration BLFS. Si vous voulez activer le démon
<application>userdb</application>, remplacez «&nbsp;false&nbsp;» par
«&nbsp;true&nbsp;» dans la commande meson ci-dessus.
    </para>

    <para>
      <parameter>-Dhomed=false</parameter>&nbsp;: supprime un démon qui n'offre
rien d'utile pour une configuration BLFS traditionnelle, surtout si vous
utilisez des comptes créés par useradd. Pour activer systemd-homed,
assurez-vous d'abord que vous avez <xref linkend="cryptsetup"/> et <xref
linkend="libpwquality"/>, puis remplacez  «&nbsp;false&nbsp;» par
«&nbsp;true&nbsp;» dans la commande meson ci-dessus.
    </para>

    

  <!-- EDITORS NOTE: Explanation on removing userdbd and homed:
    In BLFS, we do not fully support disk encryption. We offer instructions for
    building 'cryptsetup' as a dependency, but we do not offer instructions for
    actually configuring it. In addition, we generally do not include
    functionality that could potentially conflict with other packages, or that
    is not of any use to us (in an enterprise configuration using Thin Clients
    or laptops with LUKS encryption, it could make sense though, but that isn't
    the configuration that we natively support).

    A few of the complications of systemd-homed include:
      - SSH Logins
      - Disk Space Assignments
      - UID Assignments (chown() on login)
      (See https://cfp.all-systems-go.io/media/homed-asg2019.pdf)

    In an article I read when systemd-homed was originally unveiled, I remember
    reading about systemd-homed causing problems with OpenSSH Private Key Auth
    because the user would have to login at the console in order to unlock
    their home directory, thus allowing the private key to be unlocked and
    processed by OpenSSH. Since BLFS does not fully support encrypted disks,
    and because systemd-homed is incompatible with our usage of useradd /
    traditional UNIX users and groups, I advise that we take the following
    approach to avoid any confusion:

    - Leave the added Short Descriptions for homectl and userdbctl
    - Add the above command explanations and restore the previous behavior

    Should we decide to enable homed by default anytime in the future, 
    let's move cryptsetup to recommended or required.

    I would be open to discussing this after the next systemd version when
    systemd-homed has matured a bit more. -renodr -->
</sect2>

  <sect2 role="configuration">
    <title>Configuration de systemd</title>

    <para>
      Le fichier <filename>/etc/pam.d/system-session</filename> a besoin d'être
modifié et un nouveau fichier doit être créé pour que
<command>systemd-logind</command> fonctionne correctement. Lancez les
commandes suivantes en tant qu'utilisateur <systemitem
class="username">root</systemitem>&nbsp;:
    </para>

<!--
    <para>

      At this point, you should reload the systemd daemon, and reenter
      multi-user mode with the following commands (as the
      <systemitem class="username">root</systemitem> user).  If a desktop
      manager is installed and you wish to reenter the graphical mode,
      replace <userinput>multi-user.target</userinput> with
      <userinput>graphical.target</userinput>:
    </para>

<screen role="root"><userinput>systemctl daemon-reexec
systemctl start multi-user.target</userinput></screen>-->
<screen role="root"><userinput>cat &gt;&gt; /etc/pam.d/system-session &lt;&lt; "EOF"
<literal># Begin Systemd addition
    
session  required    pam_loginuid.so
session  optional    pam_systemd.so

# End Systemd addition</literal>
EOF

cat &gt; /etc/pam.d/systemd-user &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/systemd-user

account  required    pam_access.so
account  include     system-account

session  required    pam_env.so
session  required    pam_limits.so
session  required    pam_unix.so
session  required    pam_loginuid.so
session  optional    pam_keyinit.so force revoke
session  optional    pam_systemd.so

auth     required    pam_deny.so
password required    pam_deny.so

# End /etc/pam.d/systemd-user</literal>
EOF</userinput></screen>



    <warning>
      <para>
        Si vous mettez à jour depuis une version antérieure de systemd et qu'un
initrd est utilisé pour démarrer le système, vous devriez générer un nouvel
initrd avant de redémarrer le système.
      </para>
    </warning>

  </sect2>

  <sect2 role="content">
    <title>Contents</title>

      <para>
        Une liste des fichiers installés, avec leur description courte se trouve sur
<ulink url="&lfs-root;/chapter08/systemd.html#contents-systemd"/>.
      </para>

      <para>
        Plus bas sont listés les bibliothèques et les répertoires nouvellement
installés avec leur description courte.
      </para>

    <segmentedlist>
      <segtitle>Programmes installés</segtitle>
      <segtitle>Bibliothèques installées</segtitle>
      <segtitle>Répertoires installés</segtitle>

      <seglistitem>
        <seg>
          
          <!-- maybe userdbd/userdbctl can go in LFS, try at next time -->
homectl (si <xref linkend="cryptsetup"/> est installé) et userdbctl
(facultatifs)
        </seg>
        <seg>
          pam_systemd.so (dans <filename class="directory">/lib/security</filename>)
        </seg>
        <seg>
          Aucun
        </seg>
      </seglistitem>
    </segmentedlist>

    <variablelist>
      <bridgehead renderas="sect3">Descriptions courtes</bridgehead>
      <?dbfo list-presentation="list"?>
      <?dbhtml list-presentation="table"?>

      <varlistentry id="homectl">
        <term><command>homectl</command></term>
        <listitem>
          <para>
            est un outil pour créer, supprimer, changer et inspecter un répertoire
personnel géré par <command>systemd-homed</command>&nbsp;; remarquez que
c'est inutile pour les utilisateurs UNIX classiques et les répertoires
personnels qui sont utilisés dans les livres LFS et BLFS.
          </para>
          <indexterm zone="systemd homectl">
            <primary sortas="b-homectl">homectl</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="userdbctl">
        <term><command>userdbctl</command></term>
        <listitem>
          <para>
            inspecte les utilisateurs, les groupes et les appartenances de groupes
          </para>
          <indexterm zone="systemd userdbctl">
            <primary sortas="b-userdbctl">userdbctl</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="pam_systemd">
        <term><filename class="libraryfile">pam_systemd.so</filename></term>
        <listitem>
          <para>
            est un module PAM utilisé pour enregistrer les sessions utilisateur auprès
du gestionnaire de connexion de <application>systemd</application>,
<command>systemd-logind</command>
          </para>
          <indexterm zone="systemd pam_systemd">
            <primary sortas="c-pam_systemd">pam_systemd.so</primary>
          </indexterm>
        </listitem>
      </varlistentry>

    </variablelist>

  </sect2>

</sect1>
