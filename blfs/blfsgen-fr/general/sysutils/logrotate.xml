<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../../general.ent">
  %general-entities;

  <!ENTITY logrotate-download-http "https://github.com/logrotate/logrotate/releases/download/&logrotate-version;/logrotate-&logrotate-version;.tar.xz">
  <!ENTITY logrotate-download-ftp  "">
  <!ENTITY logrotate-md5sum        "1cee3e80df6856435aeb751b98065f9c">
  <!ENTITY logrotate-size          "164&nbsp;Ko">
  <!ENTITY logrotate-buildsize     "40&nbsp;Mo (avec les tests)">
  <!ENTITY logrotate-time          "0.1&nbsp;SBU (avec les tests)">
]>

<sect1 id="logrotate" xreflabel="logrotate-&logrotate-version;">
  <?dbhtml filename="logrotate.html"?>

  <sect1info>
<date>$Date$</date></sect1info>

  <title>Logrotate-&logrotate-version;</title>

  <indexterm zone="logrotate">
    <primary sortas="a-logrotate">logrotate</primary>
  </indexterm>

  <sect2 role="package">
    <title>Introduction à Logrotate</title>

    <para>
      Le paquet <application>logrotate</application> permet la rotation
automatique, la compression, la suppression et l'envoi par mail des fichiers
de log.
    </para>

    &lfs111_checked;

    <bridgehead renderas="sect3">Informations sur le paquet</bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>
          Téléchargement (HTTP)&nbsp;: <ulink url="&logrotate-download-http;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Téléchargement (FTP)&nbsp;: <ulink url="&logrotate-download-ftp;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Somme de contrôle MD5&nbsp;: &logrotate-md5sum;
        </para>
      </listitem>
      <listitem>
        <para>
          Taille du téléchargement&nbsp;: &logrotate-size;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation de l'espace disque requis&nbsp;: &logrotate-buildsize;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation du temps de construction&nbsp;: &logrotate-time;
        </para>
      </listitem>
    </itemizedlist>

    <bridgehead renderas="sect3">Dépendances de Logrotate</bridgehead>

    <bridgehead renderas="sect4">Requises</bridgehead>
    <para role="required">
      <xref linkend="popt"/>
    </para>

    <bridgehead renderas="sect4" revision="sysv">Recommandées</bridgehead>
    <para role="recommended" revision="sysv">
      <xref role="runtime" linkend="fcron"/> (à l'exécution)
    </para>

    <bridgehead renderas="sect4">Facultatives</bridgehead>
    <para role="optional">
      Un <xref role="runtime" linkend="server-mail"/> (à l'exécution)
    </para>

    <para condition="html" role="usernotes">Notes utilisateur&nbsp;: <ulink url="&blfs-wiki;/logrotate"/>
    </para>
  </sect2>

  <sect2 role="installation">
    <title>Installation de Logrotate</title>

    <para>
      Installez <application>logrotate</application> en exécutant les commandes
suivantes&nbsp;:
    </para>

<screen><userinput>./configure --prefix=/usr &amp;&amp;
make</userinput></screen>

    <para>
      Pour tester les résultats, lancez&nbsp;: <command>make test</command>. Un
test échoue parce que la vieille commande <command>compress</command> n'est
pas présente et deux tests échouent si un MTA n'est pas installé.
    </para>

    <para>
      Maintenant, en tant qu'utilisateur <systemitem
class="username">root</systemitem>&nbsp;:
    </para>

<screen role="root"><userinput>make install</userinput></screen>

  </sect2>

  <sect2 role="configuration">
    <title>Configuration de Logrotate</title>

    <para>
      <application>Logrotate</application> nécessite un fichier de configuration,
qui peut être passé en argument à la commande quand elle est lancée. Créez
le fichier en tant qu'utilisateur <systemitem
class="username">root</systemitem>&nbsp;:
    </para>

<screen role="root"><userinput>cat &gt; /etc/logrotate.conf &lt;&lt; EOF
<literal># Begin /etc/logrotate.conf

# Rotate log files weekly
weekly

# Don't mail logs to anybody
nomail

# If the log file is empty, it will not be rotated
notifempty

# Number of backups that will be kept
# This will keep the 2 newest backups only
rotate 2

# Create new empty files after rotating old ones
# This will create empty log files, with owner
# set to root, group set to sys, and permissions 664
create 0664 root sys

# Compress the backups with gzip
compress

# No packages own lastlog or wtmp -- rotate them here
/var/log/wtmp {
    monthly
    create 0664 root utmp
    rotate 1
}

/var/log/lastlog {
    monthly
    rotate 1
}

# Some packages drop log rotation info in this directory
# so we include any file in it.
include /etc/logrotate.d

# End /etc/logrotate.conf</literal>
EOF

chmod -v 0644 /etc/logrotate.conf</userinput></screen>

    <para>
      Maintenant créez le répertoire <filename
class='directory'>/etc/logrotate.d</filename> en tant qu'utilisateur
<systemitem class="username">root</systemitem>&nbsp;:
    </para>

<screen role="root"><userinput>mkdir -p /etc/logrotate.d</userinput></screen>

    <para>
      Maintenant des commandes de rotation de log supplémentaires peuvent être
entrées, typiquement dans le répertoire <filename
class='directory'>/etc/logrotate.d</filename>. Par exemple&nbsp;:
    </para>

<screen role="nodump"><userinput>cat &gt; /etc/logrotate.d/sys.log &lt;&lt; EOF
<literal>/var/log/sys.log {
   # If the log file is larger than 100kb, rotate it
   size   100k
   rotate 5
   weekly
   postrotate
      /bin/killall -HUP syslogd
   endscript
}</literal>
EOF

chmod -v 0644 /etc/logrotate.d/sys.log</userinput></screen>

    <para>
      Vous pouvez indiquer des fichiers multiples dans une seule entrée&nbsp;:
    </para>

<screen role="nodump"><userinput>cat &gt; /etc/logrotate.d/example.log &lt;&lt; EOF
<literal>file1
file2
file3 {
   ...
   postrotate
    ...
   endscript
}</literal>
EOF

chmod -v 0644 /etc/logrotate.d/example.log</userinput></screen>

    <para>
      Vous pouvez utiliser dans la même ligne la liste de fichiers: file1 file2
file3. Regardez la page de man de logrotate ou <ulink
url='http://www.techrepublic.com/article/manage-linux-log-files-with-logrotate/'/>
pour plus d'exemples.
    </para>

    <para>
      La commande <command>logrotate /etc/logrotate.conf</command> peut être
lancée manuellement, cependant, la commande devrait être lancée
quotidiennement. D'autres commandes utiles sont <command>logrotate -d
/etc/logrotate.conf</command> pour le débogage et <command>logrotate -f
/etc/logrotate.conf</command> pour forcer les commandes à être lancée
immédiatement. En combinant les options <option>-df</option>, vous pouvez
déboguer les effets des commandes forcées. Pendant le débogage, la commande
est seulement simulée, pas vraiment lancée, donc, éventuellement des erreurs
qui n'existent pas apparaissent, quand des fichiers intermédiaires sont
attendus, car ils ne sont pas réellement créés.
    </para>

    <para>
      Pour lancer <command>logrotate</command> quotidiennement, <phrase
revision="sysv">si vous avez installé <xref linkend="fcron"/> et complété la
section sur les tâches périodiques, exécutez</phrase><phrase
revision="systemd">exécutez</phrase> les commandes suivantes en tant
qu'utilisateur <systemitem class="username">root</systemitem> pour créer
<phrase revision="sysv">une tâche cron quotidienne&nbsp;:</phrase><phrase
revision="systemd">un timer systemd qui sera lancé tous les jours à 3 heures
du matin (heure locale)&nbsp;:</phrase>
    </para>

<screen role="root" revision="sysv"><userinput>cat &gt; /etc/cron.daily/logrotate.sh &lt;&lt; "EOF" &amp;&amp;
<literal>#!/bin/bash
/usr/sbin/logrotate /etc/logrotate.conf</literal>
EOF
chmod 754 /etc/cron.daily/logrotate.sh</userinput></screen>

<screen role="root" revision="systemd"><userinput>cat &gt; /usr/lib/systemd/system/logrotate.service &lt;&lt; "EOF" &amp;&amp;
<literal>[Unit]
Description=Runs the logrotate command
Documentation=man:logrotate(8)
DefaultDependencies=no
After=local-fs.target
Before=shutdown.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/sbin/logrotate /etc/logrotate.conf</literal>
EOF
cat &gt; /usr/lib/systemd/system/logrotate.timer &lt;&lt; "EOF" &amp;&amp;
<literal>[Unit]
Description=Runs the logrotate command daily at 3:00 AM

[Timer]
OnCalendar=*-*-* 3:00:00
Persistent=true

[Install]
WantedBy=timers.target</literal>
EOF
systemctl enable logrotate.timer</userinput></screen>

  </sect2>

  <sect2 role="content">
    <title>Contenu</title>

    <segmentedlist>
      <segtitle>Programmes installés</segtitle>
      <segtitle>Bibliothèque installée</segtitle>
      <segtitle>Répertoires installés</segtitle>

      <seglistitem>
        <seg> logrotate </seg>
        <seg> Aucune</seg>
        <seg>Aucun </seg>
      </seglistitem>
    </segmentedlist>

    <variablelist>
      <bridgehead renderas="sect3">Descriptions courtes</bridgehead>
      <?dbfo list-presentation="list"?>
      <?dbhtml list-presentation="table"?>

      <varlistentry id="logrotate-prog">
        <term><command>logrotate</command></term>
        <listitem>
          <para>
            fournit des fonctions de maintenance de log défini dans les fichiers de
configuration
          </para>
          <indexterm zone="logrotate logrotate-prog">
            <primary sortas="b-logrotate-prog">logrotate</primary>
          </indexterm>
        </listitem>
      </varlistentry>

    </variablelist>

  </sect2>

</sect1>
