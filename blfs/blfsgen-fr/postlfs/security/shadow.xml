<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../../general.ent">
  %general-entities;

  <!ENTITY shadow-download-http "https://github.com/shadow-maint/shadow/releases/download/&shadow-version;/shadow-&shadow-version;.tar.xz">
  <!ENTITY shadow-download-ftp  "">
  <!ENTITY shadow-md5sum        "52637cb34c357acf85c617cf95da34a6">
  <!ENTITY shadow-size          "1,7&nbsp;Mo">
  <!ENTITY shadow-buildsize     "36&nbsp;Mo">
  <!ENTITY shadow-time          "0.2&nbsp;SBU">
]>

<sect1 id="shadow" xreflabel="Shadow-&shadow-version;">
  <?dbhtml filename="shadow.html"?>

  <sect1info>
<date>$Date$</date></sect1info>

  <title>Shadow-&shadow-version;</title>

  <indexterm zone="shadow">
    <primary sortas="a-Shadow">Shadow</primary>
  </indexterm>

  <sect2 role="package">
    <title>Introduction à Shadow</title>

    <para>
      <application>Shadow</application> a effectivement été installé dans LFS et
il n'y a aucune raison pour le réinstaller, sauf si vous avez installé
<application>CrackLib</application> ou <application>Linux-PAM</application>
après que votre système LFS ai été terminé. Si vous avez installé
<application>CrackLib</application> après LFS, la réinstallation de
<application>Shadow</application> activera le support des mots de passe
renforcés. Si vous avez installé <application>Linux-PAM</application>, la
réinstallation de <application>Shadow</application> permettra à des
programmes tels que <command>login</command> et <command>su</command>
d'utiliser PAM.
    </para>

    &lfs112_checked;

    <bridgehead renderas="sect3">Informations sur le paquet</bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>
          Téléchargement (HTTP)&nbsp;: <ulink url="&shadow-download-http;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Téléchargement (FTP)&nbsp;: <ulink url="&shadow-download-ftp;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Somme de contrôle MD5&nbsp;: &shadow-md5sum;
        </para>
      </listitem>
      <listitem>
        <para>
          Taille du téléchargement&nbsp;: &shadow-size;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation de l'espace disque requis&nbsp;: &shadow-buildsize;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation du temps de construction&nbsp;: &shadow-time;
        </para>
      </listitem>
    </itemizedlist>

    <!--
    <bridgehead renderas="sect3">
Additional Downloads</bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>
          Required patch:
          <ulink url="&patch-root;/shadow-&shadow-version;-useradd_segfault-1.patch"/>
        </para>
      </listitem>
    </itemizedlist>
-->
<bridgehead renderas="sect3">Dépendances de Shadow</bridgehead>

    <bridgehead renderas="sect4">Requises</bridgehead>
    <para role="required">
      <xref linkend="linux-pam"/> ou <xref role="nodep" linkend="cracklib"/>
    </para>

    <para condition="html" role="usernotes">
      Notes utilisateur&nbsp;: <ulink url="&blfs-wiki;/shadow"/>
    </para>
  </sect2>

  <sect2 role="installation">
    <title>Installation de Shadow</title>

    <important>
      <para>
        Les commandes d'installation indiquées ci-dessous valent pour les
installations où on a installé <application>Linux-PAM</application> et
<application>Shadow</application> devra être réinstallé pour prendre en
charge l'installation de <application>Linux-PAM</application>.
      </para>

      <para>
        Si vous réinstallez <application>Shadow</application> pour offrir le support
des mots de passe forts en utilisant la bibliothèque
<application>CrackLib</application> sans utiliser
<application>Linux-PAM</application>, assurez-vous d'ajouter le paramètre
<parameter>--with-libcrack</parameter> au script
<command>configure</command> ci-dessous et lancez aussi la commande
suivante&nbsp;:
      </para>

<screen role="nodump"><userinput>sed -i 's@DICTPATH.*@DICTPATH\t/lib/cracklib/pw_dict@' etc/login.defs</userinput></screen>
    </important>

    <para>
      Réinstallez <application>Shadow</application> en exécutant les commandes
suivantes&nbsp;:
    </para>

<screen><!--
<screen>
<userinput>patch -Np1 -i ../shadow-4.10-useradd_segfault-1.patch &amp;&amp;

sed -i "224s/rounds/min_rounds/" libmisc/salt.c        &amp;&amp;
-->
<userinput>sed -i 's/groups$(EXEEXT) //' src/Makefile.in          &amp;&amp;

find man -name Makefile.in -exec sed -i 's/groups\.1 / /'   {} \; &amp;&amp;
find man -name Makefile.in -exec sed -i 's/getspnam\.3 / /' {} \; &amp;&amp;
find man -name Makefile.in -exec sed -i 's/passwd\.5 / /'   {} \; &amp;&amp;

sed -e 's@#ENCRYPT_METHOD DES@ENCRYPT_METHOD SHA512@' \
    -e 's@/var/spool/mail@/var/mail@'                 \
    -e '/PATH=/{s@/sbin:@@;s@/bin:@@}'                \
    -i etc/login.defs                                 &amp;&amp;

./configure --sysconfdir=/etc               \
            --disable-static                \
            --with-group-name-max-length=32 &amp;&amp;
make</userinput></screen>

    <para>
      Ce paquet n'a pas de suite de tests.
    </para>

    <para>
      Maintenant, en tant qu'utilisateur <systemitem
class="username">root</systemitem>&nbsp;:
    </para>

<screen role="root"><userinput>make exec_prefix=/usr install</userinput></screen>

    <para>
      Les pages de manuel ont été installées dans LFS, mais si vous voulez les
réinstallez, lancez (en tant qu'utilisateur <systemitem
class="username">root</systemitem>)&nbsp;:
    </para>

<screen role="root"><userinput>make -C man install-man</userinput></screen>

  </sect2>

  <sect2 role="commands">
    <title>Explication des commandes</title>

    <para>
      <command>sed -i 's/groups$(EXEEXT) //' src/Makefile.in</command>&nbsp;:
Cette commande est utilisée pour supprimer l'installation du programme
<command>groups</command> vu qu'on préfère la version issue du paquet
<application>Coreutils</application> installé avec LFS.
    </para>

    <para>
      <command>find man -name Makefile.in -exec ... {} \;</command>&nbsp;: la
première commande est utilisée pour supprimer l'installation des pages de
manuel <command>groups</command> pour que celles existantes et issues du
paquet <application>Coreutils</application> ne soient pas remplacées. Les
deux autres commandes empêchent l'installation des pages de manuel qui sont
déjà installées par <application>Man-pages</application> dans LFS.
    </para>

    <para>
      <command>sed -e 's@#ENCRYPT_METHOD DES@ENCRYPT_METHOD SHA512@' -e
's@/var/spool/mail@/var/mail@' -e '/PATH=/{s@/sbin:@@;s@/bin:@@}' -i
etc/login.defs</command>&nbsp;: Au lieu d'utiliser la méthode
«&nbsp;DES&nbsp;» par défaut, cette commande modifie l'installation pour
utiliser la méthode plus sécurisée de hashage des mots de passe
«&nbsp;SHA512&nbsp;», qui autorise aussi les mots de passe d'une longueur
supérieure à huit caractères. Elle modifie aussi l'emplacement <filename
class="directory">/var/spool/mail</filename> obsolète pour les boîtes aux
lettres utilisateur qu'utilise <application>Shadow</application> par défaut
en <filename class="directory">/var/mail</filename>. Elle change aussi le
chemin de recherche par défaut pour rester cohérent avec ce qui est indiqué
dans LFS.
    </para>

    <!--
    <para>

      <command>sed ... libmisc/salt.c</command> and
      <command>sed ... libsubid/Makefile.am</command>: Fix a couple of errors
      that were found after the package was released.
    </para>
-->
<para>
      <parameter>--with-group-name-max-length=32</parameter>&nbsp;: Le nom
d'utilisateur utilise au maximum 32 caractères. Faites la même chose pour le
nom du groupe.
    </para>

  <!--
    <para>

      <parameter>-\-without-su</parameter>: Don't reinstall
      <command>su</command> because upstream recommends using the
      <command>su</command> command from <xref linkend='util-linux'/>
      when <application>Linux-PAM</application> is available.
    </para>
-->
</sect2>


  <!-- Now, /etc/default/useradd is not reinstalled anymore, and this
     configuration has been done in lfs
  <sect2 role="configuration">

    <title>Configuring Shadow</title>

    <para>
      <application>Shadow</application>'s stock configuration for the
      <command>useradd</command> utility may not be desirable for your
      installation. One default parameter causes <command>useradd</command> to
      create a mailbox file for any newly created user.
      <command>useradd</command> will make the group ownership of this file to
      the <systemitem class="groupname">mail</systemitem> group with 0660
      permissions. If you would prefer that these mailbox files are not created
      by <command>useradd</command>, issue the following command as the
      <systemitem class="username">root</systemitem> user:
    </para>

<screen role="root"><userinput>sed -i 's/yes/no/' /etc/default/useradd</userinput></screen>
  </sect2>
-->
<sect2 role="configuration">
    <title>Configuration de Linux-PAM pour fonctionner avec Shadow</title>

    <note>
      <para>
        Le reste de cette page est consacré à la configuration de
<application>Shadow</application> pour fonctionner correctement avec
<application>Linux-PAM</application>. Si vous n'avez pas installé
<application>Linux-PAM</application> et si vous avez réinstallé
<application>Shadow</application> pour supporter les mots de passe forts via
la bibliothèque <application>CrackLib</application>, aucune configuration
supplémentaire n'est nécessaire.
      </para>
    </note>

    <sect3 id="pam.d">
      <title>Fichiers de configuration</title>

      <para>
        <filename>/etc/pam.d/*</filename> or alternatively
<filename>/etc/pam.conf</filename>, <filename>/etc/login.defs</filename> et
<filename>/etc/security/*</filename>
      </para>

      <indexterm zone="shadow pam.d">
        <primary sortas="e-etc-pam.d">/etc/pam.d/*</primary>
      </indexterm>

      <indexterm zone="shadow pam.d">
        <primary sortas="e-etc-pam.conf">/etc/pam.conf</primary>
      </indexterm>

      <indexterm zone="shadow pam.d">
        <primary sortas="e-etc-login.defs">/etc/login.defs</primary>
      </indexterm>

      <indexterm zone="shadow pam.d">
        <primary sortas="e-etc-security">/etc/security/*</primary>
      </indexterm>
    </sect3>

    <sect3>
      <title>Informations de configuration</title>

      <para>
        Configurer votre système pour utiliser <application>Linux-PAM</application>
peut être une tâche complexe. Les informations ci-dessous fourniront un
paramétrage de base pour que la fonctionnalité de connexion et de mot de
passe de <application>Shadow</application> fonctionne bien avec
<application>Linux-PAM</application>. Regardez les informations et les liens
sur la page <xref linkend="linux-pam"/> pour des informations de
configuration supplémentaires. Pour des informations spécifiques à
l'intégration de <application>Shadow</application>,
<application>Linux-PAM</application> et <application>CrackLib</application>,
vous pouvez visiter les liens suivants&nbsp;:
      </para>

      <itemizedlist spacing="compact">
        <listitem>
          
          <!-- New URL for the below link, according to it's author. -->
<para>
            <ulink url="http://www.deer-run.com/~hal/linux_passwords_pam.html"/>
          </para>
        </listitem>
      </itemizedlist>

      <sect4 id="pam-login-defs">
        <title>Configuration de /etc/login.defs</title>

        <para>
          Le programme <command>login</command> effectue actuellement beaucoup de
fonctions que les modules <application>Linux-PAM</application> devraient
maintenant gérer. La commande <command>sed</command> suivante va commenter
les lignes adéquates dans <filename>/etc/login.defs</filename> et empêcher
<command>login</command> d'effectuer ces fonctions (un fichier de sauvegarde
appelé <filename>/etc/login.defs.orig</filename> est également créé pour
préserver le contenu du fichier d'origine). Exécutez les commandes suivantes
en tant qu'utilisateur <systemitem class="username">root</systemitem>&nbsp;:
        </para>

        <indexterm zone="shadow pam-login-defs">
          <primary sortas="e-etc-login.defs">/etc/login.defs</primary>
        </indexterm>

<screen role="root"><userinput>install -v -m644 /etc/login.defs /etc/login.defs.orig &amp;&amp;
for FUNCTION in FAIL_DELAY               \
                FAILLOG_ENAB             \
                LASTLOG_ENAB             \
                MAIL_CHECK_ENAB          \
                OBSCURE_CHECKS_ENAB      \
                PORTTIME_CHECKS_ENAB     \
                QUOTAS_ENAB              \
                CONSOLE MOTD_FILE        \
                FTMP_FILE NOLOGINS_FILE  \
                ENV_HZ PASS_MIN_LEN      \
                SU_WHEEL_ONLY            \
                CRACKLIB_DICTPATH        \
                PASS_CHANGE_TRIES        \
                PASS_ALWAYS_WARN         \
                CHFN_AUTH ENCRYPT_METHOD \
                ENVIRON_FILE
do
    sed -i "s/^${FUNCTION}/# &amp;/" /etc/login.defs
done</userinput></screen>
      </sect4>

      <sect4>
        <title>Configuration des fichiers /etc/pam.d/</title>

        <para>
          Comme indiqué précédemment dans les instructions pour
<application>Linux-PAM</application>, <application>Linux-PAM</application>
supporte deux méthodes de configuration. Les commandes ci-dessous supposent
que vous avez choisi d'utiliser une configuration basée sur le répertoire,
où chaque programme a son propre fichier de configuration. Vous pouvez
éventuellement utiliser un seul fichier de configuration
<filename>/etc/pam.conf</filename> en utilisant le texte de configuration
des fichiers ci-dessous, en fournissant le nom du programme comme premier
champ à chaque ligne.
        </para>

        <para>
          En tant qu'utilisateur <systemitem class="username">root</systemitem>, créez
les fichiers de configuration <application>Linux-PAM</application> suivants
dans le répertoire <filename class="directory">/etc/pam.d/</filename> (ou
ajoutez le contenu au fichier <filename>/etc/pam.conf</filename>) en
utilisant les commandes suivantes&nbsp;:
        </para>
      </sect4>

      <sect4>
        <title>'login'</title>

<screen role="root"><userinput>cat &gt; /etc/pam.d/login &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/login

# Set failure delay before next prompt to 3 seconds
auth      optional    pam_faildelay.so  delay=3000000

# Check to make sure that the user is allowed to login
auth      requisite   pam_nologin.so

# Check to make sure that root is allowed to login
# Disabled by default. You will need to create /etc/securetty
# file for this module to function. See man 5 securetty.
#auth      required    pam_securetty.so

# Additional group memberships - disabled by default
#auth      optional    pam_group.so

# include system auth settings
auth      include     system-auth

# check access for the user
account   required    pam_access.so

# include system account settings
account   include     system-account

# Set default environment variables for the user
session   required    pam_env.so

# Set resource limits for the user
session   required    pam_limits.so

# Display date of last login - Disabled by default
#session   optional    pam_lastlog.so

# Display the message of the day - Disabled by default
#session   optional    pam_motd.so

# Check user's mail - Disabled by default
#session   optional    pam_mail.so      standard quiet

# include system session and password settings
session   include     system-session
password  include     system-password

# End /etc/pam.d/login</literal>
EOF</userinput></screen>
      </sect4>

      <sect4>
        <title>'passwd'</title>

<screen role="root"><userinput>cat &gt; /etc/pam.d/passwd &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/passwd

password  include     system-password

# End /etc/pam.d/passwd</literal>
EOF</userinput></screen>
      </sect4>

      <sect4>
        <title>'su'</title>

<screen role="root"><userinput>cat &gt; /etc/pam.d/su &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/su

# always allow root
auth      sufficient  pam_rootok.so

# Allow users in the wheel group to execute su without a password
# disabled by default
#auth      sufficient  pam_wheel.so trust use_uid

# include system auth settings
auth      include     system-auth

# limit su to users in the wheel group
# disabled by default
#auth      required    pam_wheel.so use_uid

# include system account settings
account   include     system-account

# Set default environment variables for the service user
session   required    pam_env.so

# include system session settings
session   include     system-session

# End /etc/pam.d/su</literal>
EOF</userinput></screen>
      </sect4>

      <sect4>
        <title>«&nbsp;chpasswd&nbsp;» et «&nbsp;newusers&nbsp;»</title>

<screen role="root"><userinput>cat &gt; /etc/pam.d/chpasswd &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/chpasswd

# always allow root
auth      sufficient  pam_rootok.so

# include system auth and account settings
auth      include     system-auth
account   include     system-account
password  include     system-password

# End /etc/pam.d/chpasswd</literal>
EOF

sed -e s/chpasswd/newusers/ /etc/pam.d/chpasswd >/etc/pam.d/newusers</userinput></screen>
      </sect4>

      <sect4>
        <title>'chage'</title>

<screen role="root"><userinput>cat &gt; /etc/pam.d/chage &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/chage

# always allow root
auth      sufficient  pam_rootok.so

# include system auth and account settings
auth      include     system-auth
account   include     system-account

# End /etc/pam.d/chage</literal>
EOF</userinput></screen>
      </sect4>

      <sect4>
        <title>Autres utilitaires de shadow</title>

<screen role="root"><userinput>for PROGRAM in chfn chgpasswd chsh groupadd groupdel \
               groupmems groupmod useradd userdel usermod
do
    install -v -m644 /etc/pam.d/chage /etc/pam.d/${PROGRAM}
    sed -i "s/chage/$PROGRAM/" /etc/pam.d/${PROGRAM}
done</userinput></screen>

        <warning>
          <para>
            À ce stade, vous devriez effectuer un simple test pour vérifier que
<application>Shadow</application> fonctionne comme prévu. Ouvrez un autre
terminal et connectez-vous en tant qu'utilisateur <systemitem
class="username">root</systemitem>, puis lancez <command>login</command> et
connectez-vous en tant qu'un autre utilisateur. Si vous ne voyez pas
d'erreurs, tout va bien et vous pouvez poursuivre le reste de la
configuration. Si vous avez reçu des erreurs, arrêtez-vous maintenant et
vérifiez les fichiers de configuration ci-dessus à la main. Toute erreur est
le signe d'un problème avec la procédure précédente. Vous pouvez aussi
lancer la suite de tests du paquet <application>Linux-PAM</application> pour
vous aider à déterminer le problème. Si vous n'arrivez pas à trouver et à
corriger l'erreur, vous devrez recompiler <application>Shadow</application>
en ajoutant le paramètre <option>--without-libpam</option> à la commande
<command>configure</command> dans les instructions ci-dessus (renommez aussi
le fichier de sauvegarde <filename>/etc/login.defs.orig</filename> en
<filename>/etc/login.defs</filename>). Si vous ne faîtes pas cela et si les
erreurs persistent, vous ne pourrez plus vous connecter à votre système.
          </para>
        </warning>
      </sect4>

      <sect4 id="pam-access">
        <title>Configuration de l'accès Login</title>

        <para>
          Au lieu d'utiliser le fichier <filename>/etc/login.access</filename> pour
contrôler l'accès au système, <application>Linux-PAM</application> utilise
le module <filename class='libraryfile'>pam_access.so</filename> ainsi que
le fichier <filename>/etc/security/access.conf</filename>. Renommez le
fichier <filename>/etc/login.access</filename> en utilisant la commande
suivante&nbsp;:
        </para>

        <indexterm zone="shadow pam-access">
          <primary sortas="e-etc-security-access.conf">/etc/security/access.conf</primary>
        </indexterm>

<screen role="root"><userinput>[ -f /etc/login.access ] &amp;&amp; mv -v /etc/login.access{,.NOUSE}</userinput></screen>
      </sect4>

      <sect4 id="pam-limits">
        <title>Configuration des limitations de ressources</title>

        <para>
          Au lieu d'utiliser le fichier <filename>/etc/limits</filename> pour limiter
l'utilisation des ressources système, <application>Linux-PAM</application>
utilise le module <filename class='libraryfile'>pam_limits.so</filename>
ainsi que le fichier
<filename>/etc/security/limits.conf</filename>. Renommez le fichier
<filename>/etc/limits</filename> en utilisant la commande suivante&nbsp;:
        </para>

        <indexterm zone="shadow pam-limits">
          <primary sortas="e-etc-security-limits.conf">/etc/security/limits.conf</primary>
        </indexterm>

<screen role="root"><userinput>[ -f /etc/limits ] &amp;&amp; mv -v /etc/limits{,.NOUSE}</userinput></screen>

        <caution>
          <para>
          Soyez certain de tester le login sur le système avant de le quitter. Des
erreurs dans la configuration peuvent causer un blocage permanent demandant
un démarrage depuis une source externe pour corriger le problème.
          </para>
        </caution>

      </sect4>
    </sect3>

  </sect2>

  <sect2 role="content">
    <title>Contenu</title>

    <para>
      Vous pouvez trouver une liste des fichiers installés ainsi que leurs
descriptions courtes sur <ulink
url="&lfs-root;/chapter08/shadow.html#contents-shadow"/>
    </para>

  </sect2>

</sect1>
