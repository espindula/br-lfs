<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../../general.ent">
  %general-entities;

  <!ENTITY openssh-download-http
           "https://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-&openssh-version;.tar.gz">
  <!ENTITY openssh-download-ftp
           " "> <!-- at the moment, unable to connect via ftp: ken
           "ftp://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-&openssh-version;.tar.gz"> -->
  <!ENTITY openssh-md5sum        "&openssh-md5sum;">
  <!ENTITY openssh-size          "1,8&nbsp;Mo">
  <!ENTITY openssh-buildsize     "44&nbsp;Mo (plus 22&nbsp;Mo pour les tests)">
  <!ENTITY openssh-time          "0.2 SBU (Using parallelism=4;
                                  running the tests takes about 20 minutes,
                                  irrespective of processor speed)">
]>

  

<!-- make check: real 18m13.005s;  9.2p1 3 Feb 2023 -->
<sect1 id="openssh" xreflabel="OpenSSH-&openssh-version;">
  <?dbhtml filename="openssh.html"?>

  <title>OpenSSH-&openssh-version;</title>

  <indexterm zone="openssh">
    <primary sortas="a-OpenSSH">OpenSSH</primary>
  </indexterm>

  <sect2 role="package">
    <title>Introduction à OpenSSH</title>

    <para>
      Le paquet <application>OpenSSH</application> contient des clients
<command>ssh</command> et le démon <command>sshd</command>. Il sert à
chiffrer l'authentification et le trafic consécutif sur un réseau. Les
commandes <command>ssh</command> et <command>scp</command> sont des
implémentions sécurisées, respectivement de <command>telnet</command> et de
<command>rcp</command>.
    </para>

    &lfs113_checked;

    <bridgehead renderas="sect3">Informations sur le paquet</bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>
          Téléchargement (HTTP)&nbsp;: <ulink url="&openssh-download-http;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Téléchargement (FTP)&nbsp;: <ulink url="&openssh-download-ftp;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Somme de contrôle MD5&nbsp;: &openssh-md5sum;
        </para>
      </listitem>
      <listitem>
        <para>
          Taille du téléchargement&nbsp;: &openssh-size;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation de l'espace disque requis&nbsp;: &openssh-buildsize;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation du temps de construction&nbsp;: &openssh-time;
        </para>
      </listitem>
    </itemizedlist>

    <!--
    <bridgehead renderas="sect3">
Additional Downloads</bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>
          Required patch:
          <ulink url="&patch-root;/openssh-&openssh-version;-glibc_2.31_fix-1.patch"/>
        </para>
      </listitem>
    </itemizedlist>
-->
<bridgehead renderas="sect3">Dépendances de OpenSSH</bridgehead>

    <bridgehead renderas="sect4">Facultatives</bridgehead>
    <para role="optional">
      <xref linkend="gdb"/> (pour les tests), <xref linkend="linux-pam"/>, <xref
linkend="x-window-system"/>, <xref linkend="mitkrb"/>, <xref
linkend="which"/> (pour les tests), <ulink
url="https://www.thrysoee.dk/editline/">libedit</ulink>, <ulink
url="https://www.libressl.org/">LibreSSL Portable</ulink>, <ulink
url="https://github.com/OpenSC/OpenSC/wiki">OpenSC</ulink> et <ulink
url="http://www.citi.umich.edu/projects/smartcard/sectok.html">libsectok</ulink>
    </para>

    <bridgehead renderas="sect4">Facultatives pour l'exécution (Utilisé seulement pour modifier l'entropie)</bridgehead>
    <para role="optional">
      
      <!--<xref role="runtime" linkend="openjdk"/>
, Not seen in 8.8p1 -->
<xref role="runtime" linkend="net-tools"/> et <xref role="runtime"
linkend="sysstat"/>
    </para>

    <para condition="html" role="usernotes">
        Notes utilisateur&nbsp;: <ulink url="&blfs-wiki;/OpenSSH"/>
    </para>
  </sect2>

  <sect2 role="installation">
    <title>Installation de OpenSSH</title>

    <para>
      <application>OpenSSH</application> lance pas moins de deux processus en se
connectant à d'autres ordinateurs. Le premier processus est un processus
privilégié et il contrôle comme il faut l'émission de privilèges.  Le
deuxième processus communique avec le réseau. Des étapes d'installation
supplémentaires sont nécessaires pour paramétrer le bon environnement,
effectuées en exécutant les commandes suivantes en tant qu'utilisateur
<systemitem class="username">root</systemitem>&nbsp;:
    </para>

<!--
    <para>

      Apply a patch to allow OpenSSH to build and function with
      <application>Glibc-2.31</application> and later:
    </para>

<screen><userinput remap="pre">patch -Np1 -i ../openssh-&openssh-version;-glibc_2.31_fix-1.patch</userinput></screen>
-->
<!-- Applied in 8.5p1
    <para>

      First, adapt <application>ssh-copy-id</application> to changes
      in bash-5.1:
    </para>

<screen><userinput remap="pre">sed -e '/INSTALLKEYS_SH/s/)//' -e '260a\  )' -i contrib/ssh-copy-id</userinput></screen>

    <para>
      Next, fix an issue on platforms other than x86_64:
    </para>
    <screen><userinput remap="pre">if [ "$(uname -m)" != "x86_64" ]; then
    l1="#ifdef __NR_pselect6_time64"
    l2="    SC_ALLOW(__NR_pselect6_time64),"
    l3="#endif"
    sed -e "/^#ifdef __NR_read$/ i $l1\n$l2\n$l3" \
        -i sandbox-seccomp-filter.c
fi</userinput></screen>
-->
<screen role="root"><userinput>install  -v -m700 -d /var/lib/sshd &amp;&amp;
chown    -v root:sys /var/lib/sshd &amp;&amp;

groupadd -g 50 sshd        &amp;&amp;
useradd  -c 'sshd PrivSep' \
         -d /var/lib/sshd  \
         -g sshd           \
         -s /bin/false     \
         -u 50 sshd</userinput></screen>



    <para>
      Installez <application>OpenSSH</application> en exécutant les commandes
suivantes&nbsp;:
    </para>


<screen><!-- -\-with-md5-passwords used to be here, but a comment inside of a <screen>

     block leaves an eyesore. -->
<userinput>./configure --prefix=/usr                            \
            --sysconfdir=/etc/ssh                    \
            --with-privsep-path=/var/lib/sshd        \
            --with-default-path=/usr/bin             \
            --with-superuser-path=/usr/sbin:/usr/bin \
            --with-pid-dir=/run                      &amp;&amp;
make</userinput></screen>

    <para>
      La suite de tests demande l'installation d'une copie de
<command>scp</command> pour finir les tests de multiplexage. Pour lancer la
suite de tests, commencez par copier le programme <command>scp</command>
dans <filename class="directory">/usr/bin</filename>, en faisant attention à
sauvegarder toute copie déjà existante.
    </para>

    <!--  I got all tests passed without this with 9.0p1.  Apr 13, 2022.
    <para>

      If you wish to run the tests, remove a test suite that is not valid on
      Linux-based platforms:
    </para>

<screen><userinput>sed -i 's/conch-ciphers//' regress/Makefile</userinput></screen>
-->
<para>
      <!--One test, <filename>
key options</filename>, fails when run in chroot.-->
Pour tester les résultats lancez&nbsp;: <command>make -j1 tests</command>.
      
    </para>


    <!-- commenting this, I get "all tests passed" [ ken ]
 NB tests should be run as _user_ but the role in the comment is root

 commenting [ bruce ]:  There are a couple of tests that want root.
 The log mentions that SUDO is not set.  These skipped tests are
 ignored and the end says 'all tests passed' even when not root

    <para>

      To run the test suite, issue the following commands:
    </para>

<screen role="root"><userinput>make tests 2&gt;&amp;1 | tee check.log
grep FATAL check.log</userinput></screen>

    <para>
      If the above command produces no 'FATAL' errors, then proceed with the
      installation, as the <systemitem class="username">root</systemitem> user:
    </para>-->
<para>
      Maintenant, en tant qu'utilisateur <systemitem
class="username">root</systemitem>&nbsp;:
    </para>

<screen role="root"><userinput>make install &amp;&amp;
install -v -m755    contrib/ssh-copy-id /usr/bin     &amp;&amp;

install -v -m644    contrib/ssh-copy-id.1 \
                    /usr/share/man/man1              &amp;&amp;
install -v -m755 -d /usr/share/doc/openssh-&openssh-version;     &amp;&amp;
install -v -m644    INSTALL LICENCE OVERVIEW README* \
                    /usr/share/doc/openssh-&openssh-version;</userinput></screen>
  </sect2>

  <sect2 role="commands">
    <title>Explication des commandes</title>

    <para>
      <parameter>--sysconfdir=/etc/ssh</parameter>&nbsp;: Ceci empêche les
fichiers de configuration de s'installer dans <filename
class="directory">/usr/etc</filename>.
    </para>

    

    <!--
    <para>

      <parameter>-\-with-md5-passwords</parameter>: This enables the use of MD5
      passwords.
    </para>
    -->
<para>
      <parameter>--with-default-path=/usr/bin</parameter> et
<parameter>--with-superuser-path=/usr/sbin:/usr/bin</parameter>&nbsp;: ces
paramètres initialisent <envar>PATH</envar> en accord avec le paquet
<application>Shadow</application> de LFS et BLFS
    </para>

    <para>
      <parameter>--with-pid-dir=/run</parameter>&nbsp;: ceci empêche
<application>OpenSSH</application> d'utiliser <filename
class="directory">/var/run</filename> qui est obsolète.
    </para>

    <para>
      <option>--with-pam</option>&nbsp;: Ce paramètre active le support de
<application>Linux-PAM</application> dans la construction.
    </para>

    <para>
      <option>--with-xauth=/usr/bin/xauth</option>&nbsp;: Règle l'emplacement par
défaut du binaire <command>xauth</command> pour l'authentification
X. Modifiez l'emplacement si <command>xauth</command> sera installé à un
autre endroit. Vous pouvez aussi contrôler cela depuis
<filename>sshd_config</filename> avec le mot-clé XAuthLocation. Vous pouvez
vous passer de cette option si <application>Xorg</application> est déjà
installé.
    </para>

    <para>
      <option>--with-kerberos5=/usr</option>&nbsp;: Cette option est utilisée pour
inclure le support Kerberos 5 dans la construction.
    </para>

    <para>
      <option>--with-libedit</option>&nbsp;: Cette option active les possibilités
d'édition de lignes et d'historique pour <command>sftp</command>.
    </para>

  </sect2>

  <sect2 role="configuration">
    <title>Configuration d'OpenSSH</title>

    <sect3 id="openssh-config">
      <title>Fichiers de configuration</title>

      <para>
        <filename>~/.ssh/*</filename>, <filename>/etc/ssh/ssh_config</filename> et
<filename>/etc/ssh/sshd_config</filename>
        </para>

      <indexterm zone="openssh openssh-config">
        <primary sortas="e-AA.ssh">~/.ssh/*</primary>
      </indexterm>

      <indexterm zone="openssh openssh-config">
        <primary sortas="e-etc-ssh-ssh_config">/etc/ssh/ssh_config</primary>
      </indexterm>

      <indexterm zone="openssh openssh-config">
        <primary sortas="e-etc-ssh-sshd_config">/etc/ssh/sshd_config</primary>
      </indexterm>

      <para>
        Aucune modification n'est nécessaire dans aucun de ces fichiers. Cependant,
vous pourriez souhaiter relire les fichiers <filename
class='directory'>/etc/ssh/</filename> et effectuer les modifications
adéquates pour la sécurité de votre système. Une des modifications
recommandées est de désactiver la connexion en <systemitem
class='username'>root</systemitem> via <command>ssh</command>. Exécutez la
commande suivante en tant qu'utilisateur <systemitem
class='username'>root</systemitem> pour désactiver la connexion <systemitem
class='username'>root</systemitem> via <command>ssh</command>&nbsp;:
      </para>

<screen role="root"><userinput>echo "PermitRootLogin no" &gt;&gt; /etc/ssh/sshd_config</userinput></screen>

      <para>
        Si vous voulez vous loguer sans taper votre mot de passe, commencez par
créer ~/.ssh/id_rsa et ~/.ssh/id_rsa.pub avec <command>ssh-keygen</command>
et ensuite copiez ~/.ssh/id_rsa.pub dans ~/.ssh/authorized_keys sur
l'ordinateur distant où vous voulez vous loguer.  Vous devrez changer
REMOTE_USERNAME et REMOTE_HOSTNAME par le nom d'hôte de l'ordinateur distant
et vous devrez entrer votre mot de passe pour que la commande ssh
réussisse&nbsp;:
      </para>

<screen><userinput>ssh-keygen &amp;&amp;
ssh-copy-id -i ~/.ssh/id_rsa.pub <replaceable>REMOTE_USERNAME</replaceable>@<replaceable>REMOTE_HOSTNAME</replaceable></userinput></screen>

      <para>
        Une fois que vous avez configuré un accès sans mot de passe, c'est en fait
plus sécurisant que de vous connecter avec un mot de passe (puisque la clé
privée est plus longue que la plupart des mots de passes). Si vous voulez
maintenant désactiver la connexion avec mot de passe, en tant qu'utilisateur
<systemitem class="username">root</systemitem>&nbsp;:
      </para>


<screen role="root"><userinput>echo "PasswordAuthentication no" >> /etc/ssh/sshd_config &amp;&amp;
echo "KbdInteractiveAuthentication no" >> /etc/ssh/sshd_config</userinput></screen>

      <para>
        Si vous avez ajouté le support de <application>LinuxPAM</application> et que
vous voulez que ssh l'utilise, vous devrez ajouter un fichier de
configuration pour <application>sshd</application> et permettre
l'utilisation de <application>LinuxPAM</application>. Remarquez que ssh
n'utilise PAM que pour vérifier les mots de passe. Si vous avez désactivé le
login par mot de passe, ces commandes sont inutiles. Lancez les commandes
suivantes en tant qu'utilisateur <systemitem
class='username'>root</systemitem>&nbsp;:
      </para>

<screen role="root"><userinput>sed 's@d/login@d/sshd@g' /etc/pam.d/login &gt; /etc/pam.d/sshd &amp;&amp;
chmod 644 /etc/pam.d/sshd &amp;&amp;
echo "UsePAM yes" &gt;&gt; /etc/ssh/sshd_config</userinput></screen>

      <para>
        Vous pouvez trouver des informations de configuration supplémentaires dans
les pages de man de <command>sshd</command>, <command>ssh</command> et de
<command>ssh-agent</command>.
      </para>
    </sect3>

    <sect3  id="openssh-init">
      <title><phrase revision="sysv">Script de démarrage</phrase> <phrase
revision="systemd">Unité Systemd</phrase></title>

      <para revision="sysv">
        Pour lancer le serveur SSH au démarrage du système, installez le script de
démarrage <filename>/etc/rc.d/init.d/sshd</filename> fourni dans le paquet
<xref linkend="bootscripts"/>.
      </para>

      <para revision="systemd">
        Pour lancer le serveur SSH au démarrage du système, installez l'unité
<filename>sshd.service</filename> fournie dans le paquet <xref
linkend="systemd-units"/>.
      </para>

      <indexterm zone="openssh openssh-init">
        <primary sortas="f-sshd">sshd</primary>
      </indexterm>

<screen role="root"><userinput>make install-sshd</userinput></screen>
    </sect3>
  </sect2>

  <sect2 role="content">
    <title>Contenu</title>

    <segmentedlist>
      <segtitle>Programmes installés</segtitle>
      <segtitle>Bibliothèques installées</segtitle>
      <segtitle>Répertoires installés</segtitle>

      <seglistitem>
        <seg>
          <!--slogin (symlink to ssh),-->
scp, sftp, ssh, ssh-add, ssh-agent, ssh-copy-id, ssh-keygen, ssh-keyscan et
sshd
        </seg>
        <seg>
          Aucune
        </seg>
        <seg>
          /etc/ssh, /usr/share/doc/openssh-&openssh-version; et /var/lib/sshd
        </seg>
      </seglistitem>
    </segmentedlist>

    <variablelist>
      <bridgehead renderas="sect3">Descriptions courtes</bridgehead>
      <?dbfo list-presentation="list"?> <?dbhtml list-presentation="table"?>

      <varlistentry id="scp">
        <term><command>scp</command></term>
        <listitem>
          <para>
            est un programme de copie de fichier agissant comme <command>rcp</command>
sauf qu'il utilise un protocole chiffré
          </para>
          <indexterm zone="openssh scp">
            <primary sortas="b-scp">scp</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="sftp">
        <term><command>sftp</command></term>
        <listitem>
          <para>
            est un programme de genre FTP fonctionnant sur les protocoles SSH1 et SSH2
          </para>
          <indexterm zone="openssh sftp">
            <primary sortas="b-sftp">sftp</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <!-- Not installed anymore as of 8.5p1
      <varlistentry id="slogin">

        <term><command>slogin</command></term>
        <listitem>
          <para>
            is a symlink to <command>ssh</command>
          </para>
          <indexterm zone="openssh slogin">
            <primary sortas="b-slogin">slogin</primary>
          </indexterm>
        </listitem>
      </varlistentry>
-->
<varlistentry id="ssh">
        <term><command>ssh</command></term>
        <listitem>
          <para>
            est un client du type <command>rlogin</command>/<command>rsh</command> sauf
qu'il utilise un protocole chiffré
          </para>
          <indexterm zone="openssh ssh">
            <primary sortas="b-ssh">ssh</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="sshd">
        <term><command>sshd</command></term>
        <listitem>
          <para>
            est un démon qui écoute les requêtes de connexion <command>ssh</command>
          </para>
          <indexterm zone="openssh sshd">
            <primary sortas="b-sshd">sshd</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="ssh-add">
        <term><command>ssh-add</command></term>
        <listitem>
          <para>
            est un outil qui ajoute des clés à <command>ssh-agent</command>
          </para>
          <indexterm zone="openssh ssh-add">
            <primary sortas="b-ssh-add">ssh-add</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="ssh-agent">
        <term><command>ssh-agent</command></term>
        <listitem>
          <para>
            est un agent d'authentification qui peut stocker des clés privées
          </para>
          <indexterm zone="openssh ssh-agent">
            <primary sortas="b-ssh-agent">ssh-agent</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="ssh-copy-id">
        <term><command>ssh-copy-id</command></term>
        <listitem>
          <para>
            est un script qui permet de se connecter sur des machines distantes en
utilisant des clés locales
          </para>
          <indexterm zone="openssh ssh-copy-id">
            <primary sortas="b-ssh-copy-id">ssh-copy-id</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="ssh-keygen">
        <term><command>ssh-keygen</command></term>
        <listitem>
          <para>
            est un outil de génération de clés
          </para>
          <indexterm zone="openssh ssh-keygen">
            <primary sortas="b-ssh-keygen">ssh-keygen</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="ssh-keyscan">
        <term><command>ssh-keyscan</command></term>
        <listitem>
          <para>
            est un outil pour réunir des clés d'hôte publiques à partir d'un certain
nombre d'hôtes
          </para>
          <indexterm zone="openssh ssh-keyscan">
            <primary sortas="b-ssh-keyscan">ssh-keyscan</primary>
          </indexterm>
        </listitem>
      </varlistentry>

    </variablelist>
  </sect2>

</sect1>
