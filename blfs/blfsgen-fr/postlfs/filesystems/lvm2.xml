<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../../general.ent">
  %general-entities;

  <!ENTITY lvm2-download-http "https://sourceware.org/ftp/lvm2/LVM2.&lvm2-version;.tgz">
  <!ENTITY lvm2-download-ftp  "ftp://sourceware.org/pub/lvm2/LVM2.&lvm2-version;.tgz">
  <!ENTITY lvm2-md5sum        "0dbe745e945461419b56c7a21d7e47e2">
  <!ENTITY lvm2-size          "2.5&nbsp;Mo">
  <!ENTITY lvm2-buildsize     "37 Mo (plus 18 Mo pour les tests&nbsp;; les fichiers temporaires peuvent
atteindre environ 800 Mo dans le répertoire /tmp pendant les tests)">
  <!-- My build size was 124 MB with tests, but I'll leave this here. -renodr
       The files in /tmp are transient. I monitor /tmp with a loop during
       tests. -pierre, August 2020 -->
  <!ENTITY lvm2-time          "0,2 SBU (avec parallélisme = 4&nbsp;; plus 9 à 48 SBU pour les tests, en
fonction de la vitesse de votre disque)">
]>

<sect1 id="lvm2" xreflabel="LVM2-&lvm2-version;">
  <?dbhtml filename="lvm2.html"?>

  <sect1info>
<date>$Date$</date></sect1info>

  <title>LVM2-&lvm2-version;</title>

  <indexterm zone="lvm2">
    <primary sortas="a-LVM2">LVM2</primary>
  </indexterm>

  <sect2 role="package">
    <title>Introduction à LVM2</title>

    <para>
      Le paquet <application>LVM2</application> gère des partitions logiques. Il
permet l'extension de systèmes de fichiers sur plusieurs disques physiques
et plusieurs partitions de disque, il permet une navigation dynamique ou le
bidouillage de partitions logiques.
    </para>

    &lfs111_checked;

    <bridgehead renderas="sect3">Informations sur le paquet</bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>
          Téléchargement (HTTP)&nbsp;: <ulink url="&lvm2-download-http;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Téléchargement (FTP)&nbsp;: <ulink url="&lvm2-download-ftp;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Somme de contrôle MD5&nbsp;: &lvm2-md5sum;
        </para>
      </listitem>
      <listitem>
        <para>
          Taille du téléchargement&nbsp;: &lvm2-size;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation de l'espace disque requis&nbsp;: &lvm2-buildsize;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation du temps de construction&nbsp;: &lvm2-time;
        </para>
      </listitem>
    </itemizedlist>

    <bridgehead renderas="sect3">Dépendances de LVM2</bridgehead>

    <bridgehead renderas="sect4">Requises</bridgehead>
    <para role="required">
      <xref linkend='libaio'/>
     </para>

    <bridgehead renderas="sect4">Facultatives</bridgehead>
    <para role="optional">
      <xref linkend='mdadm'/>, <xref linkend='reiserfs'/>, <xref
linkend='valgrind'/>, <xref linkend='which'/>, <xref linkend='xfsprogs'/>
(les cinq peuvent être utilisés, mais ne sont pas nécessaires, pour les
tests) et <ulink url='https://github.com/jthornber/thin-provisioning-tools'>
thin-provisioning-tools</ulink> et <ulink
url="https://github.com/dm-vdo/vdo">vdo</ulink>
    </para>

    <para condition="html" role="usernotes">Notes utilisateur&nbsp;: <ulink url="&blfs-wiki;/lvm2"/>
    </para>

  </sect2>

  <sect2 role="kernel" id="lvm2-kernel">
    <title>Configuration du noyau</title>

    <para>
      Activez les options suivantes dans la configuration du noyau et recompilez
le noyau&nbsp;:
    </para>

    <note><para>
      Il y a d'autres options de mappage de périphérique dans le noyau après
celles listées en dessous. Afin d'avoir des résultats raisonnables si les
tests de régression sont lancés, tous doivent être activé soit en interne,
soit en module. Les tests vont tous expirer si Magic SysRq key n'est pas
activé.
    </para></note>

<screen><literal>Device Drivers ---&gt;
  [*] Multiple devices driver support (RAID and LVM) ---&gt; [CONFIG_MD]
    &lt;*/M&gt;   Device mapper support                         [CONFIG_BLK_DEV_DM]
    &lt;*/M&gt;   Crypt target support                          [CONFIG_DM_CRYPT]
    &lt;*/M&gt;   Snapshot target                               [CONFIG_DM_SNAPSHOT]
    &lt;*/M&gt;   Thin provisioning target                      [CONFIG_DM_THIN_PROVISIONING]
    &lt;*/M&gt;   Cache target (EXPERIMENTAL)                   [CONFIG_DM_CACHE]
    &lt;*/M&gt;   Mirror target                                 [CONFIG_DM_MIRROR]
    &lt;*/M&gt;   Zero target                                   [CONFIG_DM_ZERO]
    &lt;*/M&gt;   I/O delaying target                           [CONFIG_DM_DELAY]
  [*] Block devices ---&gt;
    &lt;*/M&gt;   RAM block device support                      [CONFIG_BLK_DEV_RAM]
Kernel hacking ---&gt;
  Generic Kernel Debugging Instruments ---&gt;
    [*] Magic SysRq key                                   [CONFIG_MAGIC_SYSRQ]</literal></screen>

    <indexterm zone="lvm2 lvm2-kernel">
      <primary sortas="d-lvm2">lvm2</primary>
    </indexterm>

  </sect2>

  <sect2 role="installation">
    <title>Installation de LVM2</title>

    <para>
      Installez <application>LVM2</application> en exécutant les commandes
suivantes&nbsp;:
    </para>

<screen><userinput>PATH+=:/usr/sbin                \
./configure --prefix=/usr       \
            --enable-cmdlib     \
            --enable-pkgconfig  \
            --enable-udev_sync  &amp;&amp;
make</userinput></screen>

    <para>
      Les tests utilisent <application>udev</application> pour la synchronisation
des volumes logiques, de sorte que les règles LVM de udev et que quelques
utilitaires doivent être installés avant de lancer les tests. Si vous
installez <application>LVM2</application> pour la première fois, et que vous
ne souhaitez pas installer le paquet complet avant de lancer les tests, vous
pouvez installer l'ensemble minimal d'utilitaires en lançant les commandes
suivantes en tant que <systemitem class="username">root</systemitem>&nbsp;:
    </para>

<screen role="root"
        remap="test"><userinput>make -C tools install_tools_dynamic &amp;&amp;
make -C udev  install                 &amp;&amp;
make -C libdm install</userinput></screen>

    <para>
      Pour tester les résultats, lancez, en tant qu'utilisateur <systemitem
class="username">root</systemitem>&nbsp;:
    </para>

<screen role="root"
        remap="test"><userinput>LC_ALL=en_US.UTF-8 make S=lvconvert-repair-replace check_local</userinput></screen>

    <para>
      L'option <command>S=…</command> permet de passer les tests. Le test
<command>lvconnvert-repair-replace</command> a été rapporté comme bloquant
l'ordinateur. D'autres cibles sont disponibles et peuvent être énumérées
avec <command>make -C test help</command>. Le temps de test est très
dépendant de la vitesse des disques, et du nombre d'options activées dans le
noyau.
    </para>

    

    <!-- Results for LVM2.2.02.176:
    ### 292 tests: 177 passed, 46 skipped, 0 timed out, 60 warned, 9 failed

    Results for LVM2.2.03.01:
    ### 302 tests: 182 passed, 43 skipped, 0 timed out, 62 warned, 15 failed

    Results for LVM2.2.03.05:
    ### 326 tests: 255 passed, 58 skipped, 0 timed out, 2 warned, 11 failed

    Results for LVM2.2.03.09:
    ### 338 tests: 212 passed, 41 skipped, 0 timed out, 70 warned, 15 failed

    Results for LVM2.2.03.11:
    ### 357 tests: 231 passed, 32 skipped, 0 timed out, 77 warned, 17 failed

    Results for LVM2.2.03.14:
    ### 389 tests: 304 passed, 73 skipped, 0 timed out, 2 warned, 10 failed
    -->
<para>
      <!-- 1 -->
<!-- 2 -->
<!-- 3 -->
Ces tests n'implémentent pas la possibilité <quote>expected fail</quote>
(échec prévu), et un petit nombre d'échecs est prévu en amont. Plus d'échecs
peuvent apparaître lorsque manquent certaines options du noyau. Par exemple,
l'absence de la cible du device mapper <emphasis>dm-delay</emphasis>
explique quelques erreurs. Certains tests peuvent échouer s'il n'y a pas
assez de place disponible sur la partition qui contient le répertoire
/tmp. Au moins un test échoue si 16 To ne sont pas disponibles. Certains
tests sont indiqués <quote>warned</quote> si <ulink
url='https://github.com/jthornber/thin-provisioning-tools'>thin-provisioning-tools</ulink>
n'est pas installé. Vous pouvez le contourner en ajoutant les options
suivantes à <command>configure</command>&nbsp;:
    </para>

<screen role="nodump"><userinput>     --with-thin-check=    \
     --with-thin-dump=     \
     --with-thin-repair=   \
     --with-thin-restore=  \
     --with-cache-check=   \
     --with-cache-dump=    \
     --with-cache-repair=  \
     --with-cache-restore= \</userinput></screen>

    <para>
      Certains tests peuvent bloquer. Ils peuvent être supprimés si nécessaire,
par exemple&nbsp;: <command>rm
test/shell/lvconvert-raid-reshape.sh</command>. Les tests génèrent beaucoup
de messages noyau, ce qui peut encombrer votre terminal. Vous pouvez les
désactiver avec <command>dmesg -D</command> avant de lancer les tests
(n'oubliez pas de lancer <command>dmesg -E</command> lorsque les tests sont
finis). <note><simpara>Les tests créez des nœuds de périphériques dans le répertoire /tmp. Les
tests échoueront si /tmp est monté avec l'option nodev.
      </simpara></note>
    </para>

    <para>
      Maintenant, en tant qu'utilisateur <systemitem
class="username">root</systemitem>&nbsp;:
    </para>

<screen role="root" revision="sysv"><userinput>make install
rm /usr/lib/udev/rules.d/69-dm-lvm.rules</userinput></screen>

<screen role="root" revision="systemd"><userinput>make install
make install_systemd_units</userinput></screen>

  </sect2>

  <sect2 role="commands">
    <title>Explication des commandes</title>

    <para>
      <command>PATH+=:/usr/sbin</command>&nbsp;: le PATH doit contenir <filename
class="directory">/usr/sbin</filename> pour la détection correcte des outils
système par le script <command>configure</command>. Cette instruction assure
que PATH est correctement initialisé si vous construisez avec un utilisateur
non privilégié.
    </para>

    <para>
      <parameter>--enable-cmdlib</parameter>&nbsp;: Ce paramètre construit la
bibliothèque de commande partagée. Elle est nécessaire lors de la
construction du démon d'événements.
    </para>

    <para>
      <parameter>--enable-pkgconfig</parameter>&nbsp;:  Ce paramètre installe le
support de <command>pkg-config</command>.
    </para>

    <para>
     <parameter>--enable-udev_sync</parameter>&nbsp;: Ce paramètre active la
synchronisation avec <application>Udev</application>.
    </para>

    <para>
      <option>--enable-dmeventd</option>: Cette option construit le démon
d'événement <application>Device Mapper</application>.
    </para>

    <para revision="sysv">
      <command>rm .../69-dm-lvm.rules</command>&nbsp;: sous certaines
circonstances, cette règle udev appelle <command>systemd-run</command>, qui
n'est pes disponible avec sysv. Elle effectue des actions qui sont de toute
façon effectuées par au autre script de démarrage, donc elle n'est pas
requise.
    </para>

    <para revision="systemd">
      <command>make install_systemd_units</command>&nbsp;: cela est nécessaire
pour installer une unité et activer les volumes logiques au démarrage. Elle
n'est pas installée par défaut.
    </para>

  </sect2>

  <sect2 role="configuration" revision="systemd">
    <title>Configuration de LVM2</title>

    <sect3 id="lvm2-config">
      <title>Fichier de configuration</title>
      <para>
        <filename>/etc/lvm/lvm.conf</filename>
      </para>

      <indexterm zone="lvm2 lvm2-config">
        <primary
        sortas="e-etc-lvm-lvm.conf">/etc/lvm/lvm.conf</primary>
      </indexterm>
    </sect3>

    <sect3><title>Informations sur la configuration</title>
      <para>
        The default configuration still references the obsolete <filename
class="directory">/var/lock</filename> directory. This creates a deadlock at
boot time. Change this (as the <systemitem
class="username">root</systemitem> user):
      </para>

<screen role="root"><userinput>sed -e '/locking_dir =/{s/#//;s/var/run/}' \
    -i /etc/lvm/lvm.conf</userinput></screen>

    </sect3>
  </sect2>

  <sect2 role="content">
    <title>Contenu</title>

    <segmentedlist>
      <segtitle>Programmes installés</segtitle>
      <segtitle>Bibliothèques installées</segtitle>
      <segtitle>Répertoires installés</segtitle>

      <seglistitem>
        <seg>
          blkdeactivate, dmeventd (optional), dmsetup, fsadm, lvm, lvmdump et
lvm_import_vdo. Il y a également de nombreux liens symboliques vers lvm qui
implémentent des fonctionnalités spécifiques
        </seg>
        <seg>
          libdevmapper.so et liblvm2cmd.so&nbsp;; facultatifs&nbsp;:
libdevmapper-event.so, libdevmapper-event-lvm2.so,
libdevmapper-event-lvm2mirror.so, libdevmapper-event-lvm2raid.so,
libdevmapper-event-lvm2snapshot.so, libdevmapper-event-lvm2thin.so et
libdevmapper-event-lvm2vdo.so
        </seg>
        <seg>
          /etc/lvm et /usr/lib/device-mapper (facultatif)
        </seg>
      </seglistitem>
    </segmentedlist>

    <variablelist>
      <bridgehead renderas="sect3">Descriptions courtes</bridgehead>
      <?dbfo list-presentation="list"?>

     <?dbhtml list-presentation="table"?>

      <varlistentry id="blkdeactivate">
        <term><command>blkdeactivate</command></term>
        <listitem>
          <para>
            est un utilitaire pour désactiver les périphériques blocs
          </para>
          <indexterm zone="lvm2 blkdeactivate">
            <primary sortas="b-blkdeactivate">blkdeactivate</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="dmeventd">
        <term><command>dmeventd</command></term>
        <listitem>
          <para>
            (facultatif) est le démon d'événement de Device Mapper
          </para>
          <indexterm zone="lvm2 dmeventd">
            <primary sortas="b-dmeventd">dmeventd</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="dmsetup">
        <term><command>dmsetup</command></term>
        <listitem>
          <para>
            est un outil de gestion de bas niveau de volumes logiques
          </para>
          <indexterm zone="lvm2 dmsetup">
            <primary sortas="b-dmsetup">dmsetup</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="fsadm">
        <term><command>fsadm</command></term>
        <listitem>
          <para>
            est un outil pour redimensionner ou vérifier le système de fichiers d'un
périphérique
          </para>
          <indexterm zone="lvm2 fsadm">
            <primary sortas="b-fsadm">fsadm</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="lvm">
        <term><command>lvm</command></term>
        <listitem>
          <para>
            provides the command-line tools for <application>LVM2</application>.
Commands are implemented via symbolic links to this program to manage
physical devices (pv*), volume groups (vg*) and logical volumes (lv*)
          </para>
          <indexterm zone="lvm2 lvm">
            <primary sortas="b-lvm">lvm</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      

      <!--
      <varlistentry id="lvmconf">

        <term><command>lvmconf</command></term>
        <listitem>
          <para>
            is a script that modifies the locking configuration in
            the <application>LVM2</application> configuration file.
          </para>
          <indexterm zone="lvm2 lvmconf">
            <primary sortas="b-lvmconf">lvmconf</primary>
          </indexterm>
        </listitem>
      </varlistentry>
      -->
<varlistentry id="lvmdump">
        <term><command>lvmdump</command></term>
        <listitem>
          <para>
            est un outil pour envoyer diverses informations concernant
<application>LVM2</application>
          </para>
          <indexterm zone="lvm2 lvmdump">
            <primary sortas="b-lvmdump">lvmdump</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="vgimportclone">
        <term><command>vgimportclone</command></term>
        <listitem>
          <para>
            est utilisé pour importer un VG dupliqué (comme un dépôt matériel)
          </para>
          <indexterm zone="lvm2 vgimportclone">
            <primary sortas="b-vgimportclone">vgimportclone</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="libdevmapper">
        <term><filename class="libraryfile">libdevmapper.so</filename></term>
        <listitem>
          <para>
            contient les fonctions de l'API de <application>Device Mapper</application>
          </para>
          <indexterm zone="lvm2 libdevmapper">
            <primary sortas="c-libdevmapper">libdevmapper.so</primary>
          </indexterm>
        </listitem>
      </varlistentry>

    </variablelist>

  </sect2>

</sect1>
