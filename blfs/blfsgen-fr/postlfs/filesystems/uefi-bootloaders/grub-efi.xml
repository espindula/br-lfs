<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../../../general.ent">
  %general-entities;

  <!ENTITY grub-efi-download-http "https://ftp.gnu.org/gnu/grub/grub-&grub-version;.tar.xz">
  <!ENTITY grub-efi-download-ftp  "">
  <!ENTITY grub-efi-md5sum        "cf0fd928b1e5479c8108ee52cb114363">
  <!ENTITY grub-efi-size          "6.3&nbsp;Mo">
  <!ENTITY grub-efi-buildsize     "183&nbsp;Mo">
  <!ENTITY grub-efi-time          "0,4&nbsp;SBU (sur une LFS 64&nbsp;bits, avec parallélisme = 4)">

  <!ENTITY unifont-download-http  "https://unifoundry.com/pub/unifont/unifont-&unifont-version;/font-builds/unifont-&unifont-version;.pcf.gz">
  <!ENTITY unifont-md5sum         "94ff8cb4d5674cd2f38b00cede5e06d5">
  <!ENTITY unifont-size           "1,4&nbsp;Mo">
]>

<sect1 id="grub-efi" xreflabel="GRUB-&grub-version; pour EFI">
  <?dbhtml filename="grub-efi.html"?>


  <title>GRUB-&grub-version; pour EFI</title>

  <indexterm zone="grub-efi">
    <primary sortas="a-grub-efi">grub-efi</primary>
  </indexterm>

  <sect2 role="package">
    <title>Introduction à GRUB</title>

    <para>
      Le paquet <application>Grub</application> contient un chargeur de démarrage,
le <foreignphrase>GRand Unified Bootloader</foreignphrase>. Dans cette page
il sera construit avec la prise en charge d'UEFI, qui n'était pas activée
dans le GRUB construit dans LFS.
    </para>

    &lfs120_checked;

    <bridgehead renderas="sect3">Informations sur le paquet</bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>
          Téléchargement (HTTP)&nbsp;: <ulink url="&grub-efi-download-http;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Téléchargement (FTP)&nbsp;: <ulink url="&grub-efi-download-ftp;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Somme de contrôle MD5&nbsp;: &grub-efi-md5sum;
        </para>
      </listitem>
      <listitem>
        <para>
          Taille du téléchargement&nbsp;: &grub-efi-size;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation de l'espace disque requis&nbsp;: &grub-efi-buildsize;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation du temps de construction&nbsp;: &grub-efi-time;
        </para>
      </listitem>
    </itemizedlist>

    <bridgehead renderas="sect3">Téléchargements supplémentaires</bridgehead>

    <itemizedlist spacing="compact">
      <listitem>
        <para>
          Correctif requis&nbsp;: <ulink
url="&patch-root;/grub-&grub-version;-upstream_fixes-1.patch"/>
        </para>
      </listitem>
    </itemizedlist>

    <itemizedlist spacing="compact">
      <title>Données de polices unicode utilisées pour afficher le menu de GRUB</title>
      <listitem>
        <para>
          Téléchargement (HTTP)&nbsp;: <ulink url="&unifont-download-http;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Somme de contrôle MD5&nbsp;: &unifont-md5sum;
        </para>
      </listitem>
      <listitem>
        <para>
          Taille du téléchargement&nbsp;: &unifont-size;
        </para>
      </listitem>
    </itemizedlist>

    <itemizedlist spacing="compact">
      <title>GCC (seulement requis si vous construisez sur une LFS 32&nbsp;bits)</title>
      <listitem>
        <para>
          Consultez la page <xref linkend='gcc'/> pour les informations sur le
téléchargement.
        </para>
      </listitem>
    </itemizedlist>

    <bridgehead renderas="sect3">Dépendances de GRUB</bridgehead>

    <bridgehead renderas="sect4">Recommandées</bridgehead>
    <para role="recommended">
      <xref role="runtime" linkend="efibootmgr"/> (exécution) et <xref
linkend="freetype2"/>
    </para>

    <bridgehead renderas="sect4">Facultatives</bridgehead>
    <para role="optional">
      <xref linkend="lvm2"/>
    </para>


  </sect2>

  <sect2 role="installation">
    <title>Installation de GRUB</title>

    <para>
      Tout d'abord, installez les données de police en tant qu'utilisateur
<systemitem class="username">root</systemitem>&nbsp;:
    </para>

<screen role="root"><userinput>mkdir -pv /usr/share/fonts/unifont &amp;&amp;
gunzip -c ../unifont-&unifont-version;.pcf.gz > /usr/share/fonts/unifont/unifont.pcf</userinput></screen>

    <warning>
      <para>Nettoyez les variables d'environnement qui peuvent affecter la
construction&nbsp;:</para>

      <screen><userinput>unset {C,CPP,CXX,LD}FLAGS</userinput></screen>

      <para>N'essayez pas de <quote>régler</quote> ce paquet avec des drapeaux de
compilation personnalisés&nbsp;: ce paquet est un chargeur d'amorçage, avec
des opérations de bas-niveau dans le code source qui seront sans doute
cassées par certaines optimisations agressives.</para>
    </warning>

    <para>
      Corrigez un problème qui fait échouer <command>grub-install</command>
lorsque la partition <filename class='directory'>/boot</filename> (ou la
partition racine si <filename class='directory'>/boot</filename> n'est pas
une partition séparée) est créée par e2fsprogs-1.47.0 ou supérieur.
    </para>

<screen><userinput>patch -Np1 -i ../grub-&grub-version;-upstream_fixes-1.patch</userinput></screen>

    <para>Si vous êtes sur une LFS 32&nbsp;bits, préparez un compilateur
64&nbsp;bits&nbsp;:</para>


<screen><!-- 'literal' is used deliberately to show this is only for 32-bit LFS -->
<userinput>case $(uname -m) in i?86 )
    <literal>tar xf ../gcc-&gcc-version;.tar.xz
    mkdir gcc-&gcc-version;/build
    pushd gcc-&gcc-version;/build
        ../configure --prefix=$PWD/../../x86_64-gcc \
                     --target=x86_64-linux-gnu      \
                     --with-system-zlib             \
                     --enable-languages=c,c++       \
                     --with-ld=/usr/bin/ld
        make all-gcc
        make install-gcc
    popd
    export TARGET_CC=$PWD/x86_64-gcc/bin/x86_64-linux-gnu-gcc</literal>
esac</userinput></screen>

    <para>
      Construisez <application>GRUB</application> avec les commandes
suivantes&nbsp;:
    </para>

<screen><userinput>./configure --prefix=/usr        \
            --sysconfdir=/etc    \
            --disable-efiemu     \
            --enable-grub-mkfont \
            --with-platform=efi  \
            --target=x86_64      \
            --disable-werror     &amp;&amp;
unset TARGET_CC &amp;&amp;
make</userinput></screen>

    <para>
      Ce paquet n'a pas de suite de tests qui fournisse des résultats
intéressants.
    </para>

    <para>
      Maintenant, en tant qu'utilisateur <systemitem
class="username">root</systemitem>&nbsp;:
    </para>

<screen role="root"><userinput>make install &amp;&amp;
mv -v /etc/bash_completion.d/grub /usr/share/bash-completion/completions</userinput></screen>

  </sect2>

  <sect2 role="commands">
    <title>Explication des commandes</title>

    <para>
      <parameter>--enable-grub-mkfont</parameter>&nbsp;: construit l'outil
<command>grub-mkfont</command> pour générer le fichier de polices pour le
chargeur d'amorçage à partir des données de police qu'on a installées.
    </para>

    <warning>
      <para>Si vous n'avez pas installé la dépendance recommandée <xref
linkend="freetype2"/>, il est possible d'omettre cette option et de
construire GRUB. Cependant, si <command>grub-mkfont</command> n'est pas
construit ou que les données de police unicode ne sont pas disponibles quand
GRUB est construit, GRUB n'installera aucune police pour le chargeur
d'amorçage. Le menu de démarrage de GRUB sera affiché avec une police
grossière ou une plus petite portion de votre écran.</para>
    </warning>

    <para>
      <parameter>--with-platform=efi</parameter>&nbsp;: s'assure de construire
GRUB avec EFI activé.
    </para>

    <para>
      <parameter>--target=x86_64</parameter>&nbsp;: s'assure de construire GRUP
pour x86_64 même si vous construisez sur une LFS 32&nbsp;bits. La plupart
des firmware sur x86_64 ne prennent pas en charge les chargeurs d'amorçage
en 32&nbsp;bits.
    </para>

    <para>
      <option>--target=i386</option>&nbsp;: quelques plateformes x86 32&nbsp;bits
prennent EFI en charge. En plus, certaines plateformes x86_64 ont une
implémentation EFI en 32&nbsp;bits, mais ils sont très vieux et très
rares. Utilisez ceci au lieu de <parameter>--target=x86_64</parameter> si
vous êtes <emphasis role='bold'>absolument certain</emphasis> que LFS tourne
sur un tel système.
    </para>

  </sect2>

  <sect2>
    <title>Configuration de GRUB</title>

    <para>
      On discute de comment utiliser GRUB pour rendre le système LFS amorçable sur
une plateforme UEFI sur <xref linkend="grub-setup"/>.
    </para>
  </sect2>

  <sect2 role="content">
    <title>Contents</title>

    <para>Voir la page pour GRUB dans le livre LFS.</para>
  </sect2>

</sect1>
