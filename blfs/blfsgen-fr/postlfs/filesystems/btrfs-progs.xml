<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../../general.ent">
  %general-entities;

  <!ENTITY btrfs-progs-download-http "&kernel-dl;/linux/kernel/people/kdave/btrfs-progs/btrfs-progs-v&btrfs-progs-version;.tar.xz">
  <!ENTITY btrfs-progs-download-ftp  "">
  <!ENTITY btrfs-progs-md5sum        "1b5705b3e9503f09a9598dad1e7bfbc8">
  <!ENTITY btrfs-progs-size          "3,0&nbsp;Mo">
  <!ENTITY btrfs-progs-buildsize     "62&nbsp;Mo (les fichiers temporaires créés pendant les tests ont besoin de
jusqu'à 10&nbsp;Go)">
  <!ENTITY btrfs-progs-time          "0,2&nbsp;SBU (plus 3,8&nbsp;SBU pour les tests, jusqu'à 80&nbsp;SBU sur des
disques lents si reiserfsprogs est installé)">
]>

<sect1 id="btrfs-progs" xreflabel="btrfs-progs-&btrfs-progs-version;">
  <?dbhtml filename="btrfs-progs.html"?>


  <title>btrfs-progs-&btrfs-progs-version;</title>

  <indexterm zone="btrfs-progs">
    <primary sortas="a-btrfs-progs">btrfs-progs</primary>
  </indexterm>

  <sect2 role="package">
    <title>Introduction à btrfs-progs</title>

    <para>
      Le paquet <application>btrfs-progs</application> contient les outils
d'administration et de débogage pour le système de fichier en B-arbre
(btrfs).
    </para>

    &lfs120_checked;

    <bridgehead renderas="sect3">Informations sur le paquet</bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>
          Téléchargement (HTTP)&nbsp;: <ulink url="&btrfs-progs-download-http;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Téléchargement (FTP)&nbsp;: <ulink url="&btrfs-progs-download-ftp;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Somme de contrôle MD5&nbsp;: &btrfs-progs-md5sum;
        </para>
      </listitem>
      <listitem>
        <para>
          Taille du téléchargement&nbsp;: &btrfs-progs-size;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation de l'espace disque requis&nbsp;: &btrfs-progs-buildsize;
        </para>
      </listitem>
      <listitem>
        <para>
          Estimation du temps de construction&nbsp;: &btrfs-progs-time;
        </para>
      </listitem>
    </itemizedlist>

    <!--
<bridgehead renderas="sect3">
Additional Downloads</bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>
          Required patch if building with linux kernel headers version
          before 5.12:
          <ulink url="&patch-root;/btrfs-progs-&btrfs-progs-version;-headers_fix-1.patch"/>
        </para>
      </listitem>
    </itemizedlist>
-->
<bridgehead renderas="sect3">Dépendances de Btrfs-progs</bridgehead>

    <bridgehead renderas="sect4">Requises</bridgehead>
    <para role="required">
      <xref linkend="lzo"/>
    </para>
    
    <!-- In v6.2.1 (and maybe previous), sphinx is required for the doc
    <bridgehead renderas="sect4">
Recommended</bridgehead>
    <para role="recommended">
      <xref linkend="asciidoc"/> (or <xref role="nodep" linkend="asciidoctor"/>)
      and <xref linkend="xmlto"/> (both required to generate man pages)
    </para>
    -->
<bridgehead renderas="sect4">Facultatives</bridgehead>
    <para role="optional">
      <xref linkend="lvm2"/> (<command>dmsetup</command> est utilisé dans les
tests), <xref linkend="reiserfs"/> (pour les tests) et <xref
linkend="sphinx"/> (requis pour construire la documentation)

    </para>


  </sect2>

  <sect2 role="kernel" id="btrfs-progs-kernel">
    <title>Configuration du noyau</title>

    <para>
      Activez les options suivantes dans la configuration du noyau et recompilez
le noyau&nbsp;:
    </para>

    <xi:include xmlns:xi="http://www.w3.org/2001/XInclude"
      href="btrfs-progs-kernel.xml"/>

    <para>
      En plus de ce qui précède et des options requises pour <xref
linkend="lvm2"/> et <xref linkend="reiserfs"/>, les options suivantes
doivent être activées pour lancer les tests&nbsp;:
    </para>

    <xi:include xmlns:xi="http://www.w3.org/2001/XInclude"
      href="btrfs-progs-test-kernel.xml"/>

    <indexterm zone="btrfs-progs btrfs-progs-kernel">
      <primary sortas="d-btrfs-progs">Programmes BTRFS</primary>
    </indexterm>

  </sect2>

  <sect2 role="installation">
    <title>Installation de btrfs-progs</title>

    <para>
      Installez <application>btrfs-progs</application> en exécutant les commandes
suivantes&nbsp;:
    </para>

<screen><userinput>./configure --prefix=/usr           \
            --disable-static        \
            --disable-documentation &amp;&amp;
make</userinput></screen>

    <note>
      <para>
        Certains tests ont besoin de grep construit avec les expressions régulières
de perl. Pour cela, reconstruisez grep avec les instruction du chapitre 8 de
LFS après avoir installé <xref linkend="pcre2"/>.
      </para>
    </note>

    <!-- Keeping this for now, but it seems that calling "make test" is
     simpler and does the same thing -->
<para>
      Avant de lancer les tests, construisez un programme support&nbsp;:
    </para>

<screen remap="test"><userinput>make fssum</userinput></screen>

    <para>
      Pour tester les résultats, lancez (en tant qu'utilisateur &root;)&nbsp;:
    </para>

<!-- Template for failed test removal:
    <para>

      To test the results, first disable one test that fails and prevents
      the other ones to run:
    </para>

<screen remap="test"><userinput>mv tests/fsck-tests/012-leaf-corruption/test.sh{,.broken}</userinput></screen>
Substitute your test failure with the one above.
    <para>
      To test the results, run (as the
      <systemitem class="username">root</systemitem> user):
    </para>

<screen role="root" remap="test"><userinput>make -j1 -k test</userinput></screen>
-->
<screen role="root" remap="test"><userinput>pushd tests
   ./fsck-tests.sh
   ./mkfs-tests.sh
   ./cli-tests.sh
   sed 's/,orphan_file//' /etc/mke2fs.conf >./custom_mke2fs.conf &amp;&amp;
   export MKE2FS_CONFIG=$PWD/custom_mke2fs.conf                  &amp;&amp;
   ./convert-tests.sh
   unset MKE2FS_CONFIG &amp;&amp; rm custom_mke2fs.conf
   ./misc-tests.sh
   ./fuzz-tests.sh
popd</userinput></screen>


    <note>
      <para>
        Si les options du noyau mentionnées plus haut ne sont pas activées, certains
tests échouent, et empêchent tous les autres tests de se lancer, parce que
l'image disque de test n'est pas démontée proprement.
      </para>
    </note>

    <!--  Now passes in version 6.3.1.
    <para>

      The mkfs test 025-zoned-parallel is known to fail.
    </para>
-->
<para>
      Installez le paquet en tant qu'utilisateur &root;&nbsp;:
    </para>

<screen role="root"><userinput>make install</userinput></screen>

    <para>
      Si vous avez passé <parameter>--disable-documentation</parameter> à
<command>configure</command> et avez besoin des pages de manuel,
installez-les en exécutant, en tant qu'utilisateur &root;&nbsp;:
    </para>

<screen role="root"><userinput>for i in 5 8; do
   install Documentation/*.$i /usr/share/man/man$i
done</userinput></screen>

  </sect2>

  <sect2 role="commands">
    <title>Explication des commandes</title>

    <xi:include xmlns:xi="http://www.w3.org/2001/XInclude"
      href="../../xincludes/static-libraries.xml"/>

    <para>
      <parameter>--disable-documentation</parameter>&nbsp;: ce paramètre désactive
la reconstruction des pages de manuel car il nécessite <xref
linkend="sphinx"/>.
    </para>
    <para>
      <command>sed 's/,orphan_file//" ...</command>&nbsp;: dans cette version de
<application>btrfs-progs</application>, le programme
<command>btrfs-convert</command> produit un système de fichiers btrfs qui
contient des erreurs si vous convertissez depuis un système de fichiers ext4
créé avec la fonctionnalité <quote>orphan_file</quote>. Cette commande crée
un fichier de configuration personnalisé qui empêche de créer un système de
fichiers avec cette fonctionnalité.
    </para>
    
  <!--
    <para>

      <command>ln -s ... /usr/lib/libbtrfs.so</command>: Creates a
      symbolic link in the directory where it is expected.
    </para>

    <para>
      <command>rm /lib/libbtrfs.{a,so}</command>: Removes unneeded
      library entries.
    </para>
-->
</sect2>

  <sect2 role="using" id="using-btrfs-convert">
    <title>Utiliser le programme btrfs-convert</title>

    <para>
      Cette version de <application>btrfs-progs</application> ne convertit pas
correctement les systèmes de fichiers ext4 en btrfs si la fonctionnalité
ext4 <option>orphan_file</option> est activée. Si vous devez convertir un
tel système de fichiers, vous devez d'abord exécuter&nbsp;:
    </para>

<screen role="nodump"><userinput>tune2fs -O ^orphan_file <replaceable>/dev/sdxx</replaceable></userinput></screen>

    <para>
      où <filename>/dev/sdxx</filename> est la partition du système de fichiers
que vous voulez convertir.
    </para>
  </sect2>

  <sect2 role="content">
    <title>Contents</title>

    <segmentedlist>
      <segtitle>Programmes installés</segtitle>
      <segtitle>Bibliothèques installées</segtitle>
      <segtitle>Répertoires installés</segtitle>

      <seglistitem>
        <seg>
          btrfs, btrfs-convert, btrfs-find-root, btrfs-image, btrfs-map-logical,
btrfs-select-super, btrfsck (lien vers btrfs), btrfstune, fsck.btrfs et
mkfs.btrfs
        </seg>

        <seg>
          libbtrfs.so et libbtrfsutil.so
        </seg>

        <seg>/usr/include/btrfs</seg>
      </seglistitem>
    </segmentedlist>

    <variablelist>
      <bridgehead renderas="sect3">Descriptions courtes</bridgehead>
      <?dbfo list-presentation="list"?> <?dbhtml list-presentation="table"?>

      <varlistentry id="btrfs-prog">
        <term><command>btrfs</command></term>
        <listitem>
          <para>
            est l'interface principale dans les opérations du système de fichiers btrfs
          </para>
          <indexterm zone="btrfs-progs btrfs-prog">
            <primary sortas="b-btrfs">btrfs</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="btrfs-convert">
        <term><command>btrfs-convert</command></term>
        <listitem>
          <para>
            convertit un système de fichier depuis ext2/3/4 ou reiserfs vers btrfs (voir
<xref linkend="using-btrfs-convert"/> plus haut)
          </para>
          <indexterm zone="btrfs-progs btrfs-convert">
            <primary sortas="b-btrfs-convert">btrfs-convert</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="btrfs-find-root">
        <term><command>btrfs-find-root</command></term>
        <listitem>
          <para>
            est un filtre pour trouver la racine btrfs
          </para>
          <indexterm zone="btrfs-progs btrfs-find-root">
            <primary sortas="b-btrfs-find-root">btrfs-find-root</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="btrfs-map-logical">
        <term><command>btrfs-map-logical</command></term>
        <listitem>
          <para>
            relie les espaces logiques btrfs aux espaces physiques
          </para>
          <indexterm zone="btrfs-progs btrfs-map-logical">
            <primary sortas="b-btrfs-map-logical">btrfs-map-logical</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="btrfs-select-super">
        <term><command>btrfs-select-super</command></term>
        <listitem>
          <para>
            écrase les super-blocs principaux avec une copie de sauvegarde
          </para>
          <indexterm zone="btrfs-progs btrfs-select-super">
            <primary sortas="b-btrfs-select-super">btrfs-select-super</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="btrfstune">
        <term><command>btrfstune</command></term>
        <listitem>
          <para>
            affine divers paramètres du système de fichier
          </para>
          <indexterm zone="btrfs-progs btrfstune">
            <primary sortas="b-btrfstune">btrfstune</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="fsck.btrfs">
        <term><command>fsck.btrfs</command></term>
        <listitem>
          <para>
            ne fait rien, mais est présent pour être cohérent avec fstab
          </para>
          <indexterm zone="btrfs-progs fsck.btrfs">
            <primary sortas="b-fsck.btrfs">fsck.btrfs</primary>
          </indexterm>
        </listitem>
      </varlistentry>

      <varlistentry id="mkfs.btrfs">
        <term><command>mkfs.btrfs</command></term>
        <listitem>
          <para>
            crée un système de fichier btrfs
          </para>
          <indexterm zone="btrfs-progs mkfs.btrfs">
            <primary sortas="b-mkfs.btrfs">mkfs.btrfs</primary>
          </indexterm>
        </listitem>
      </varlistentry>

    </variablelist>

  </sect2>

</sect1>
