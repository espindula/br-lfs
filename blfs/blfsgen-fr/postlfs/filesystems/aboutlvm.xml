<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../../general.ent">
  %general-entities;
]>

<sect1 id="aboutlvm">
  <?dbhtml filename="aboutlvm.html"?>

  <sect1info>
<date>$Date$</date></sect1info>

  <title>À propos de la gestion des volumes logiques (LVM)</title>

  <para>
    LVM gère les disques durs. Il permet que de multiples disques et partitions
soient combinés dans de gros <emphasis>groupes de volumes</emphasis>,
assiste la création de sauvegardes au travers de
<emphasis>snapshot</emphasis>, et permet le redimensionnement dynamique des
volumes.  Il peut également fournir une fonction de miroir similaire à une
grappe de RAID 1.
  </para>

  <para>
    Une présentation complète de LVM est au-delà de la portée de cette
introduction, mais les concepts de base sont présentés ci-dessous.
  </para>

  <para>
    Pour exécuter chacune des commandes présentées ici, le paquet <xref
linkend="lvm2"/> doit être installé. Toutes les commandes doivent être
lancées en tant qu'utilisateur <systemitem
class="username">root</systemitem>.
  </para>

  <para>
    La gestion des disques avec LVM est accomplie en utilisant les concepts
suivants&nbsp;:
  </para>

  <variablelist>
    <varlistentry>
      <term>volumes physiques</term>
      <listitem>
        <para>
          Il y a des disques ou des partitions physiques comme /dev/sda3 ou /dev/sdb.
        </para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>groupes de volumes</term>
      <listitem>
        <para>
          On appelle groupes de volumes physiques ce qui peut être manipulé par
l'administrateur.  Le nombre de volumes physiques qui constituent un groupe
de volumes est arbitraire.  Les volumes physiques peuvent être dynamiquement
ajoutés ou supprimés à partir d'un groupe de volumes.
        </para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term>volumes logique</term>
      <listitem>
        <para>
          Les groupes de volume peuvent être divisés en volumes logiques.  Chaque
volume logique peut être ainsi formaté individuellement comme s'il
s'agissait d'une partition Linux normal. Les volumes logiques peuvent être
redimensionné dynamiquement par l'administrateur en fonction des besoins.
        </para>
      </listitem>

    </varlistentry>
  </variablelist>

  <para>
    Pour donner un exemple concret, supposez que vous ayez deux disques de
2&nbsp;To. Supposons également qu'une grande quantité d'espace est
nécessaire pour une très grosse base de données, montée sur <filename
class='directory'>/srv/mysql</filename>. Voilà à quoi rassemblerait
l'ensemble des initialisations des partitions&nbsp;:
  </para>

  <screen><literal>Partition  Use    Size      Partition Type
/dev/sda1  /boot  100MB     83 (Linux)
/dev/sda2  /       10GB     83 (Linux)
/dev/sda3  swap     2GB     82 (Swap)
/dev/sda4  LVM    remainder 8e (LVM)
/dev/sdb1  swap     2GB     82 (Swap)
/dev/sdb2  LVM    remainder 8e (LVM)</literal></screen>

  <para>
    En premier initialisez les volumes physiques&nbsp;:
  </para>

  <screen><userinput>pvcreate /dev/sda4 /dev/sdb2</userinput></screen>

  <note>
    <para>
      On peut utiliser un disque complet comme partie d'un volume physique, mais
soyez conscient que la commande <command>pvcreate</command> va détruire les
informations sur les partitions de ce disque.
    </para>
  </note>

  <para>
    Ensuite créez un groupe de volume appelé lfs-lvm:
  </para>

  <screen><userinput>vgcreate lfs-lvm /dev/sda4  /dev/sdb2</userinput></screen>

  <para>
    L'état du groupe de volumes peut être vérifié en lançant la commande
<command>vgscan</command>. Maintenant créez les volumes logiques.  Comme il
y a environ 3900 Go d'espace disponible, laissez environ 900 Go d'espace
libre pour l'expansion.  Notez que le volume logique appelé
<emphasis>mysql</emphasis> est plus grand que chacun des disques physiques.
  </para>

  <screen><userinput>lvcreate --name mysql --size 2500G lfs-lvm
lvcreate --name home  --size  500G lfs-lvm</userinput></screen>

  <para>
    Finalement les volumes logiques peuvent être formatés et montés. Dans cet
exemple, Le système de fichier jfs (<xref linkend="jfsutils"/>) est utilisé
pour la démonstration.
  </para>

  <screen><userinput>mkfs -t ext4 /dev/lfs-lvm/home
mkfs -t jfs  /dev/lfs-lvm/mysql
mount /dev/lfs-lvm/home /home
mkdir -p /srv/mysql
mount /dev/lfs-lvm/mysql /srv/mysql</userinput></screen>

  <para>
    Il peut être nécessaire d'activer ces volumes logique pour qu'ils
apparaissent dans <filename class="directory">/dev</filename>. Vous pouvez
tous les activer en même temps en lançant, en tant qu'utilisateur
<systemitem class="username">root</systemitem>&nbsp;:
  </para>

<screen role="root"><userinput>vgchange -a y</userinput></screen>

  <para revision="sysv">
    Les scripts de démarrage de LFS rendront automatiquement ces volumes
logiques disponibles dans le script <command>udev</command>. Modifiez le
fichier <filename>/etc/fstab</filename> comme vous le souhaitez pour les
monter automatiquement.
  </para>

  <para>
    Un volume logique LVM peut accueillir un système de fichier racine, mais
nécessite l'utilisation d'un initramfs (initial RAM file
system). L'initramfs proposé dans <xref linkend="initramfs"/> permet de
passer le volume lvm dans le paramètre <parameter>root=</parameter> de la
ligne de commande du noyau.
  </para>

  <para revision="systemd">
    Si vous n'utilisez pas un initramfs, cela engendre une situation de
compétition dans <application>systemd</application> qui empêche le montage
des volumes logiques avec <filename>/etc/fstab</filename>. Vous devez créer
une unité <quote>mount</quote> (voir systemd.mount(5)) comme dans l'exemple
suivant, qui monte le répertoire <filename
class="directory">/home</filename> automatiquement au démarrage&nbsp;:
  </para>

<screen role="root" revision="systemd"><userinput>cat &gt; /etc/systemd/system/home.mount &lt;&lt; EOF
<literal>[Unit]
Description=Mount the lvm volume /dev/lfs-lvm/home to /home

[Mount]
What=/dev/lfs-lvm/home
Where=/home
Type=ext4
Options=default

[Install]
WantedBy=multi-user.target</literal>
EOF</userinput></screen>

  <note revision="systemd">
    <para>
    Le nom de l'unité doit être le nom du point de montage avec le caractère
«&nbsp;/&nbsp;» remplacé par le caractère «&nbsp;-&nbsp;», en omettant le
premier.
    </para>
  </note>

  <para revision="systemd">
    Ensuite l'unité doit être activée avec&nbsp;:
  </para>

<screen role="root" revision="systemd"><userinput>systemctl enable home.mount</userinput></screen>

  <para>
    Pour plus d'information sur LVM, voir le <ulink
url="http://www.tldp.org/HOWTO/LVM-HOWTO/">LVM HOWTO</ulink> et les pages de
manuel de lvm. Un bon <ulink
url="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/logical_volume_manager_administration/index">guide</ulink>
en profondeur se trouve chez RedHat<superscript>&reg;</superscript>, même
s'il fait parfois référence à des outils non libres.
  </para>

</sect1>
