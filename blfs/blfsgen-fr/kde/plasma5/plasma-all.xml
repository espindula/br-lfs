<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
 <!ENTITY % general-entities SYSTEM "../../general.ent">
 %general-entities;

  <!ENTITY plasma5-download-http "https://download.kde.org/stable/plasma/&plasma5-version;">
  <!ENTITY plasma5-download-ftp  "">
  <!ENTITY plasma5-md5sum        "Voir ci-dessous">
  <!ENTITY plasma5-size          "242&nbsp;Mo">
  <!ENTITY plasma5-buildsize     "1,7&nbsp;Go (419&nbsp;Mo installés)">
  <!ENTITY plasma5-time          "19&nbsp;SBU (avec parallélisme = 4)">
]>

<sect1 id="plasma5-build" xreflabel="Plasma-&plasma5-version;">
  <?dbhtml filename="plasma-all.html"?>


  <title>Construction de Plasma 5</title>

  <indexterm zone="plasma5-build">
     <primary sortas="a-kde-plasma">KDE Plasma 5</primary>
  </indexterm>

  <para>
    KDE Plasma 5 est une collection de paquets basés sur KDE Frameworks 5 et
QML. Ils implémentent l'environnement d'affichage KDE (Plasma 5).
  </para>

  &lfs113_checked;

  <para>
    Les instructions suivantes construisent tous les paquets Plasma 5 en une
étape en utilisant un script bash.
  </para>

  <bridgehead renderas="sect3">Informations sur le paquet</bridgehead>
  <itemizedlist spacing="compact">
    <listitem>
      <para>
        Téléchargement (HTTP)&nbsp;: <ulink url="&plasma5-download-http;"/>
      </para>
    </listitem>
    <listitem>
      <para>
        Téléchargement (FTP)&nbsp;: <ulink url="&plasma5-download-ftp;"/>
      </para>
    </listitem>
    <listitem>
      <para>
        Somme de contrôle MD5&nbsp;: &plasma5-md5sum;
      </para>
    </listitem>
    <listitem>
      <para>
        Taille du téléchargement&nbsp;: &plasma5-size;
      </para>
    </listitem>
    <listitem>
      <para>
        Estimation de l'espace disque requis&nbsp;: &plasma5-buildsize;
      </para>
    </listitem>
    <listitem>
      <para>
        Estimation du temps de construction&nbsp;: &plasma5-time;
      </para>
    </listitem>
  </itemizedlist>

  <bridgehead renderas="sect3">Dépendances de Plasma 5</bridgehead>

  <bridgehead renderas="sect4">Requises</bridgehead>
  <para role="required">
    <xref linkend="gtk2"/>, <xref linkend="gtk3"/>, <xref
linkend="kf5-frameworks"/>, <xref linkend="kuserfeedback"/>, <xref
linkend="libpwquality"/>, <xref linkend="libqalculate"/>, <xref
linkend="libxkbcommon"/>, <xref linkend="mesa"/> construit avec <xref
linkend="wayland"/>, <xref linkend="NetworkManager"/>, <xref
linkend="pipewire"/>, <xref linkend="pulseaudio"/>, <xref linkend="qca"/>,
<xref linkend="sassc"/>, <xref linkend="taglib"/> et <xref
linkend="xcb-util-cursor"/>
  </para>

  <bridgehead renderas="sect4">Recommandées</bridgehead>
  <para role="recommended">
    <xref linkend="fftw"/>, <xref linkend="gsettings-desktop-schemas"/>, <xref
linkend="libdbusmenu-qt"/>, <xref linkend="libcanberra"/>, <xref
linkend="libinput"/>, <xref linkend="libpcap"/>, <xref
linkend="linux-pam"/>, <xref linkend="lm_sensors"/>, <xref
linkend="oxygen-icons5"/> et <xref linkend="pciutils"/>
  </para>

  <bridgehead renderas="sect4">Recommandées (à l'exécution)</bridgehead>
  <para role="recommended">
    <xref role="runtime" linkend="accountsservice"/>, <xref role="runtime"
linkend="smartmontools"/> et <xref role="runtime" linkend="xwayland"/>
  </para>

  <bridgehead renderas="sect4">Facultatives</bridgehead>
  <para role="optional">
    <xref linkend="glu"/>, <xref linkend='ibus'/>, <xref
linkend='qtwebengine'/>, <xref linkend="xorg-synaptics-driver"/>, <ulink
url="https://distributions.freedesktop.org/wiki/AppStream">appstream-qt</ulink>,
<ulink url="https://www.kdevelop.org/">KDevPlatform</ulink>, <ulink
url="https://gpsd.gitlab.io/gpsd/">libgps</ulink>, <ulink
url="https://github.com/libhybris/libhybris">libhybris</ulink>, <ulink
url="https://sourceforge.net/projects/libraw1394/">libraw1394</ulink>,
<ulink url="https://bitbucket.org/godsme/mockcpp">mockcpp</ulink>, <ulink
url="https://www.freedesktop.org/software/PackageKit/releases/">packagekit-qt</ulink>,
<ulink url="https://qalculate.github.io/">Qalculate</ulink>, <ulink
url="https://launchpad.net/qapt">Qapt</ulink>, <ulink
url="https://github.com/osiam/osiam">SCIM</ulink> et <ulink
url="http://www.dest-unreach.org/socat/">socat</ulink> (for pam_kwallet)
  </para>

  <note>
    <para>
      <xref linkend="qtwebengine"/> is required for aura-browser.  It is also
optional for two other packages: libksysguard and kdeplasma-addons. If
QtWebEngine is installed later, only these two packages need to be
rebuilt. This allows a more complete display in the system monitor
application.
    </para>
  </note>

  <para condition="html" role="usernotes">Notes des rédacteurs&nbsp;: <ulink url="&blfs-wiki;/kf5"/></para>

  <sect2>
    <title>Téléchargement de KDE Plasma5</title>

    <para>
      La meilleure façon d'avoir les paquets de KDE Plasma5 est d'utiliser un seul
<command>wget</command> pour les avoir tous en même temps&nbsp;:
    </para>

<screen><userinput>url=https://download.kde.org/stable/plasma/&plasma5-version;/
wget -r -nH -nd -A '*.xz' -np $url</userinput>
<literal>
Les options utilisée ici sont :
  -r            récupère les répertoires enfants
  -nH           désactive la génération de répertoires commençant pour le nom d'hôte
  -nd           ne crée pas de hiérarchie de répertoires
  -A '*.xz'     récupère uniquement les fichiers *.xz
  -np           ne récupère pas les répertoires parents</literal></screen>

   </sect2>

  <sect2>
    <title>Initialisation de l'ordre des paquets</title>

    <para>
      L'ordre de construction des fichiers est important à cause des dépendances
internes. Créez la liste des fichiers dans le bon ordre comme suit&nbsp;:
    </para>

<screen><userinput>cat &gt; plasma-&plasma5-version;.md5 &lt;&lt; "EOF"
<literal>51e9302eb0654fae37d3962626ff4fbb  kdecoration-5.27.5.tar.xz
74bde56139ac985dcbdc2367a70b9bca  libkscreen-5.27.5.tar.xz
b7247c962c5d25adab4319b61658a084  libksysguard-5.27.5.tar.xz
82968d40f62140cee86aea36a906bd83  breeze-5.27.5.tar.xz
aeaa28b4191c882cc18fc4e411e8a2e4  breeze-gtk-5.27.5.tar.xz
af0607ef8312a85428229118b62c88fe  layer-shell-qt-5.27.5.tar.xz
4694667b6f766583b4c82a080a927604  kscreenlocker-5.27.5.tar.xz
06d8187c1365ea93a6b6c944e357e6c0  oxygen-5.27.5.tar.xz
2dbc2bb816a2e20d09f969ad3a939845  kinfocenter-5.27.5.tar.xz
9dcdcf269faee1e5370840f6e8b7eb7f  kwin-5.27.5.tar.xz
6d8eebad15cca79e694360ffddb06ac0  plasma-workspace-5.27.5.tar.xz
c35e7d44a3d183c870a5a867ea87703f  plasma-disks-5.27.5.tar.xz
ff679b3b315c98baeae249a09c060a86  bluedevil-5.27.5.tar.xz
400c30c063f2c4c6e1b1f876c25e3772  kde-gtk-config-5.27.5.tar.xz
bde2e79070e499d26586a480e9ee36a5  khotkeys-5.27.5.tar.xz
8b0a697df18d02c7eb33b6378cbd4d45  kmenuedit-5.27.5.tar.xz
d2c3d8dcd306b426a3c6ff1eed6c1133  kscreen-5.27.5.tar.xz
a73ad8b4251c5661f6f19eb1d74ba1bf  kwallet-pam-5.27.5.tar.xz
f409d7176b62b0c7c1fd6bae483f727c  kwayland-integration-5.27.5.tar.xz
41e446151576173a39ae8129d2eccac2  kwrited-5.27.5.tar.xz
219d1e6af7aba7333af2b3016ae4c548  milou-5.27.5.tar.xz
03de7063c72469e7ee0f152db471f84a  plasma-nm-5.27.5.tar.xz
612efae7cd722f5f1e3896c3bf3fb161  plasma-pa-5.27.5.tar.xz
50fa6015315c82976426760552d46d7f  plasma-workspace-wallpapers-5.27.5.tar.xz
058a604c6ea8e0ae64f5878a7e5944b8  polkit-kde-agent-1-5.27.5.tar.xz
672a9b07e3725c26318edbab4b9e128e  powerdevil-5.27.5.tar.xz
6d10296d88754fae5c246aa73c3f9059  plasma-desktop-5.27.5.tar.xz
5b69ac7f3f160640aee2fe2fb1c6d024  kgamma5-5.27.5.tar.xz
b6c9189955d602662672298c50758b0e  ksshaskpass-5.27.5.tar.xz
#a46c94604166a9a2feb748ee8c82e86d  plasma-sdk-5.27.5.tar.xz
9fbd2a51814d3ca86371df990643f93a  sddm-kcm-5.27.5.tar.xz
#3f192d5ae11e72dedee2686ca1fd5133  discover-5.27.5.tar.xz
#7fdd06cfba4d5e33cfc332be0235635e  breeze-grub-5.27.5.tar.xz
#f4d52827d548f61957fa81e232a9413a  breeze-plymouth-5.27.5.tar.xz
cad575c607ef907af5138fee59a0c5b7  kactivitymanagerd-5.27.5.tar.xz
6b748c004da6d5b3528c08a93bf1a0f7  plasma-integration-5.27.5.tar.xz
#59b6d2dd34435697fe18e564ed78a511  plymouth-kcm-5.27.5.tar.xz
cda052cd8e5e93079b90ecd32878e8c2  xdg-desktop-portal-kde-5.27.5.tar.xz
df38490abd84e1dab33bb0a71749ddef  drkonqi-5.27.5.tar.xz
e7480e7771f736742b9ac60cd9bc1cc5  plasma-vault-5.27.5.tar.xz
c2f27e9822a4e7ccf973d75a0a3883f5  plasma-browser-integration-5.27.5.tar.xz
73ba745f7b31dd74c5ac60b3fe311f59  kde-cli-tools-5.27.5.1.tar.xz
c598c2329e43a3bb6a2da6c555341272  systemsettings-5.27.5.tar.xz
091b75af67a85285ec321f7fa4ebe25a  plasma-thunderbolt-5.27.5.tar.xz
#1b35ba803eb94218d6f91a6a285259ef  plasma-nano-5.27.5.tar.xz
#4d24bc44142da6aee054b5ba0ceda8de  plasma-mobile-5.27.5.tar.xz
909a2118673360130dca8b2b104c988b  plasma-firewall-5.27.5.tar.xz
aec129bb64448e92d8abcdee54e7c29a  plasma-systemmonitor-5.27.5.tar.xz
6bc2603e9b50728639a0274ed108ebf1  qqc2-breeze-style-5.27.5.tar.xz
453d047ecb4b0de02babe74b435110a1  ksystemstats-5.27.5.tar.xz
50d577a781cf009b6d56766cd9ce801e  oxygen-sounds-5.27.5.tar.xz
#98ad50d4bd635c28b33e498855ac5125  aura-browser-5.27.5.tar.xz
ef10140df619daa2b82b22f77e07a4c9  kdeplasma-addons-5.27.5.tar.xz
6ffe6e00493ade07b452ab9d30385d77  kpipewire-5.27.5.tar.xz
a185c7f09b9b81683e85d884f9be1e1e  plank-player-5.27.5.tar.xz
d520bce789eae5a0d9ba9432de5d76ac  plasma-bigscreen-5.27.5.tar.xz
a1d5c114997f50bc6a6e1c40cc63009c  plasma-remotecontrollers-5.27.5.tar.xz
#f96194446cb04af657dc4abc1634d7af  flatpak-kcm-5.27.5.tar.xz
#47263a34137f46e168332de80c46a168  plasma-welcome-5.27.5.tar.xz</literal>
EOF</userinput></screen>

    <note>
      <title>À propos des paquets commentés</title>
      <para>
        The breeze-grub, breeze-plymouth, and plymouth-kcm packages above are all
for customized support of <ulink
url="https://www.freedesktop.org/wiki/Software/Plymouth/" >Plymouth</ulink>
which is designed to be run within an initial ram disk during boot (see
<xref linkend="initramfs"/>).  The plasma-sdk package is optional and used
for software development.  The plasma-nano package is used for embedded
systems and plasma-mobile provides phone functionality for Plasma.  The
aura-browser package requires <xref linkend="qtwebengine"/>.  The discover
package requires the external package <ulink
url="https://distributions.freedesktop.org/wiki/AppStream">
appstream-qt</ulink>.  The plasma-welcome package requires the external
package <ulink
url="https://download.kde.org/stable/release-service/&kf5apps-version;/src/">
kaccounts-integration</ulink>.  The flatpack-kcm package is for managing
support of flatpack applications.
      </para>
    </note>

  </sect2>

  <sect2 role="installation">
    <title>Installation de Plasma5</title>

    &as_root;

    <para>
      Commencez par démarrer un sous-shell qui sortira s'il y a une erreur&nbsp;:
    </para>

<screen><userinput>bash -e</userinput></screen>

    <para>
      Installez tous les paquets en exécutant les commandes suivantes&nbsp;:
    </para>

<screen><!--
       # Fix some build issues when generating some configuration files
       case $name in
         plasma-workspace)
           sed -i '/set.HAVE_X11/a set(X11_FOUND 1)' CMakeLists.txt
         ;;

         khotkeys)
           sed -i '/X11Extras/a set(X11_FOUND 1)' CMakeLists.txt
         ;;

         plasma-desktop)
           sed -i '/X11.h)/i set(X11_FOUND 1)' CMakeLists.txt
         ;;
       esac
-->
<!-- some packages end up with files owned by root in $packagedir,
     so use as_root for removing -->
<userinput>while read -r line; do

    # Get the file name, ignoring comments and blank lines
    if $(echo $line | grep -E -q '^ *$|^#' ); then continue; fi
    file=$(echo $line | cut -d" " -f2)

    pkg=$(echo $file|sed 's|^.*/||')          # Remove directory
    packagedir=$(echo $pkg|sed 's|\.tar.*||') # Package directory

    tar -xf $file
    pushd $packagedir

       mkdir build
       cd    build

       cmake -DCMAKE_INSTALL_PREFIX=$KF5_PREFIX \
             -DCMAKE_BUILD_TYPE=Release         \
             -DBUILD_TESTING=OFF                \
             -Wno-dev ..  &amp;&amp;

        make
        as_root make install
    popd


    as_root rm -rf $packagedir
    as_root /sbin/ldconfig

done &lt; plasma-&plasma5-version;.md5

exit</userinput></screen>

    <para>
      Si vous n'avez pas configuré <envar>$KF5_PREFIX</envar> à
<filename>/usr</filename>, créez des liens symboliques pour permettre aux
gestionnaires d'affichage de trouver
<application>Plasma</application>&nbsp;:
    </para>

<screen><!--
cd $KF5_PREFIX/share/plasma/plasmoids

for j in $(find -name \*.js); do
  as_root ln -sfv ../code/$(basename $j) $(dirname $j)/../ui/
done-->
<userinput>as_root install -dvm 755 /usr/share/xsessions              &amp;&amp;
cd /usr/share/xsessions/                                   &amp;&amp;
[ -e plasma.desktop ]                                      ||
as_root ln -sfv $KF5_PREFIX/share/xsessions/plasma.desktop &amp;&amp;
as_root install -dvm 755 /usr/share/wayland-sessions       &amp;&amp;
cd /usr/share/wayland-sessions/                            &amp;&amp;
[ -e plasmawayland.desktop ]                               ||
as_root ln -sfv $KF5_PREFIX/share/wayland-sessions/plasmawayland.desktop</userinput></screen>

    <para revision="sysv">
      Des unités systemd inutiles ont été installées dans <filename
class="directory">$KF5_PREFIX/lib</filename>. Supprimez-les maintenant (en
tant que <systemitem class="username">root</systemitem>)&nbsp;:
    </para>

<screen role="root"
        revision="sysv"><userinput>rm -rf $KF5_PREFIX/lib/systemd</userinput></screen>

  </sect2>

  <!--
    <sect2 role="commands">

    <title>Command Explanations</title>

    <para>
      <command>ln -sfv ../code/$(basename $j) $(dirname $j)/../ui/</command>:
      Create symbolic links so qml files can find needed javascript modules.
    </para>

  </sect2>
-->
<sect2 role="configuration">
    <title>Configuration de Plasma</title>

    <sect3>
      <title>Configuration de Linux PAM</title>

      <para>
        Si vous avez construit Plasma avec le support recommandé de
<application>Linux PAM</application>, créez les fichiers de configuration
nécessaires en exécutant les commandes suivantes en tant qu'utilisateur
<systemitem class="username">root</systemitem>&nbsp;:
      </para>

<screen role="root"><userinput>cat &gt; /etc/pam.d/kde &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kde

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid &gt;= 1000 quiet
auth     include        system-auth

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde</literal>
EOF

cat &gt; /etc/pam.d/kde-np &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kde-np

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid &gt;= 1000 quiet
auth     required       pam_permit.so

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde-np</literal>
EOF

cat &gt; /etc/pam.d/kscreensaver &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kscreensaver

auth    include system-auth
account include system-account

# End /etc/pam.d/kscreensaver</literal>
EOF</userinput></screen>
    </sect3>
  </sect2>

  <sect2 role="starting">
    <title>Démarrage de Plasma5</title>

    <para revision="sysv">
      Vous pouvez démarrer <application>Plasma5</application> depuis le niveau
d'exécution 3, en utilisant <xref linkend="xinit"/>, ou depuis le niveau
d'exécution 5, en utilisant un gestionnaire d'affichage, tel que <xref
linkend="lightdm"/>.
    </para>

    <para revision="systemd">
      <!--, or from a graphical display manager, such as
      <xref linkend="sddm"/>
-->
Vous pouvez démarrer <application>Plasma5</application> depuis un TTY avec
<xref linkend="xinit"/>.
    </para>

    <para>
      Pour démarrer <application>Plasma5</application> en utilisant <xref
linkend="xinit"/>, lancez les commandes suivantes&nbsp;:
    </para>

<screen><userinput>cat &gt; ~/.xinitrc &lt;&lt; "EOF"
<literal>dbus-launch --exit-with-x11 $KF5_PREFIX/bin/startplasma-x11</literal>
EOF

startx</userinput></screen>

    <para>
      La session X démarre dans le premier terminal virtuel inutilisé, normalement
vt7. Vous pouvez passer à un autre vt<emphasis>n</emphasis> en appuyant
simultanément sur les touches Ctrl-Alt-F<emphasis>n</emphasis>
(<emphasis>n</emphasis>=1, 2, ...). Pour aller sur la session X, normalement
démarrée sur vt7, utilisez Ctrl-Alt-F7. Le vt où la commande
<command>startx</command> est exécuté affichera beaucoup de messages,
incluant les messages de démarrage de X, les applications automatiquement
démarrées avec la session et, éventuellement, quelques avertissements et
messages d'erreur. Vous pouvez préférer rediriger ces messages dans un
fichier de log, qui non seulement laissera le vt initial propre, mais qui
pourra aussi être utilisé pour des questions de débogage. Cela peut être
fait en démarrant X avec&nbsp;:
    </para>

    <screen><userinput>startx &amp;&gt; ~/x-session-errors</userinput></screen>

    <para>
      Au redémarrage ou à l'arrêt, les messages d'arrêt apparaissent sur le vt où
X était lancé. Si vous voulez voir ces messages, appuyez simultanément sur
Alt-F7 (en considérant que X était lancé sur vt7).
    </para>


  <!-- Now the entry is "plasma (X11)" for Xorg, so I guess this is
     not needed anymore:
    <para>

      If you intend to start <application>Plasma</application> using a
    display manager such as <xref linkend="lightdm"/>, there will be two entries
    for <application>Plasma</application>, one for use with
    <application>Xorg</application>, and another for
    <application>Wayland</application>. Modify the
    <application>Xorg</application> entry with the following command, as the
    <systemitem class="username">root</systemitem> user, so that you can
    differentiate between the two:</para>

<screen role="root"><userinput>sed '/^Name=/s/Plasma/Plasma on Xorg/' -i /usr/share/xsessions/plasma.desktop</userinput></screen>
-->
</sect2>

  <sect2 role="content">
    <title>Contenu</title>

    <segmentedlist>
      <segtitle>Programmes installés</segtitle>
      <segtitle>Bibliothèques installées</segtitle>
      <segtitle>Répertoires installés</segtitle>

      <seglistitem>
        <seg>
           Il y a trop de programmes plasma (63 dans /opt/kf5/bin) pour les lister
séparément ici.
        </seg>
        <seg>
           Il y a trop de bibliothèques plasma (40 dans /opt/kf5/lib) pour les lister
séparément ici.
        </seg>
        <seg>
           Il y a trop de répertoires plasma (plus de 1000 dans /opt/kf5) pour les
lister séparément ici.
        </seg>
      </seglistitem>
    </segmentedlist>

  </sect2>

</sect1>
