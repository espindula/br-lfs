<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
 <!ENTITY % general-entities SYSTEM "../../general.ent">
 %general-entities;

  <!ENTITY plasma5-download-http "https://download.kde.org/stable/plasma/&plasma5-version;">
  <!ENTITY plasma5-download-ftp  "">
  <!ENTITY plasma5-md5sum        "Voir ci-dessous">
  <!ENTITY plasma5-size          "130&nbsp;Mo">
  <!ENTITY plasma5-buildsize     "1,6 Go (355 Mo installés)">
  <!ENTITY plasma5-time          "14&nbsp;SBU (avec parallélisme = 4)">
]>

<sect1 id="plasma5-build" xreflabel="Plasma-&plasma5-version;">
  <?dbhtml filename="plasma-all.html"?>

  <sect1info>
<date>$Date$</date></sect1info>

  <title>Construction de Plasma 5</title>

  <indexterm zone="plasma5-build">
     <primary sortas="a-kde-plasma">KDE Plasma 5</primary>
  </indexterm>

  <para>
    KDE Plasma 5 est une collection de paquets basés sur KDE Frameworks 5 et
QML. Ils implémentent l'environnement d'affichage KDE (Plasma 5).
  </para>

  &lfs101_checked;

  <para>
    Les instructions suivantes construisent tous les paquets Plasma 5 en une
étape en utilisant un script bash.
  </para>

  <bridgehead renderas="sect3">Informations sur le paquet</bridgehead>
  <itemizedlist spacing="compact">
    <listitem>
      <para>
        Téléchargement (HTTP)&nbsp;: <ulink url="&plasma5-download-http;"/>
      </para>
    </listitem>
    <listitem>
      <para>
        Téléchargement (FTP)&nbsp;: <ulink url="&plasma5-download-ftp;"/>
      </para>
    </listitem>
    <listitem>
      <para>
        Somme de contrôle MD5 du téléchargement&nbsp;: &plasma5-md5sum;
      </para>
    </listitem>
    <listitem>
      <para>
        Taille du téléchargement&nbsp;: &plasma5-size;
      </para>
    </listitem>
    <listitem>
      <para>
        Estimation de l'espace disque requis&nbsp;: &plasma5-buildsize;
      </para>
    </listitem>
    <listitem>
      <para>
        Estimation du temps de construction&nbsp;: &plasma5-time;
      </para>
    </listitem>
  </itemizedlist>

  <bridgehead renderas="sect3">Dépendances de Plasma 5</bridgehead>

  <bridgehead renderas="sect4">Requises</bridgehead>
  <para role="required">
    
    <!--<xref linkend="fontforge"/>
,-->
<xref linkend="GConf"/>, <xref linkend="gtk2"/>, <xref linkend="gtk3"/>,
<xref linkend="kf5-frameworks"/>, <xref linkend="libpwquality"/>, <xref
linkend="libxkbcommon"/>, <xref linkend="mesa"/> construit avec <xref
linkend="wayland"/>, <xref linkend="NetworkManager"/>, <xref
linkend="pipewire"/>, <xref linkend="pulseaudio"/>, <xref linkend="qca"/>,
<xref linkend="sassc"/>, <xref linkend="taglib"/> et <xref
linkend="xcb-util-cursor"/>
  </para>

  <bridgehead renderas="sect4">Recommandées</bridgehead>
  <para role="recommended">
    <xref linkend="fftw"/>, <xref linkend="gsettings-desktop-schemas"/>, <xref
linkend="libdbusmenu-qt"/>, <xref linkend="libcanberra"/>, <xref
linkend="libinput"/>, <xref linkend="linux-pam"/>, <xref
linkend="lm_sensors"/>, <xref linkend="oxygen-icons5"/> et <xref
linkend="pciutils"/>
  </para>

  <bridgehead renderas="sect4">Recommandées (à l'exécution)</bridgehead>
  <para role="recommended">
    <xref role="runtime" linkend="smartmontools"/>
  </para>

  <bridgehead renderas="sect4">Facultatives</bridgehead>
  <para role="optional">
    <xref linkend="glu"/>, <xref linkend='ibus'/>, <xref
linkend="xorg-synaptics-driver"/>, <ulink
url="http://distributions.freedesktop.org/wiki/AppStream">appstream-qt</ulink>,
<ulink url="https://www.kdevelop.org/">KDevPlatform</ulink>, <ulink
url="https://gpsd.gitlab.io/gpsd/">libgps</ulink>, <ulink
url="https://github.com/libhybris/libhybris">libhybris</ulink>, <ulink
url="https://sourceforge.net/projects/libraw1394/">libraw1394</ulink>,
<ulink url="https://bitbucket.org/godsme/mockcpp">mockcpp</ulink>, <ulink
url="https://www.freedesktop.org/software/PackageKit/releases/">packagekit-qt</ulink>,
<ulink url="http://qalculate.github.io/">Qalculate</ulink>, <ulink
url="https://launchpad.net/qapt">Qapt</ulink>, <ulink
url="https://github.com/osiam/osiam">SCIM</ulink> et <ulink
url="http://www.dest-unreach.org/socat/">socat</ulink> (pour pam_kwallet)
  </para>

  <para condition="html" role="usernotes">Notes utilisateur&nbsp;: <ulink url="&blfs-wiki;/kf5"/></para>

  <sect2>
    <title>Téléchargement de KDE Plasma5</title>

    <para>
      La meilleure façon d'avoir les paquets de KDE Plasma5 est d'utiliser un seul
<command>wget</command> pour les avoir tous en même temps&nbsp;:
    </para>

<screen><userinput>url=https://download.kde.org/stable/plasma/&plasma5-version;/
wget -r -nH -nd -A '*.xz' -np $url</userinput>
<literal>
Les options utilisée ici sont :
  -r            récupère les répertoires enfants
  -nH           désactive la génération de répertoires commençant pour le nom d'hôte
  -nd           ne crée pas de hiérarchie de répertoires
  -A '*.xz'     récupère uniquement les fichiers *.xz
  -np           ne récupère pas les répertoires parents</literal></screen>

   </sect2>

  <sect2>
    <title>Initialisation de l'ordre des paquets</title>

    <para>
      L'ordre de construction des fichiers est important à cause des dépendances
internes. Créez la liste des fichiers dans le bon ordre comme suit&nbsp;:
    </para>

<screen><userinput>cat &gt; plasma-&plasma5-version;.md5 &lt;&lt; "EOF"
<literal>b94892460a9cfe1664ecd1e254285849  kdecoration-5.22.1.tar.xz
18e02542b87f3d936c45f2423ce1fe80  libkscreen-5.22.1.tar.xz
831c221ec0d988e8d264a405512a251f  libksysguard-5.22.1.tar.xz
7bc476b96f65b9a5bcba2fd54eedc4d9  breeze-5.22.1.tar.xz
a128e672d86330336528b482f8ff33a9  breeze-gtk-5.22.1.tar.xz
874eab1bca3ca9673a445050b4746637  layer-shell-qt-5.22.1.tar.xz
94bd1cf5cca0d378b19926bb0e3036fc  kscreenlocker-5.22.1.tar.xz
c7e0ef8224eb580aa035b51cba0b63d1  oxygen-5.22.1.tar.xz
fa40eff2f9e941cb6a77da812e973666  kinfocenter-5.22.1.tar.xz
7cda86a2c472a663dae635dbcac08553  kwayland-server-5.22.1.tar.xz
6149319d541eaff89ffff305b259faa4  kwin-5.22.1.tar.xz
d2933e9d1a4ae2de40bb5937e7951791  plasma-workspace-5.22.1.tar.xz
69f39c490a95b1f336827f42cd0feea0  plasma-disks-5.22.1.tar.xz
77f08a94baacf616d919d995e245f56c  bluedevil-5.22.1.tar.xz
b4610ac61deb1996360d6c4451af4734  kde-gtk-config-5.22.1.tar.xz
1decbacec448cdd42974bbebed545fdf  khotkeys-5.22.1.tar.xz
b4e04666701fdcc9f663768f9b42f297  kmenuedit-5.22.1.tar.xz
b888e1d936905bc3e5aea36788d86023  kscreen-5.22.1.tar.xz
7b83e914db66c4c86ace9f052d1a644d  kwallet-pam-5.22.1.tar.xz
d3cf7595e613aee35c7d0ad0ee5c51a3  kwayland-integration-5.22.1.tar.xz
a34af5bfb97499d2a99011a823dd1a11  kwrited-5.22.1.tar.xz
1dbec1654fefd61cdacf115fcc91236d  milou-5.22.1.tar.xz
b391404db79efccd99869ba577240522  plasma-nm-5.22.1.tar.xz
5530b55795634f454876f365106ea065  plasma-pa-5.22.1.tar.xz
b980ccb5cfe0c1bfdc283250d7b2f130  plasma-workspace-wallpapers-5.22.1.tar.xz
0c3fcdf2ac6c9dc17422f1c527f47558  polkit-kde-agent-1-5.22.1.tar.xz
ea9c6324ce9ee03202182afb31397545  powerdevil-5.22.1.tar.xz
9a3464909cacd130dfd8c933094d2399  plasma-desktop-5.22.1.tar.xz
92476c8f8fd8e40fa3b020993589b152  kdeplasma-addons-5.22.1.tar.xz
94086410aff644ef8c8bb07079fea822  kgamma5-5.22.1.tar.xz
a0457e8cd66555b589e75bdfcfa985c1  ksshaskpass-5.22.1.tar.xz
#8d1809121246ff9cf4a7c3a479c44a71  plasma-sdk-5.22.1.tar.xz
7f4e4aaa9af85e73edb4a0845a92750c  sddm-kcm-5.22.1.tar.xz
443256fde9c7c99fef6b07653286889a  discover-5.22.1.tar.xz
#2288e8e85751fb2d0dbaacb1080ab1b0  breeze-grub-5.22.1.tar.xz
#e3f6c3ab94e7b816852416fef3b91f09  breeze-plymouth-5.22.1.tar.xz
973c724942d8497cc6a08ba4e5320f3a  kactivitymanagerd-5.22.1.tar.xz
88649ff927b250800fb3d731ce75367d  plasma-integration-5.22.1.tar.xz
10098e2a4933cd20e2e7708ea34ca1cf  plasma-tests-5.22.1.tar.xz
#f5d9d6951b38a88dedcedd5520f1ed09  plymouth-kcm-5.22.1.tar.xz
aac607dce5c3683ad1d6f2daeafb64fa  xdg-desktop-portal-kde-5.22.1.tar.xz
200f3c5093e3b9e21ddc6fd9645302de  drkonqi-5.22.1.tar.xz
e393e4b1e259a5ce2022d980bba4e0fd  plasma-vault-5.22.1.tar.xz
3b1e8f7761224959757a3b698046694d  plasma-browser-integration-5.22.1.tar.xz
99bd2e016ecf2fa994ddc236f823fc83  kde-cli-tools-5.22.1.tar.xz
904eb7c0af86a65e348a4c2211cc6e20  systemsettings-5.22.1.tar.xz
4357b2ef8ef57b6e7e8bcb70bb60428c  plasma-thunderbolt-5.22.1.tar.xz
#cd751995ac6d1b8195c4e4ebc10aabbf  plasma-nano-5.22.1.tar.xz
#dcb106786e6f1bb783df95c09b028e48  plasma-phone-components-5.22.1.tar.xz
9805d9bf07217766496edcb6a30ace35  plasma-firewall-5.22.1.tar.xz
698018452cb155b9502bf3f500bb9b21  plasma-systemmonitor-5.22.1.tar.xz
255179a1585d56c178c38a1ec09fd2ac  qqc2-breeze-style-5.22.1.tar.xz
a9513779eeef7c2642bde9ac15ab0c3c  ksystemstats-5.22.1.tar.xz</literal>
EOF</userinput></screen>

    <note>
      <para>
        Les paquets breeze-grub, breeze-plymouth et plymouth-kcm ci-dessus servent à
supporter la personnalisation de <ulink
url="https://www.freedesktop.org/wiki/Software/Plymouth/">Plymouth</ulink>
qui est conçu pour fonctionner dans un disque de ram initial pendant le
démarrage (voir <xref linkend="initramfs"/>). Le paquet plasma-sdk est
facultatif et utilisé pour le développement logiciel. Le paquet plasma-nano
est utilisé pour les systèmes embarqués et plasma-phone-components fournit
des fonctionnalités pour Plasma sur les téléphones.
      </para>
    </note>

  </sect2>

  <sect2 role="installation">
    <title>Installation de Plasma5</title>

    &as_root;

    <para>
      Commencez par démarrer un sous-shell qui sortira s'il y a une erreur&nbsp;:
    </para>

<screen><userinput>bash -e</userinput></screen>

    <para>
      Installez tous les paquets en lançant les commandes suivantes&nbsp;:
    </para>

<screen><!--
       # Fix some build issues when generating some configuration files
       case $name in
         plasma-workspace)
           sed -i '/set.HAVE_X11/a set(X11_FOUND 1)' CMakeLists.txt
         ;;
      
         khotkeys)
           sed -i '/X11Extras/a set(X11_FOUND 1)' CMakeLists.txt
         ;;
      
         plasma-desktop)
           sed -i '/X11.h)/i set(X11_FOUND 1)' CMakeLists.txt
         ;;
       esac
-->
<!-- some packages end up with files owned by root in $packagedir,
     so use as_root for removing -->
<userinput>while read -r line; do

    # Get the file name, ignoring comments and blank lines
    if $(echo $line | grep -E -q '^ *$|^#' ); then continue; fi
    file=$(echo $line | cut -d" " -f2)

    pkg=$(echo $file|sed 's|^.*/||')          # Remove directory
    packagedir=$(echo $pkg|sed 's|\.tar.*||') # Package directory

    tar -xf $file
    pushd $packagedir

       mkdir build
       cd    build

       cmake -DCMAKE_INSTALL_PREFIX=$KF5_PREFIX \
             -DCMAKE_BUILD_TYPE=Release         \
             -DBUILD_TESTING=OFF                \
             -Wno-dev ..  &amp;&amp;

        make
        as_root make install
    popd


    as_root rm -rf $packagedir
    as_root /sbin/ldconfig

done &lt; plasma-&plasma5-version;.md5

exit</userinput></screen>

    <para>
      Si vous n'avez pas configuré <envar>$KF5_PREFIX</envar> à
<filename>/usr</filename>, créez des liens symboliques pour permettre aux
gestionnaires d'affichage de trouver
<application>Plasma</application>&nbsp;:
    </para>

<screen><!--
cd $KF5_PREFIX/share/plasma/plasmoids

for j in $(find -name \*.js); do
  as_root ln -sfv ../code/$(basename $j) $(dirname $j)/../ui/
done-->
<userinput>as_root install -dvm 755 /usr/share/xsessions              &amp;&amp;
cd /usr/share/xsessions/                                   &amp;&amp;
[ -e plasma.desktop ]                                      ||
as_root ln -sfv $KF5_PREFIX/share/xsessions/plasma.desktop &amp;&amp;
as_root install -dvm 755 /usr/share/wayland-sessions       &amp;&amp;
cd /usr/share/wayland-sessions/                            &amp;&amp;
[ -e plasmawayland.desktop ]                               ||
as_root ln -sfv $KF5_PREFIX/share/wayland-sessions/plasmawayland.desktop</userinput></screen>

    <para revision="sysv">
      Des unités systemd inutiles ont été installées dans <filename
class="directory">$KF5_PREFIX/lib</filename>. Supprimez-les maintenant (en
tant que <systemitem class="username">root</systemitem>)&nbsp;:
    </para>

<screen role="root"
        revision="sysv"><userinput>rm -rf $KF5_PREFIX/lib/systemd</userinput></screen>

  </sect2>

  <!--
    <sect2 role="commands">

    <title>Command Explanations</title>

    <para>
      <command>ln -sfv ../code/$(basename $j) $(dirname $j)/../ui/</command>:
      Create symbolic links so qml files can find needed javascript modules.
    </para>

  </sect2>
-->
<sect2 role="configuration">
    <title>Configuration de Plasma</title>

    <sect3>
      <title>Configuration de Linux PAM</title>

      <para>
        Si vous avez construit Plasma avec le support recommandé de
<application>Linux PAM</application>, créez les fichiers de configuration
nécessaires en lançant les commandes suivantes en tant qu'utilisateur
<systemitem class="username">root</systemitem>&nbsp;:
      </para>

<screen role="root"><userinput>cat &gt; /etc/pam.d/kde &lt;&lt; "EOF" 
<literal># Begin /etc/pam.d/kde

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid &gt;= 1000 quiet
auth     include        system-auth

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde</literal>
EOF

cat &gt; /etc/pam.d/kde-np &lt;&lt; "EOF" 
<literal># Begin /etc/pam.d/kde-np

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid &gt;= 1000 quiet
auth     required       pam_permit.so

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde-np</literal>
EOF

cat &gt; /etc/pam.d/kscreensaver &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kscreensaver

auth    include system-auth
account include system-account

# End /etc/pam.d/kscreensaver</literal>
EOF</userinput></screen>
    </sect3>
  </sect2>

  <sect2 role="starting">
    <title>Démarrage de Plasma5</title>

    <para revision="sysv">
      Vous pouvez démarrer <application>Plasma5</application> depuis le niveau
d'exécution 3, en utilisant <xref linkend="xinit"/>, ou depuis le niveau
d'exécution 5, en utilisant un gestionnaire d'affichage, comme <xref
linkend="lightdm"/>.
    </para>

    <para revision="systemd">
      <!--, or from a graphical display manager, such as
      <xref linkend="sddm"/>
-->
Vous pouvez démarrer <application>Plasma5</application> depuis un TTY avec
<xref linkend="xinit"/>.
    </para>

    <para>
      Pour démarrer <application>Plasma5</application> en utilisant <xref
linkend="xinit"/>, lancez les commandes suivantes&nbsp;:
    </para>

<screen><userinput>cat &gt; ~/.xinitrc &lt;&lt; "EOF"
<literal>dbus-launch --exit-with-session $KF5_PREFIX/bin/startplasma-x11</literal>
EOF

startx</userinput></screen>

    <para>
      La session X démarre dans le premier terminal virtuel inutilisé, normalement
vt7. Vous pouvez passer à un autre vt<emphasis>n</emphasis> en appuyant
simultanément sur les touches Ctrl-Alt-F<emphasis>n</emphasis>
(<emphasis>n</emphasis>=1, 2, ...). Pour aller sur la session X, normalement
démarrée sur vt7, utilisez Ctrl-Alt-F7. Le vt où la commande
<command>startx</command> est exécuté affichera beaucoup de messages,
incluant les messages de démarrage de X, les applications automatiquement
démarrées avec la session, et éventuellement, quelques avertissements et
messages d'erreur. Vous pouvez préférer rediriger ces messages dans un
fichier de log, qui non seulement laissera le vt initial propre, mais pourra
aussi être utilisé pour des questions de débogage. Cela peut être fait en
démarrant X avec&nbsp;:
    </para>

    <screen><userinput>startx &amp;&gt; ~/x-session-errors</userinput></screen>

    <para>
      Au redémarrage ou à l'arrêt, les messages d'arrêt apparaissent sur le vt où
X était lancé. Si vous voulez voir ces messages, appuyez simultanément sur
Alt-F7 (en considérant que X était lancé sur vt7).
    </para>


  <!-- Now the entry is "plasma (X11)" for Xorg, so I guess this is
     not needed anymore:
    <para>

      If you intend to start <application>Plasma</application> using a
    display manager such as <xref linkend="lightdm"/>, there will be two entries
    for <application>Plasma</application>, one for use with
    <application>Xorg</application>, and another for
    <application>Wayland</application>. Modify the
    <application>Xorg</application> entry with the following command, as the
    <systemitem class="username">root</systemitem> user, so that you can
    differentiate between the two:</para>

<screen role="root"><userinput>sed '/^Name=/s/Plasma/Plasma on Xorg/' -i /usr/share/xsessions/plasma.desktop</userinput></screen>
-->
</sect2>

  <sect2 role="content">
    <title>Contenu</title>

    <segmentedlist>
      <segtitle>Programmes installés</segtitle>
      <segtitle>Bibliothèques installées</segtitle>
      <segtitle>Répertoires installés</segtitle>

      <seglistitem>
        <seg>
           Il y a trop de programmes plasma (63 dans /opt/kf5/bin) pour les lister
séparément ici.
        </seg>
        <seg>
           Il y a trop de bibliothèques plasma (40 dans /opt/kf5/lib) pour les lister
séparément ici.
        </seg>
        <seg>
           Il y a trop de répertoires plasma (plus de 1000 dans /opt/kf5) pour les
lister séparément ici.
        </seg>
      </seglistitem>
    </segmentedlist>

  </sect2>

</sect1>
