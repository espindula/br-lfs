<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
 <!ENTITY % general-entities SYSTEM "../../general.ent">
 %general-entities;

  <!ENTITY plasma5-download-http "https://download.kde.org/stable/plasma/&plasma5-version;">
  <!ENTITY plasma5-download-ftp  "">
  <!ENTITY plasma5-md5sum        "Voir ci-dessous">
  <!ENTITY plasma5-size          "140&nbsp;Mo">
  <!ENTITY plasma5-buildsize     "1,6 Go (355 Mo installés)">
  <!ENTITY plasma5-time          "18&nbsp;SBU (avec parallélisme = 4)">
]>

<sect1 id="plasma5-build" xreflabel="Plasma-&plasma5-version;">
  <?dbhtml filename="plasma-all.html"?>

  <sect1info>
<date>$Date$</date></sect1info>

  <title>Construction de Plasma 5</title>

  <indexterm zone="plasma5-build">
     <primary sortas="a-kde-plasma">KDE Plasma 5</primary>
  </indexterm>

  <para>
    KDE Plasma 5 est une collection de paquets basés sur KDE Frameworks 5 et
QML. Ils implémentent l'environnement d'affichage KDE (Plasma 5).
  </para>

  &lfs110_checked;

  <para>
    Les instructions suivantes construisent tous les paquets Plasma 5 en une
étape en utilisant un script bash.
  </para>

  <bridgehead renderas="sect3">Informations sur le paquet</bridgehead>
  <itemizedlist spacing="compact">
    <listitem>
      <para>
        Téléchargement (HTTP)&nbsp;: <ulink url="&plasma5-download-http;"/>
      </para>
    </listitem>
    <listitem>
      <para>
        Téléchargement (FTP)&nbsp;: <ulink url="&plasma5-download-ftp;"/>
      </para>
    </listitem>
    <listitem>
      <para>
        Somme de contrôle MD5 du téléchargement&nbsp;: &plasma5-md5sum;
      </para>
    </listitem>
    <listitem>
      <para>
        Taille du téléchargement&nbsp;: &plasma5-size;
      </para>
    </listitem>
    <listitem>
      <para>
        Estimation de l'espace disque requis&nbsp;: &plasma5-buildsize;
      </para>
    </listitem>
    <listitem>
      <para>
        Estimation du temps de construction&nbsp;: &plasma5-time;
      </para>
    </listitem>
  </itemizedlist>

  <bridgehead renderas="sect3">Dépendances de Plasma 5</bridgehead>

  <bridgehead renderas="sect4">Requises</bridgehead>
  <para role="required">
    
    <!--<xref linkend="fontforge"/>
,-->
<xref linkend="GConf"/>, <xref linkend="gtk2"/>, <xref linkend="gtk3"/>,
<xref linkend="kf5-frameworks"/>, <xref linkend="libpwquality"/>, <xref
linkend="libxkbcommon"/>, <xref linkend="mesa"/> construit avec <xref
linkend="wayland"/>, <xref linkend="NetworkManager"/>, <xref
linkend="pipewire"/>, <xref linkend="pulseaudio"/>, <xref linkend="qca"/>,
<xref linkend="sassc"/>, <xref linkend="taglib"/> et <xref
linkend="xcb-util-cursor"/>
  </para>

  <bridgehead renderas="sect4">Recommandées</bridgehead>
  <para role="recommended">
    <xref linkend="fftw"/>, <xref linkend="gsettings-desktop-schemas"/>, <xref
linkend="libdbusmenu-qt"/>, <xref linkend="libcanberra"/>, <xref
linkend="libinput"/>, <xref linkend="linux-pam"/>, <xref
linkend="lm_sensors"/>, <xref linkend="oxygen-icons5"/> et <xref
linkend="pciutils"/>
  </para>

  <bridgehead renderas="sect4">Recommandées (à l'exécution)</bridgehead>
  <para role="recommended">
    <xref role="runtime" linkend="smartmontools"/>
  </para>

  <bridgehead renderas="sect4">Facultatives</bridgehead>
  <para role="optional">
    <xref linkend="glu"/>, <xref linkend='ibus'/>, <xref
linkend="xorg-synaptics-driver"/>, <ulink
url="http://distributions.freedesktop.org/wiki/AppStream">appstream-qt</ulink>,
<ulink url="https://www.kdevelop.org/">KDevPlatform</ulink>, <ulink
url="https://gpsd.gitlab.io/gpsd/">libgps</ulink>, <ulink
url="https://github.com/libhybris/libhybris">libhybris</ulink>, <ulink
url="https://sourceforge.net/projects/libraw1394/">libraw1394</ulink>,
<ulink url="https://bitbucket.org/godsme/mockcpp">mockcpp</ulink>, <ulink
url="https://www.freedesktop.org/software/PackageKit/releases/">packagekit-qt</ulink>,
<ulink url="http://qalculate.github.io/">Qalculate</ulink>, <ulink
url="https://launchpad.net/qapt">Qapt</ulink>, <ulink
url="https://github.com/osiam/osiam">SCIM</ulink> et <ulink
url="http://www.dest-unreach.org/socat/">socat</ulink> (pour pam_kwallet)
  </para>

  <para condition="html" role="usernotes">Notes utilisateur&nbsp;: <ulink url="&blfs-wiki;/kf5"/></para>

  <sect2>
    <title>Téléchargement de KDE Plasma5</title>

    <para>
      La meilleure façon d'avoir les paquets de KDE Plasma5 est d'utiliser un seul
<command>wget</command> pour les avoir tous en même temps&nbsp;:
    </para>

<screen><userinput>url=https://download.kde.org/stable/plasma/&plasma5-version;/
wget -r -nH -nd -A '*.xz' -np $url</userinput>
<literal>
Les options utilisée ici sont :
  -r            récupère les répertoires enfants
  -nH           désactive la génération de répertoires commençant pour le nom d'hôte
  -nd           ne crée pas de hiérarchie de répertoires
  -A '*.xz'     récupère uniquement les fichiers *.xz
  -np           ne récupère pas les répertoires parents</literal></screen>

   </sect2>

  <sect2>
    <title>Initialisation de l'ordre des paquets</title>

    <para>
      L'ordre de construction des fichiers est important à cause des dépendances
internes. Créez la liste des fichiers dans le bon ordre comme suit&nbsp;:
    </para>

<screen><userinput>cat &gt; plasma-&plasma5-version;.md5 &lt;&lt; "EOF"
<literal>7fab69fa5fc3211b35e3d03f1172831a  kdecoration-5.22.4.tar.xz
a587fecf0473c225f39a7f8a7c611d3b  libkscreen-5.22.4.tar.xz
115f8e14d6ef58715183eb8036c431c1  libksysguard-5.22.4.tar.xz
516a58571f6daeb60a2509057e67712b  breeze-5.22.4.tar.xz
3b06f3768fc345893625ef44d7e72a98  breeze-gtk-5.22.4.tar.xz
049dabd694abed120b4f84d37f05de8c  layer-shell-qt-5.22.4.tar.xz
17af84caeb942de9a8e3d819f20645b0  kscreenlocker-5.22.4.tar.xz
ffe09b47f6cc20d13ec311edeb13a9b3  oxygen-5.22.4.tar.xz
916bfa4ce6b40ca8ef80b75018d63ab1  kinfocenter-5.22.4.tar.xz
365f7cd632d41447561ec1bdf7497bba  kwayland-server-5.22.4.tar.xz
09cf360780185b33fca9561684a0f41f  kwin-5.22.4.tar.xz
5cb1ab2a9d3ce0c05eba07ef4c8ac478  plasma-workspace-5.22.4.tar.xz
75dd5e0fed93781f0ae031a091dcce4b  plasma-disks-5.22.4.tar.xz
3d7abfe0952b356cc12cbd75be14f5e0  bluedevil-5.22.4.tar.xz
2515439a0daaf325b0fcf9ce1a537660  kde-gtk-config-5.22.4.tar.xz
8f2f4b902c98d7890dc1ec3756c27871  khotkeys-5.22.4.tar.xz
aa03bf8d1c799a4410b567b44b47f6cd  kmenuedit-5.22.4.tar.xz
6fab0d760e9e6a33255441aab3874b2f  kscreen-5.22.4.tar.xz
3dae9ce525c52ac3bacaff464dc4264c  kwallet-pam-5.22.4.tar.xz
fa9772ef7737037992aea52739aea95a  kwayland-integration-5.22.4.tar.xz
51502b6a48f2b7790364881a578cdd1b  kwrited-5.22.4.tar.xz
6d85652d5fa13953370bc4f37247e3b4  milou-5.22.4.tar.xz
61c7fc4c00637715e8d0c4491298b5b7  plasma-nm-5.22.4.tar.xz
31272515681adc5d0ca987a9dc182de5  plasma-pa-5.22.4.tar.xz
95aefdbfd0a3cd6b871e50968ccf43d9  plasma-workspace-wallpapers-5.22.4.tar.xz
9a36fb70a6d1f1f637d75a75e77eb9ba  polkit-kde-agent-1-5.22.4.tar.xz
f7860ee18c994a8b87f39965b53f4f1f  powerdevil-5.22.4.tar.xz
ba7687bdea331a62127f7cc69029c194  plasma-desktop-5.22.4.tar.xz
9c393f6da042841ed8cf41f9ad126b5c  kdeplasma-addons-5.22.4.tar.xz
bf508d7b503f1923fdb5fbd22f957981  kgamma5-5.22.4.tar.xz
239d00ede4c0e941dc6407f8510f1678  ksshaskpass-5.22.4.tar.xz
#ba59a194b4812db25022c189e129151f  plasma-sdk-5.22.4.tar.xz
3ecfe0501ce2ec0f8c8bda3a01c78be7  sddm-kcm-5.22.4.tar.xz
a81e62bd36f3db28712274da80ed52a4  discover-5.22.4.tar.xz
#9abba589089c1088e1836cabe9e593f6  breeze-grub-5.22.4.tar.xz
#d038d1db0f1ed5e80b9d22a537dd1872  breeze-plymouth-5.22.4.tar.xz
7aef306ec8c2131f0fa22d2b558f73fb  kactivitymanagerd-5.22.4.tar.xz
8c30da2b1dbcfbfaa715c050339b0e0a  plasma-integration-5.22.4.tar.xz
006171ce3edae4b67d27b1577cdc84a1  plasma-tests-5.22.4.tar.xz
#442fd33f46a982eeeb925fd6f7d919b1  plymouth-kcm-5.22.4.tar.xz
900994c0628b8b3767c83db0b4f16e0c  xdg-desktop-portal-kde-5.22.4.tar.xz
61ebe5891cf9adcd62d32c5069573ff0  drkonqi-5.22.4.tar.xz
d464d91d37cf12da1721abc18ec94140  plasma-vault-5.22.4.tar.xz
8c9a2286634cb89fb04d0278c6af8f8c  plasma-browser-integration-5.22.4.tar.xz
257e25f2388014932ecf786dd9e49bd5  kde-cli-tools-5.22.4.tar.xz
9314599d78ed6683018ff5a7b69d2a08  systemsettings-5.22.4.tar.xz
3ea20e78932f2a487d932acd1eff10f7  plasma-thunderbolt-5.22.4.tar.xz
#0ecfa8ed1962f4f842967ed7b66d14f8  plasma-nano-5.22.4.tar.xz
#157a441ad0519936dcb75856ae83010e  plasma-phone-components-5.22.4.tar.xz
71b0da480c6b91b6445b6bdbe452bdae  plasma-firewall-5.22.4.tar.xz
026a4d3cd063ba86e77c9ffa711aa769  plasma-systemmonitor-5.22.4.tar.xz
0d72d2e9f5d6a3975068e1a472ce9982  qqc2-breeze-style-5.22.4.tar.xz
171c556167b17fd2b16783015c3f8ae6  ksystemstats-5.22.4.tar.xz</literal>
EOF</userinput></screen>

    <note>
      <para>
        Les paquets breeze-grub, breeze-plymouth et plymouth-kcm ci-dessus servent à
supporter la personnalisation de <ulink
url="https://www.freedesktop.org/wiki/Software/Plymouth/">Plymouth</ulink>
qui est conçu pour fonctionner dans un disque de ram initial pendant le
démarrage (voir <xref linkend="initramfs"/>). Le paquet plasma-sdk est
facultatif et utilisé pour le développement logiciel. Le paquet plasma-nano
est utilisé pour les systèmes embarqués et plasma-phone-components fournit
des fonctionnalités pour Plasma sur les téléphones.
      </para>
    </note>

  </sect2>

  <sect2 role="installation">
    <title>Installation de Plasma5</title>

    &as_root;

    <para>
      Commencez par démarrer un sous-shell qui sortira s'il y a une erreur&nbsp;:
    </para>

<screen><userinput>bash -e</userinput></screen>

    <para>
      Installez tous les paquets en lançant les commandes suivantes&nbsp;:
    </para>

<screen><!--
       # Fix some build issues when generating some configuration files
       case $name in
         plasma-workspace)
           sed -i '/set.HAVE_X11/a set(X11_FOUND 1)' CMakeLists.txt
         ;;
      
         khotkeys)
           sed -i '/X11Extras/a set(X11_FOUND 1)' CMakeLists.txt
         ;;
      
         plasma-desktop)
           sed -i '/X11.h)/i set(X11_FOUND 1)' CMakeLists.txt
         ;;
       esac
-->
<!-- some packages end up with files owned by root in $packagedir,
     so use as_root for removing -->
<userinput>while read -r line; do

    # Get the file name, ignoring comments and blank lines
    if $(echo $line | grep -E -q '^ *$|^#' ); then continue; fi
    file=$(echo $line | cut -d" " -f2)

    pkg=$(echo $file|sed 's|^.*/||')          # Remove directory
    packagedir=$(echo $pkg|sed 's|\.tar.*||') # Package directory

    tar -xf $file
    pushd $packagedir

       mkdir build
       cd    build

       cmake -DCMAKE_INSTALL_PREFIX=$KF5_PREFIX \
             -DCMAKE_BUILD_TYPE=Release         \
             -DBUILD_TESTING=OFF                \
             -Wno-dev ..  &amp;&amp;

        make
        as_root make install
    popd


    as_root rm -rf $packagedir
    as_root /sbin/ldconfig

done &lt; plasma-&plasma5-version;.md5

exit</userinput></screen>

    <para>
      Si vous n'avez pas configuré <envar>$KF5_PREFIX</envar> à
<filename>/usr</filename>, créez des liens symboliques pour permettre aux
gestionnaires d'affichage de trouver
<application>Plasma</application>&nbsp;:
    </para>

<screen><!--
cd $KF5_PREFIX/share/plasma/plasmoids

for j in $(find -name \*.js); do
  as_root ln -sfv ../code/$(basename $j) $(dirname $j)/../ui/
done-->
<userinput>as_root install -dvm 755 /usr/share/xsessions              &amp;&amp;
cd /usr/share/xsessions/                                   &amp;&amp;
[ -e plasma.desktop ]                                      ||
as_root ln -sfv $KF5_PREFIX/share/xsessions/plasma.desktop &amp;&amp;
as_root install -dvm 755 /usr/share/wayland-sessions       &amp;&amp;
cd /usr/share/wayland-sessions/                            &amp;&amp;
[ -e plasmawayland.desktop ]                               ||
as_root ln -sfv $KF5_PREFIX/share/wayland-sessions/plasmawayland.desktop</userinput></screen>

    <para revision="sysv">
      Des unités systemd inutiles ont été installées dans <filename
class="directory">$KF5_PREFIX/lib</filename>. Supprimez-les maintenant (en
tant que <systemitem class="username">root</systemitem>)&nbsp;:
    </para>

<screen role="root"
        revision="sysv"><userinput>rm -rf $KF5_PREFIX/lib/systemd</userinput></screen>

  </sect2>

  <!--
    <sect2 role="commands">

    <title>Command Explanations</title>

    <para>
      <command>ln -sfv ../code/$(basename $j) $(dirname $j)/../ui/</command>:
      Create symbolic links so qml files can find needed javascript modules.
    </para>

  </sect2>
-->
<sect2 role="configuration">
    <title>Configuration de Plasma</title>

    <sect3>
      <title>Configuration de Linux PAM</title>

      <para>
        Si vous avez construit Plasma avec le support recommandé de
<application>Linux PAM</application>, créez les fichiers de configuration
nécessaires en lançant les commandes suivantes en tant qu'utilisateur
<systemitem class="username">root</systemitem>&nbsp;:
      </para>

<screen role="root"><userinput>cat &gt; /etc/pam.d/kde &lt;&lt; "EOF" 
<literal># Begin /etc/pam.d/kde

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid &gt;= 1000 quiet
auth     include        system-auth

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde</literal>
EOF

cat &gt; /etc/pam.d/kde-np &lt;&lt; "EOF" 
<literal># Begin /etc/pam.d/kde-np

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid &gt;= 1000 quiet
auth     required       pam_permit.so

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde-np</literal>
EOF

cat &gt; /etc/pam.d/kscreensaver &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kscreensaver

auth    include system-auth
account include system-account

# End /etc/pam.d/kscreensaver</literal>
EOF</userinput></screen>
    </sect3>
  </sect2>

  <sect2 role="starting">
    <title>Démarrage de Plasma5</title>

    <para revision="sysv">
      Vous pouvez démarrer <application>Plasma5</application> depuis le niveau
d'exécution 3, en utilisant <xref linkend="xinit"/>, ou depuis le niveau
d'exécution 5, en utilisant un gestionnaire d'affichage, comme <xref
linkend="lightdm"/>.
    </para>

    <para revision="systemd">
      <!--, or from a graphical display manager, such as
      <xref linkend="sddm"/>
-->
Vous pouvez démarrer <application>Plasma5</application> depuis un TTY avec
<xref linkend="xinit"/>.
    </para>

    <para>
      Pour démarrer <application>Plasma5</application> en utilisant <xref
linkend="xinit"/>, lancez les commandes suivantes&nbsp;:
    </para>

<screen><userinput>cat &gt; ~/.xinitrc &lt;&lt; "EOF"
<literal>dbus-launch --exit-with-session $KF5_PREFIX/bin/startplasma-x11</literal>
EOF

startx</userinput></screen>

    <para>
      La session X démarre dans le premier terminal virtuel inutilisé, normalement
vt7. Vous pouvez passer à un autre vt<emphasis>n</emphasis> en appuyant
simultanément sur les touches Ctrl-Alt-F<emphasis>n</emphasis>
(<emphasis>n</emphasis>=1, 2, ...). Pour aller sur la session X, normalement
démarrée sur vt7, utilisez Ctrl-Alt-F7. Le vt où la commande
<command>startx</command> est exécuté affichera beaucoup de messages,
incluant les messages de démarrage de X, les applications automatiquement
démarrées avec la session, et éventuellement, quelques avertissements et
messages d'erreur. Vous pouvez préférer rediriger ces messages dans un
fichier de log, qui non seulement laissera le vt initial propre, mais pourra
aussi être utilisé pour des questions de débogage. Cela peut être fait en
démarrant X avec&nbsp;:
    </para>

    <screen><userinput>startx &amp;&gt; ~/x-session-errors</userinput></screen>

    <para>
      Au redémarrage ou à l'arrêt, les messages d'arrêt apparaissent sur le vt où
X était lancé. Si vous voulez voir ces messages, appuyez simultanément sur
Alt-F7 (en considérant que X était lancé sur vt7).
    </para>


  <!-- Now the entry is "plasma (X11)" for Xorg, so I guess this is
     not needed anymore:
    <para>

      If you intend to start <application>Plasma</application> using a
    display manager such as <xref linkend="lightdm"/>, there will be two entries
    for <application>Plasma</application>, one for use with
    <application>Xorg</application>, and another for
    <application>Wayland</application>. Modify the
    <application>Xorg</application> entry with the following command, as the
    <systemitem class="username">root</systemitem> user, so that you can
    differentiate between the two:</para>

<screen role="root"><userinput>sed '/^Name=/s/Plasma/Plasma on Xorg/' -i /usr/share/xsessions/plasma.desktop</userinput></screen>
-->
</sect2>

  <sect2 role="content">
    <title>Contenu</title>

    <segmentedlist>
      <segtitle>Programmes installés</segtitle>
      <segtitle>Bibliothèques installées</segtitle>
      <segtitle>Répertoires installés</segtitle>

      <seglistitem>
        <seg>
           Il y a trop de programmes plasma (63 dans /opt/kf5/bin) pour les lister
séparément ici.
        </seg>
        <seg>
           Il y a trop de bibliothèques plasma (40 dans /opt/kf5/lib) pour les lister
séparément ici.
        </seg>
        <seg>
           Il y a trop de répertoires plasma (plus de 1000 dans /opt/kf5) pour les
lister séparément ici.
        </seg>
      </seglistitem>
    </segmentedlist>

  </sect2>

</sect1>
