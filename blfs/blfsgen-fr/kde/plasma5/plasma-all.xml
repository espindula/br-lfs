<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
 <!ENTITY % general-entities SYSTEM "../../general.ent">
 %general-entities;

  <!ENTITY plasma5-download-http "https://download.kde.org/stable/plasma/&plasma5-version;">
  <!ENTITY plasma5-download-ftp  "">
  <!ENTITY plasma5-md5sum        "Voir ci-dessous">
  <!ENTITY plasma5-size          "154&nbsp;Mo">
  <!ENTITY plasma5-buildsize     "1,5&nbsp;Go (370&nbsp;Mo installés)">
  <!ENTITY plasma5-time          "17&nbsp;SBU (avec parallélisme = 4)">
]>

<sect1 id="plasma5-build" xreflabel="Plasma-&plasma5-version;">
  <?dbhtml filename="plasma-all.html"?>

  <sect1info>
<date>$Date$</date></sect1info>

  <title>Construction de Plasma 5</title>

  <indexterm zone="plasma5-build">
     <primary sortas="a-kde-plasma">KDE Plasma 5</primary>
  </indexterm>

  <para>
    KDE Plasma 5 est une collection de paquets basés sur KDE Frameworks 5 et
QML. Ils implémentent l'environnement d'affichage KDE (Plasma 5).
  </para>

  &lfs112_checked;

  <para>
    Les instructions suivantes construisent tous les paquets Plasma 5 en une
étape en utilisant un script bash.
  </para>

  <bridgehead renderas="sect3">Informations sur le paquet</bridgehead>
  <itemizedlist spacing="compact">
    <listitem>
      <para>
        Téléchargement (HTTP)&nbsp;: <ulink url="&plasma5-download-http;"/>
      </para>
    </listitem>
    <listitem>
      <para>
        Téléchargement (FTP)&nbsp;: <ulink url="&plasma5-download-ftp;"/>
      </para>
    </listitem>
    <listitem>
      <para>
        Somme de contrôle MD5&nbsp;: &plasma5-md5sum;
      </para>
    </listitem>
    <listitem>
      <para>
        Taille du téléchargement&nbsp;: &plasma5-size;
      </para>
    </listitem>
    <listitem>
      <para>
        Estimation de l'espace disque requis&nbsp;: &plasma5-buildsize;
      </para>
    </listitem>
    <listitem>
      <para>
        Estimation du temps de construction&nbsp;: &plasma5-time;
      </para>
    </listitem>
  </itemizedlist>

  <bridgehead renderas="sect3">Dépendances de Plasma 5</bridgehead>

  <bridgehead renderas="sect4">Requises</bridgehead>
  <para role="required">
    
    
    <!--<xref linkend="fontforge"/>
,-->
<!-- does not seem to be needed as of 5.22.4 <xref linkend="GConf"/>
, -->
<xref linkend="gtk2"/>, <xref linkend="gtk3"/>, <xref
linkend="kf5-frameworks"/>, <xref linkend="libpwquality"/>, <xref
linkend="libqalculate"/>, <xref linkend="libxkbcommon"/>, <xref
linkend="mesa"/> construit avec <xref linkend="wayland"/>, <xref
linkend="NetworkManager"/>, <xref linkend="pipewire"/>, <xref
linkend="pulseaudio"/>, <xref linkend="qca"/>, <xref linkend="sassc"/>,
<xref linkend="taglib"/> et <xref linkend="xcb-util-cursor"/>
  </para>

  <bridgehead renderas="sect4">Recommandées</bridgehead>
  <para role="recommended">
    <xref linkend="fftw"/>, <xref linkend="gsettings-desktop-schemas"/>, <xref
linkend="libdbusmenu-qt"/>, <xref linkend="libcanberra"/>, <xref
linkend="libinput"/>, <xref linkend="libpcap"/>, <xref
linkend="linux-pam"/>, <xref linkend="lm_sensors"/>, <xref
linkend="oxygen-icons5"/> et <xref linkend="pciutils"/>
  </para>

  <bridgehead renderas="sect4">Recommandées (à l'exécution)</bridgehead>
  <para role="recommended">
    <xref role="runtime" linkend="accountsservice"/>, <xref role="runtime"
linkend="smartmontools"/> et <xref role="runtime" linkend="xwayland"/>
  </para>

  <bridgehead renderas="sect4">Facultatives</bridgehead>
  <para role="optional">
    <xref linkend="glu"/>, <xref linkend='ibus'/>, <xref
linkend='qtwebengine'/>, <xref linkend="xorg-synaptics-driver"/>, <ulink
url="http://distributions.freedesktop.org/wiki/AppStream">appstream-qt</ulink>,
<ulink url="https://www.kdevelop.org/">KDevPlatform</ulink>, <ulink
url="https://gpsd.gitlab.io/gpsd/">libgps</ulink>, <ulink
url="https://github.com/libhybris/libhybris">libhybris</ulink>, <ulink
url="https://sourceforge.net/projects/libraw1394/">libraw1394</ulink>,
<ulink url="https://bitbucket.org/godsme/mockcpp">mockcpp</ulink>, <ulink
url="https://www.freedesktop.org/software/PackageKit/releases/">packagekit-qt</ulink>,
<ulink url="http://qalculate.github.io/">Qalculate</ulink>, <ulink
url="https://launchpad.net/qapt">Qapt</ulink>, <ulink
url="https://github.com/osiam/osiam">SCIM</ulink> et <ulink
url="http://www.dest-unreach.org/socat/">socat</ulink> (pour pam_kwallet)
  </para>

  <note>
    <para>
      Seuls deux paquets de plasma utilisent éventuellement <xref
linkend="qtwebengine"/>&nbsp;: libksysguard et kdeplasma-addons. Si
QtWebEngine est installé plus tard, seuls ces deux paquets doivent être
reconstruits. Cela permet de fournir un affichage plus complet dans
l'application de surveillance du système.
    </para>
  </note>

  <para condition="html" role="usernotes">Notes utilisateur&nbsp;: <ulink url="&blfs-wiki;/kf5"/></para>

  <sect2>
    <title>Téléchargement de KDE Plasma5</title>

    <para>
      La meilleure façon d'avoir les paquets de KDE Plasma5 est d'utiliser un seul
<command>wget</command> pour les avoir tous en même temps&nbsp;:
    </para>

<screen><userinput>url=https://download.kde.org/stable/plasma/&plasma5-version;/
wget -r -nH -nd -A '*.xz' -np $url</userinput>
<literal>
Les options utilisée ici sont :
  -r            récupère les répertoires enfants
  -nH           désactive la génération de répertoires commençant pour le nom d'hôte
  -nd           ne crée pas de hiérarchie de répertoires
  -A '*.xz'     récupère uniquement les fichiers *.xz
  -np           ne récupère pas les répertoires parents</literal></screen>

   </sect2>

  <sect2>
    <title>Initialisation de l'ordre des paquets</title>

    <para>
      L'ordre de construction des fichiers est important à cause des dépendances
internes. Créez la liste des fichiers dans le bon ordre comme suit&nbsp;:
    </para>

<screen><userinput>cat &gt; plasma-&plasma5-version;.md5 &lt;&lt; "EOF"
<literal>cc886e068156be2e3a38dd581ef5c7cd  kdecoration-5.25.4.tar.xz
dc335301006b1007714dc2af028856ef  libkscreen-5.25.4.tar.xz
38101d3a8fee3a6eef04370e29da3538  libksysguard-5.25.4.tar.xz
99b6204e0e782232de0caae00d8b08f9  breeze-5.25.4.tar.xz
9cff677a443097f0cd6ff997d75cd8d3  breeze-gtk-5.25.4.tar.xz
63f91c68af6cf236931455e3f2f7db8d  layer-shell-qt-5.25.4.tar.xz
f0390e8aa342f3b6f78383ffbd8e6245  kscreenlocker-5.25.4.tar.xz
173c0ff83e4677bd3d493882616f4821  oxygen-5.25.4.tar.xz
0eba490f93429cbae3274f5c80e8e4a4  kinfocenter-5.25.4.tar.xz
8c07df3083286b7fbf2fee061a9b8556  kwin-5.25.4.tar.xz
4322408dc35f32cfa25cde675ca4f950  plasma-workspace-5.25.4.tar.xz
847f15762403af3355dd9f8d313e3160  plasma-disks-5.25.4.tar.xz
a6c95ad969503a0c4f7fa61b457405c1  bluedevil-5.25.4.tar.xz
6b6cf6c6faa28d7593e3065befe8cf8d  kde-gtk-config-5.25.4.tar.xz
943b40a2a7e3738618ddb070233fe6f4  khotkeys-5.25.4.tar.xz
09c80647ed861aa94672fcb5d13fe382  kmenuedit-5.25.4.tar.xz
8671c090d885302d9553cecee3b87d65  kscreen-5.25.4.tar.xz
f0df854ad5288a369c3d38a393ad796c  kwallet-pam-5.25.4.tar.xz
b686e387222177d70f14652d03225fd9  kwayland-integration-5.25.4.tar.xz
7ad4e4512e2c03e351930e83dd2d5c9b  kwrited-5.25.4.tar.xz
7db4206e533f247b878241158f946552  milou-5.25.4.tar.xz
3e7cab69babe28ccafb1eb0df0c18757  plasma-nm-5.25.4.tar.xz
9813c33efcc84eb15d792aad2c096127  plasma-pa-5.25.4.tar.xz
54f0171cb296021b80437d2b5c5821e5  plasma-workspace-wallpapers-5.25.4.tar.xz
b29230b6615e1d4318e37d92940dd35b  polkit-kde-agent-1-5.25.4.tar.xz
207ef7369a9dbe242bb4be12856c9950  powerdevil-5.25.4.tar.xz
58f128569154007f74dd74b8fb1ce976  plasma-desktop-5.25.4.tar.xz
2218d15c9644268c8a001993ac2b75a3  kdeplasma-addons-5.25.4.tar.xz
78407d2ec45a8efbd94be4be4e458ec6  kgamma5-5.25.4.tar.xz
12f157a44265e888238e44567c49ffdd  ksshaskpass-5.25.4.tar.xz
#8f34f405bd2e81866f484c8fb2b3e4bf  plasma-sdk-5.25.4.tar.xz
5cf6a96fac52af822c28a5b414dfb05e  sddm-kcm-5.25.4.tar.xz
e5d1e81e741fcb94c6d3b7f0a460f0f2  discover-5.25.4.tar.xz
#7317d218fb9bcbd3bb52dcc2d0b45497  breeze-grub-5.25.4.tar.xz
#891882622ea5f8fc9e42aec7c349708a  breeze-plymouth-5.25.4.tar.xz
f8c1e906f17ce513113af47dadbf0222  kactivitymanagerd-5.25.4.tar.xz
4cbd66be9bfac48ff222c787652a0e1f  plasma-integration-5.25.4.tar.xz
ae0cc94583a0b6bd977a15b0ffba57d2  plasma-tests-5.25.4.tar.xz
#43096cf164e17176cc381d804823bac2  plymouth-kcm-5.25.4.tar.xz
53d0980ca27e7233ca24bae9eceb4e57  xdg-desktop-portal-kde-5.25.4.tar.xz
23b19b8d694ec98bc3e049cd628e8413  drkonqi-5.25.4.tar.xz
5a466c0da69b52836ddbf5524ddb14b9  plasma-vault-5.25.4.tar.xz
71c02fb4b8f3953a8548978b6309f7c8  plasma-browser-integration-5.25.4.tar.xz
5e0063ee3e50a7a336d80d17ed3c6651  kde-cli-tools-5.25.4.tar.xz
d0dcc4214861fc05328d5df46fe618f5  systemsettings-5.25.4.tar.xz
3a786aae80fa31643ace5b3c62e70254  plasma-thunderbolt-5.25.4.tar.xz
#74e38cc52ac71d74f0bce96ac6c2e288  plasma-nano-5.25.4.tar.xz
#86db281d990e794a0890b9b7933995fa  plasma-mobile-5.25.4.tar.xz
e08c0ad74f68666713c5891f73b6432b  plasma-firewall-5.25.4.tar.xz
030f1d0236b31407745300858f4f6db5  plasma-systemmonitor-5.25.4.tar.xz
005283e828b3ed1d1a9006dea23fd647  qqc2-breeze-style-5.25.4.tar.xz
5a8ef1866697cf5a660a59213d2f38e7  ksystemstats-5.25.4.tar.xz
ab1fd9c2a595b09925fc2f9ddfe18406  oxygen-sounds-5.25.4.tar.xz</literal>
EOF</userinput></screen>

    <note>
      <para>
        Les paquets breeze-grub, breeze-plymouth et plymouth-kcm ci-dessus servent à
supporter la personnalisation de <ulink
url="https://www.freedesktop.org/wiki/Software/Plymouth/">Plymouth</ulink>
qui est conçu pour fonctionner dans un disque de ram initial pendant le
démarrage (voir <xref linkend="initramfs"/>). Le paquet plasma-sdk est
facultatif et utilisé pour le développement logiciel. Le paquet plasma-nano
est utilisé pour les systèmes embarqués et plasma-phone-components fournit
des fonctionnalités pour Plasma sur les téléphones.
      </para>
    </note>

  </sect2>

  <sect2 role="installation">
    <title>Installation de Plasma5</title>

    &as_root;

    <para>
      Commencez par démarrer un sous-shell qui sortira s'il y a une erreur&nbsp;:
    </para>

<screen><userinput>bash -e</userinput></screen>

    <para>
      Installez tous les paquets en exécutant les commandes suivantes&nbsp;:
    </para>

<screen><!--
       # Fix some build issues when generating some configuration files
       case $name in
         plasma-workspace)
           sed -i '/set.HAVE_X11/a set(X11_FOUND 1)' CMakeLists.txt
         ;;

         khotkeys)
           sed -i '/X11Extras/a set(X11_FOUND 1)' CMakeLists.txt
         ;;

         plasma-desktop)
           sed -i '/X11.h)/i set(X11_FOUND 1)' CMakeLists.txt
         ;;
       esac
-->
<!-- some packages end up with files owned by root in $packagedir,
     so use as_root for removing -->
<userinput>while read -r line; do

    # Get the file name, ignoring comments and blank lines
    if $(echo $line | grep -E -q '^ *$|^#' ); then continue; fi
    file=$(echo $line | cut -d" " -f2)

    pkg=$(echo $file|sed 's|^.*/||')          # Remove directory
    packagedir=$(echo $pkg|sed 's|\.tar.*||') # Package directory

    tar -xf $file
    pushd $packagedir

       mkdir build
       cd    build

       cmake -DCMAKE_INSTALL_PREFIX=$KF5_PREFIX \
             -DCMAKE_BUILD_TYPE=Release         \
             -DBUILD_TESTING=OFF                \
             -Wno-dev ..  &amp;&amp;

        make
        as_root make install
    popd


    as_root rm -rf $packagedir
    as_root /sbin/ldconfig

done &lt; plasma-&plasma5-version;.md5

exit</userinput></screen>

    <para>
      Si vous n'avez pas configuré <envar>$KF5_PREFIX</envar> à
<filename>/usr</filename>, créez des liens symboliques pour permettre aux
gestionnaires d'affichage de trouver
<application>Plasma</application>&nbsp;:
    </para>

<screen><!--
cd $KF5_PREFIX/share/plasma/plasmoids

for j in $(find -name \*.js); do
  as_root ln -sfv ../code/$(basename $j) $(dirname $j)/../ui/
done-->
<userinput>as_root install -dvm 755 /usr/share/xsessions              &amp;&amp;
cd /usr/share/xsessions/                                   &amp;&amp;
[ -e plasma.desktop ]                                      ||
as_root ln -sfv $KF5_PREFIX/share/xsessions/plasma.desktop &amp;&amp;
as_root install -dvm 755 /usr/share/wayland-sessions       &amp;&amp;
cd /usr/share/wayland-sessions/                            &amp;&amp;
[ -e plasmawayland.desktop ]                               ||
as_root ln -sfv $KF5_PREFIX/share/wayland-sessions/plasmawayland.desktop</userinput></screen>

    <para revision="sysv">
      Des unités systemd inutiles ont été installées dans <filename
class="directory">$KF5_PREFIX/lib</filename>. Supprimez-les maintenant (en
tant que <systemitem class="username">root</systemitem>)&nbsp;:
    </para>

<screen role="root"
        revision="sysv"><userinput>rm -rf $KF5_PREFIX/lib/systemd</userinput></screen>

  </sect2>

  <!--
    <sect2 role="commands">

    <title>Command Explanations</title>

    <para>
      <command>ln -sfv ../code/$(basename $j) $(dirname $j)/../ui/</command>:
      Create symbolic links so qml files can find needed javascript modules.
    </para>

  </sect2>
-->
<sect2 role="configuration">
    <title>Configuration de Plasma</title>

    <sect3>
      <title>Configuration de Linux PAM</title>

      <para>
        Si vous avez construit Plasma avec le support recommandé de
<application>Linux PAM</application>, créez les fichiers de configuration
nécessaires en exécutant les commandes suivantes en tant qu'utilisateur
<systemitem class="username">root</systemitem>&nbsp;:
      </para>

<screen role="root"><userinput>cat &gt; /etc/pam.d/kde &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kde

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid &gt;= 1000 quiet
auth     include        system-auth

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde</literal>
EOF

cat &gt; /etc/pam.d/kde-np &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kde-np

auth     requisite      pam_nologin.so
auth     required       pam_env.so

auth     required       pam_succeed_if.so uid &gt;= 1000 quiet
auth     required       pam_permit.so

account  include        system-account
password include        system-password
session  include        system-session

# End /etc/pam.d/kde-np</literal>
EOF

cat &gt; /etc/pam.d/kscreensaver &lt;&lt; "EOF"
<literal># Begin /etc/pam.d/kscreensaver

auth    include system-auth
account include system-account

# End /etc/pam.d/kscreensaver</literal>
EOF</userinput></screen>
    </sect3>
  </sect2>

  <sect2 role="starting">
    <title>Démarrage de Plasma5</title>

    <para revision="sysv">
      Vous pouvez démarrer <application>Plasma5</application> depuis le niveau
d'exécution 3, en utilisant <xref linkend="xinit"/>, ou depuis le niveau
d'exécution 5, en utilisant un gestionnaire d'affichage, tel que <xref
linkend="lightdm"/>.
    </para>

    <para revision="systemd">
      <!--, or from a graphical display manager, such as
      <xref linkend="sddm"/>
-->
Vous pouvez démarrer <application>Plasma5</application> depuis un TTY avec
<xref linkend="xinit"/>.
    </para>

    <para>
      Pour démarrer <application>Plasma5</application> en utilisant <xref
linkend="xinit"/>, lancez les commandes suivantes&nbsp;:
    </para>

<screen><userinput>cat &gt; ~/.xinitrc &lt;&lt; "EOF"
<literal>dbus-launch --exit-with-session $KF5_PREFIX/bin/startplasma-x11</literal>
EOF

startx</userinput></screen>

    <para>
      La session X démarre dans le premier terminal virtuel inutilisé, normalement
vt7. Vous pouvez passer à un autre vt<emphasis>n</emphasis> en appuyant
simultanément sur les touches Ctrl-Alt-F<emphasis>n</emphasis>
(<emphasis>n</emphasis>=1, 2, ...). Pour aller sur la session X, normalement
démarrée sur vt7, utilisez Ctrl-Alt-F7. Le vt où la commande
<command>startx</command> est exécuté affichera beaucoup de messages,
incluant les messages de démarrage de X, les applications automatiquement
démarrées avec la session et, éventuellement, quelques avertissements et
messages d'erreur. Vous pouvez préférer rediriger ces messages dans un
fichier de log, qui non seulement laissera le vt initial propre, mais qui
pourra aussi être utilisé pour des questions de débogage. Cela peut être
fait en démarrant X avec&nbsp;:
    </para>

    <screen><userinput>startx &amp;&gt; ~/x-session-errors</userinput></screen>

    <para>
      Au redémarrage ou à l'arrêt, les messages d'arrêt apparaissent sur le vt où
X était lancé. Si vous voulez voir ces messages, appuyez simultanément sur
Alt-F7 (en considérant que X était lancé sur vt7).
    </para>


  <!-- Now the entry is "plasma (X11)" for Xorg, so I guess this is
     not needed anymore:
    <para>

      If you intend to start <application>Plasma</application> using a
    display manager such as <xref linkend="lightdm"/>, there will be two entries
    for <application>Plasma</application>, one for use with
    <application>Xorg</application>, and another for
    <application>Wayland</application>. Modify the
    <application>Xorg</application> entry with the following command, as the
    <systemitem class="username">root</systemitem> user, so that you can
    differentiate between the two:</para>

<screen role="root"><userinput>sed '/^Name=/s/Plasma/Plasma on Xorg/' -i /usr/share/xsessions/plasma.desktop</userinput></screen>
-->
</sect2>

  <sect2 role="content">
    <title>Contenu</title>

    <segmentedlist>
      <segtitle>Programmes installés</segtitle>
      <segtitle>Bibliothèques installées</segtitle>
      <segtitle>Répertoires installés</segtitle>

      <seglistitem>
        <seg>
           Il y a trop de programmes plasma (63 dans /opt/kf5/bin) pour les lister
séparément ici.
        </seg>
        <seg>
           Il y a trop de bibliothèques plasma (40 dans /opt/kf5/lib) pour les lister
séparément ici.
        </seg>
        <seg>
           Il y a trop de répertoires plasma (plus de 1000 dans /opt/kf5) pour les
lister séparément ici.
        </seg>
      </seglistitem>
    </segmentedlist>

  </sect2>

</sect1>
