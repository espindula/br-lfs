<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../../general.ent">
  %general-entities;
]>
<sect1 id="svnserver" xreflabel="Exécuter un serveur subversion">
  <?dbhtml filename="svnserver.html"?>
  <sect1info>
  <othername>$LastChangedBy: bdubbs $</othername>
  <date>$Date: 2011-11-16 05:12:05 +0100 (mer. 16 nov. 2011) $</date>
  </sect1info>
  <title>Exécuter un serveur subversion</title>
  <sect2 role="package">
    <title>Exécuter un serveur subversion</title>
    <para>Cette section décrira la façon de paramétrer, administrer et sécuriser
    un serveur <application>Subversion</application>.</para>
    <bridgehead renderas="sect3">Dépendances du serveur Subversion</bridgehead>
    <bridgehead renderas="sect4">Requises</bridgehead>
    <para><xref linkend="subversion"/> et
    <xref linkend="openssh"/></para>
  </sect2>
  <sect2 role="configuration">
    <title>Paramétrage d'un serveur Subversion.</title>
    <para>Les instructions suivantes installeront un serveur
    <application>Subversion</application>, qui sera paramétré pour utiliser
    <application>OpenSSH</application> comme méthode sécurisée à distance, avec
    <command>svnserve</command> disponible pour un accès anonyme.</para>
    <para>La configuration du serveur <application>Subversion</application>
    consiste dans les étapes suivantes&nbsp;:</para>
    <sect3>
      <title>1. Régler l'utilisateur, le groupe et les droits</title>
      <para>Vous devrez être l'utilisateur
      <systemitem class='username'>root</systemitem> pour la partie initiale
      de la configuration. Créez l'utilisateur et groupe
      <systemitem class="username">svn</systemitem> avec les commandes suivantes&nbsp;:</para>
<screen role="root">
<userinput>groupadd -g 56 svn &amp;&amp;
useradd -c "SVN Owner" -d /home/svn -m -g svn -s /bin/false -u 56 svn</userinput>
</screen>
      <para>Si vous envisagez d'avoir plusieurs dépôts, vous devriez avoir un
      groupe décjé à chaque dépôt pour faciliter l'administration. Créez
      le groupe <systemitem class="groupname">svntest</systemitem> pour le
      dépôt de test  et ajoutez l'utilisateur <systemitem class="username">svn</systemitem>
      au groupe avec les commandes suivantes&nbsp;:</para>
<screen role="root">
<userinput>groupadd -g 57 svntest &amp;&amp;
usermod -G svntest -a svn</userinput>
</screen>
      <para>En outre, vous devriez régler <command>umask 002</command> pendant
      que vous travaillez avec un dépôt pour que tous les nouveaux fichiers
      soient accessibles en écriture au propriétaire et au groupe. Ceci est
      rendu obligatoire par la création d'un script enveloppe pour
      <command>svn</command> et <command>svnserve</command>&nbsp;:</para>
<screen role="root">
<userinput>mv /usr/bin/svn /usr/bin/svn.orig &amp;&amp;
mv /usr/bin/svnserve /usr/bin/svnserve.orig &amp;&amp;
cat &gt;&gt; /usr/bin/svn &lt;&lt; "EOF"
<literal>#!/bin/sh
umask 002
/usr/bin/svn.orig "$@"</literal>
EOF
cat &gt;&gt; /usr/bin/svnserve &lt;&lt; "EOF"
<literal>#!/bin/sh
umask 002
/usr/bin/svnserve.orig "$@"</literal>
EOF
chmod 0755 /usr/bin/svn{,serve}</userinput>
</screen>
      <note>
        <para>Si vous utilisez <application>Apache</application> pour
        travailler avec le dépôt par HTTP, même pour un accès anonyme, vous devriez
        envelopper <command>/usr/sbin/httpd</command> dans un script similaire.</para>
      </note>
    </sect3>
    <sect3>
      <title>2. Créer un dépôt Subversion.</title>
      <para>Avec subversion-1.1.0 et supérieur, un nouveau type de dépôt de
      stockage de données est disponible, FSFS. Il y a  un échange pour plus
      de vitesse avec la nouvelle fondation, cependant on peut mettre maintenant
      le dépôt sur un montage réseau, et toute corruption n'a pas besoin d'admin
      pour récupérer le dépôt. Pour plus d'informations et par comparaison avec
      FSFS et BDB, voir <ulink
      url="http://svnbook.red-bean.com/svnbook-1.1/ch05.html#svn-ch-5-sect-1.2.A"/>.
      </para>
      <para>Créez un nouveau dépôt <application>Subversion</application> avec
      les commandes suivantes&nbsp;:</para>
<screen role="root">
<userinput>install -v -m 0755 -d /srv/svn &amp;&amp;
install -v -m 0755 -o svn -g svn -d /srv/svn/repositories &amp;&amp;
svnadmin create --fs-type fsfs /srv/svn/repositories/svntest</userinput>
</screen>
      <para>Maintenant que le dépôt est créé, vous devriez le peupler avec quelque
      chose d'utile. Vous devrez avoir une présentation de répertoire prédéfinie
      paramétrée ressemblant exactement à ce à quoi vous voudriez que votre dépôt
      ressemble. Par exemple, voici un modèle du paramétrage de BLFS avec
      une racine de
      <filename>svntest/</filename>. Vous devrez paramétrer une arborescence de
      répertoire ressemblant à ce qui suit&nbsp;:</para>
<screen>
<literal>svntest/            # The name of the repository
   trunk/           # Contains the existing source tree
      BOOK/
      bootscripts/
      edguide/
      patches/
      scripts/
   branches/        # Needed for additional branches
   tags/            # Needed for tagging release points</literal>
</screen>
      <para>Une fois que vous avez créé votre aménagement de répertoire, comme
      indiqué ci-dessus, vous êtes prêt à faire l'importation initiale&nbsp;:</para>
<screen role="root">
<userinput>svn import -m "Initial import." \
    <replaceable>&lt;/path/to/source/tree&gt;</replaceable>      \
    file:///srv/svn/repositories/svntest</userinput>
</screen>
      <para>Maintenant modifiez les informations de propriétaire et de groupe
      du dépôt et ajoutez un utilisateur non privilégié aux groupes
      <systemitem class="groupname">svn</systemitem> et
      <systemitem class="groupname">svntest</systemitem>&nbsp;:</para>
<screen role="root">
<userinput>chown -R svn:svntest /srv/svn/repositories/svntest    &amp;&amp;
chmod -R g+w         /srv/svn/repositories/svntest    &amp;&amp;
chmod g+s            /srv/svn/repositories/svntest/db &amp;&amp;
usermod -G svn,svntest -a <replaceable>&lt;username&gt;</replaceable></userinput>
</screen>
      <para><systemitem class="groupname">svntest</systemitem> est le groupe
      affecté au dépôt svntest. Comme indiqué plus haut, cela facilite
      l'administration de plusieurs dépôts lors de l'utilisation de
      <application>OpenSSH</application> pour l'authentication. En
      anticipant, vous devrez ajouter votre utilisateur non privilégié
      et n'importe quel utilisateur supplémentaire auquel vous pouvez vouloir
      donner accès en écriture au dépôt, aux groupes
      <systemitem class="groupname">svn</systemitem> et
      <systemitem class="groupname">svntest</systemitem>.</para>
      <para>En outre, vous remarquerez que le nouveau répertoire du dépôt
      <filename>db</filename> est set-groupID. Si le raisonnement n'est pas
      immédiatement évident, quand on utilise une méthode d'authentication
      externe (telle que <command>ssh</command>), le bit sticky est réglé
      de sorte que tout les nouveaux fichiers appartiendront à l'utilisateur,
      mais au groupe <systemitem class="groupname">svntest</systemitem>. Quiconque
      dans le groupe <systemitem class="groupname">svntest</systemitem> peut
      créer des fichiers, mais donnez encore l'accès en écriture à tout le groupe
      à ces fichiers. Ceci évite d'exclure d'autres utilisateurs du
      dépôt.</para>
      <para>Maintenant, repassez en accès pour utilisateur non privilégié, et
      jetez un &oelig;il sur le nouveau dépôt en utilisant <command>svnlook</command>&nbsp;:</para>
<screen>
<userinput>svnlook tree /srv/svn/repositories/svntest/</userinput>
</screen>
      <note>
        <para>Il se peut que vous deviez vous déconnecter et y revenir pour
        rafraîchir vos appartenances au groupe. '<command>su <replaceable>&lt;nom_utilisateur&gt;</replaceable></command>'
        devrait aussi fonctionner.</para>
      </note>
    </sect3>
    <sect3>
      <title>3. Configurer le Serveur</title>
      <para>Comme indiqué précédemment, ces instructions configureront le
      serveur pour n'utiliser que <command>ssh</command> pour un accès en
      écriture au dépôt et pour fournir un accès anonyme en utilisant
      <command>svnserve</command>. Il y a plusieurs autres manières de fournir
      un accès au dépôt. Ces configurations supplémentaires sont mieux
      expliquées sur <ulink url="http://svnbook.red-bean.com/"/>.</para>
      <para>La configuration de l'accès doit se faire pour chaque dépôt. Créez le
      fichier <filename>svnserve.conf</filename> pour le dépôt svntest en
      utilisant les commandes suivantes&nbsp;:</para>
<screen role="root">
<userinput>cp /srv/svn/repositories/svntest/conf/svnserve.conf \
   /srv/svn/repositories/svntest/conf/svnserve.conf.default &amp;&amp;
cat &gt; /srv/svn/repositories/svntest/conf/svnserve.conf &lt;&lt; "EOF"
<literal>[general]
anon-access = read
auth-access = write</literal>
EOF</userinput>
</screen>
      <para>Il n'y a pas grand à chose du tout avoir avec le fichier de
      configuration. Vous remarquerez que seule la section générale est est
      nécessaire. Jetez un &oelig;il sur le fichier
      <filename>svnserve.conf.default</filename> pour des informations sur
      l'utilisation de la méthode d'authentication de <command>svnserve</command>
      intégrée.</para>
    </sect3>
    <sect3 id="svnserver-init">
      <title>4. Démarrage du Serveur</title>
      <para>Pour démarrer le serveur au démarrage, installez le script de
         démarrage svn inclus dans le paquet
      <xref linkend="bootscripts"/>.</para>
      <indexterm zone="svnserver svnserver-init">
        <primary sortas="f-svn">svn</primary>
      </indexterm>
<screen role="root">
<userinput>make install-svn</userinput>
</screen>
    </sect3>
  </sect2>
</sect1>
